"use strict";(self.webpackChunkosmosis_docs=self.webpackChunkosmosis_docs||[]).push([[6600],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(a),h=o,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||i;return a?n.createElement(m,r(r({ref:t},p),{},{components:a})):n.createElement(m,r({ref:t},p))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var c=2;c<i;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},47703:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=a(87462),o=(a(67294),a(3905));const i={sidebar_position:4},r="Fee Abstraction",s={unversionedId:"features/fee-abstraction",id:"features/fee-abstraction",title:"Fee Abstraction",description:"Context",source:"@site/docs/overview/features/fee-abstraction.md",sourceDirName:"features",slug:"/features/fee-abstraction",permalink:"/overview/features/fee-abstraction",draft:!1,editUrl:"https://github.com/osmosis-labs/docs/tree/main/docs/overview/features/fee-abstraction.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"EIP-1559",permalink:"/overview/features/eip-1559"},next:{title:"IBC Hooks",permalink:"/overview/features/ibc-hooks"}},l={},c=[{value:"Context",id:"context",level:2},{value:"Description",id:"description",level:2},{value:"Prototype",id:"prototype",level:2},{value:"Pulling <code>twap data</code> and update exchange rate",id:"pulling-twap-data-and-update-exchange-rate",level:4},{value:"Handling txs with ibc-token fee",id:"handling-txs-with-ibc-token-fee",level:4},{value:"Swap accumulated ibc-tokens fee",id:"swap-accumulated-ibc-tokens-fee",level:4},{value:"How XCS work",id:"how-xcs-work",level:5},{value:"Reverse With Path-unwinding to get Ibc-token on Osmosis",id:"reverse-with-path-unwinding-to-get-ibc-token-on-osmosis",level:6},{value:"Swap Ibc-token",id:"swap-ibc-token",level:6},{value:"Swap Ibc-token",id:"swap-ibc-token-1",level:6},{value:"Repository",id:"repository",level:2}],p={toc:c};function u(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"fee-abstraction"},"Fee Abstraction"),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("p",null,"The concrete use cases which motivated this module include:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The desire to use IBC token as transaction fees on any chain instead of having to use native token as fee."),(0,o.kt)("li",{parentName:"ul"},"To fully take advantage of the newly represented Osmosis ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/osmosis-labs/osmosis/tree/main/cosmwasm/contracts"},(0,o.kt)("inlineCode",{parentName:"a"},"swap router"))," with the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/osmosis-labs/osmosis/tree/main/x/ibc-hooks"},(0,o.kt)("inlineCode",{parentName:"a"},"ibc-hooks"))," module and the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/strangelove-ventures/async-icq"},(0,o.kt)("inlineCode",{parentName:"a"},"async-icq"))," module.")),(0,o.kt)("h2",{id:"description"},"Description"),(0,o.kt)("p",null,"Fee abstraction modules enable users on any Cosmos chain with IBC connections to pay fee using ibc token."),(0,o.kt)("p",null,"Fee-abs implementation:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Fee-abs module imported to the customer chain.")),(0,o.kt)("p",null,"The implementation also uses Osmosis swap router and async-icq module which are already deployed on Osmosis testnet."),(0,o.kt)("h2",{id:"prototype"},"Prototype"),(0,o.kt)("p",null,"Fee-abs mechanism in a nutshell:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Pulling ",(0,o.kt)("inlineCode",{parentName:"li"},"twap data")," and update exchange rate:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Periodically pulling ",(0,o.kt)("inlineCode",{parentName:"li"},"twap data")," from osmosis by ibc-ing to ",(0,o.kt)("inlineCode",{parentName:"li"},"async-icq")," module on Osmosis, this ",(0,o.kt)("inlineCode",{parentName:"li"},"twap data")," will update the exchange rate of osmosis to customer chain's native token.")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Handling txs with ibc-token fee:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The exchange rate is used to calculate the amount of ibc-token needed for tx fee allowing users to pay ibc-token for tx fee instead of chain's native token.")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Swap accumulated ibc-token fee:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The collected ibc-token users use for tx fee is periodically swapped back to customer chain's native token using osmosis.")),(0,o.kt)("p",null,"We'll goes into all the details now:"),(0,o.kt)("h4",{id:"pulling-twap-data-and-update-exchange-rate"},"Pulling ",(0,o.kt)("inlineCode",{parentName:"h4"},"twap data")," and update exchange rate"),(0,o.kt)("p",null,"For this to work, we first has to set up an ibc channel from ",(0,o.kt)("inlineCode",{parentName:"p"},"feeabs")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"async-icq"),". This channel set-up process can be done by anyone, just like setting up an ibc transfer channel. Once that ibc channel is there, we'll use that channel to ibc-query Twap data. Let's call this the querying channel."),(0,o.kt)("p",null,"The process of pulling Twap data and update exchange rate :"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/HJ9a26H.png",alt:"Diagram of the process of pulling Twap data and updating exchange rate",title:"Diagram of the process of pulling Twap data and updating exchange rate"})),(0,o.kt)("p",null,"Description :\nFor every ",(0,o.kt)("inlineCode",{parentName:"p"},"update exchange rate period"),", at fee-abs ",(0,o.kt)("inlineCode",{parentName:"p"},"BeginBlocker()")," we submit a ",(0,o.kt)("inlineCode",{parentName:"p"},"InterchainQueryPacketData")," which wrapped ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryArithmeticTwapToNowRequest")," to the querying channel on the customer chain's end. Then relayers will submit ",(0,o.kt)("inlineCode",{parentName:"p"},"MsgReceivePacket")," so that our ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryTwapPacket")," which will be routed to ",(0,o.kt)("inlineCode",{parentName:"p"},"async-icq")," module to be processed. ",(0,o.kt)("inlineCode",{parentName:"p"},"async-icq")," module then unpack ",(0,o.kt)("inlineCode",{parentName:"p"},"InterchainQueryPacketData")," and send query to TWAP module. The correspone response will be wrapped in the ibc acknowledgement. Relayers then submit ",(0,o.kt)("inlineCode",{parentName:"p"},"MsgAcknowledgement")," to the customer chain so that the ibc acknowledgement is routed to fee-abs to be processed. Fee-abs then update exchange rate according to the Twap wrapped in the ibc acknowledgement."),(0,o.kt)("h4",{id:"handling-txs-with-ibc-token-fee"},"Handling txs with ibc-token fee"),(0,o.kt)("p",null,"We modified ",(0,o.kt)("inlineCode",{parentName:"p"},"MempoolFeeDecorator")," so that it can handle ibc-token as fee. If the tx has ibc-token fee, the AnteHandler will first check if that token is allowed (which is setup by Gov) we basically replace the amount of ibc-token with the equivalent native-token amount which is calculated by ",(0,o.kt)("inlineCode",{parentName:"p"},"exchange rate")," * ",(0,o.kt)("inlineCode",{parentName:"p"},"ibc-token amount"),"."),(0,o.kt)("p",null,"We have an account to manage the ibc-token user used to pay for tx fee. The collected ibc-token fee is sent to that account instead of community pool account."),(0,o.kt)("h4",{id:"swap-accumulated-ibc-tokens-fee"},"Swap accumulated ibc-tokens fee"),(0,o.kt)("p",null,"Fee-abstraction will use osmosis's Cross chain Swap (XCS) feature to do this. We basically ibc transfer to the osmosis crosschain swap contract with custom memo to swap the osmosis fee back to customer chain's native-token and ibc transfer back to the customer chain."),(0,o.kt)("h5",{id:"how-xcs-work"},"How XCS work"),(0,o.kt)("h6",{id:"reverse-with-path-unwinding-to-get-ibc-token-on-osmosis"},"Reverse With Path-unwinding to get Ibc-token on Osmosis"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create a ibc transfer message with a specific MEMO to work with ibc ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/strangelove-ventures/packet-forward-middleware"},(0,o.kt)("inlineCode",{parentName:"a"},"packet-forward-middleware"))," which is path-unwinding (an ibc feature that allow to automatic define the path and ibc transfer multiple hop follow the defined path)"),(0,o.kt)("li",{parentName:"ul"},"Ibc transfer the created packet to get the fee Ibc-token on Osmosis")),(0,o.kt)("p",null,"Ex: When you sent STARS on Hub to Osmosis, you will get Osmosis(Hub(STARS)) which is different with STARS on Osmosis Osmosis(STARS). It will reverse back Osmosis(Hub(STARS)) to Osmosis(STARS):"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/D1wSrMm.png",alt:"Diagram of the process of swapping accumulated ibc-tokens fee",title:"Diagram of the process of swapping accumulated ibc-tokens fee"})),(0,o.kt)("h6",{id:"swap-ibc-token"},"Swap Ibc-token"),(0,o.kt)("h6",{id:"swap-ibc-token-1"},"Swap Ibc-token"),(0,o.kt)("p",null,"After reverse the ibc-token, XCS will :"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Swap with the specific pool (which is defined in the transfer packet from Feeabs-chain) to get Feeabs-chain native-token"),(0,o.kt)("li",{parentName:"ul"},"Transfer back Feeabs-chain native-token to Feeabs module account (will use to pay fee for other transaction)")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://i.imgur.com/YKOK8mr.png",alt:"Diagram of the process of swapping accumulated ibc-tokens fee",title:"Diagram of the process of swapping accumulated ibc-tokens fee"})),(0,o.kt)("p",null,"Current version of fee-abstraction working with XCSv2"),(0,o.kt)("h2",{id:"repository"},"Repository"),(0,o.kt)("p",null,"For more an in-depth docs and implementation, please visit: ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/osmosis-labs/fee-abstraction"},"https://github.com/osmosis-labs/fee-abstraction")))}u.isMDXComponent=!0}}]);
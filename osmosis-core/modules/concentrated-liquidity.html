<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-osmosis-core docs-doc-id-modules/concentrated-liquidity/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Concentrated Liquidity | Osmosis Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" name="twitter:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" property="og:url" content="https://docs.osmosis.zone/osmosis-core/modules/concentrated-liquidity"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" property="og:title" content="Concentrated Liquidity | Osmosis Docs"><meta data-rh="true" name="description" content="Background"><meta data-rh="true" property="og:description" content="Background"><link data-rh="true" rel="icon" href="/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.osmosis.zone/osmosis-core/modules/concentrated-liquidity"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/concentrated-liquidity" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/concentrated-liquidity" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://O18C1RUI3F-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Osmosis Docs" href="/opensearch.xml">









<link rel="preconnect" href="https://app.posthog.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,a){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==a?g=e[a]=[]:a="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)c(g,o[p]);e._i.push([r,s,a])},e.__SV=1)}(document,window.posthog||[]),posthog.init("00",{api_host:"https://app.posthog.com"})</script>

<script src="https://tally.so/widgets/embed.js"></script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="c5b5e9fc-d025-4c12-b08e-9784d0e2161f" data-project-name="Osmosis" data-project-color="#7900B4" data-project-logo="https://app.osmosis.zone/tokens/osmo.svg" async></script><link rel="stylesheet" href="/assets/css/styles.792232e5.css">
<link rel="preload" href="/assets/js/runtime~main.b997ef34.js" as="script">
<link rel="preload" href="/assets/js/main.ed1cf7f0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA" height="26px" width="114px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU" height="26px" width="114px"></div></a><a class="navbar__item navbar__link" href="/overview/educate">Overview</a><a class="navbar__item navbar__link" href="/overview/integrate">Integrate</a><a class="navbar__item navbar__link" href="/overview/validate">Validate &amp; Run your Node</a><a class="navbar__item navbar__link" href="/overview/endpoints">Endpoints</a><a class="navbar__item navbar__link" href="/overview/features">Features</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/osmosis-core">Develop</a><a href="https://github.com/osmosis-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon github-icon"></a><a href="https://discord.com/invite/osmosis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon discord-icon"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link dev-portal-signup dev-portal-link">Launch Dex<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_mhZE"><div class="multiSectionContainer_bYm7"><div class="section_olD1 sectionActive_D9yk" tabindex="0"><div>Osmosis Core</div><div><div class="row_KvCx"><button type="button" role="combobox" aria-controls="" aria-expanded="false" aria-autocomplete="none" aria-label="Select Section" class="sections-menu-trigger"><span style="pointer-events:none"></span><span aria-hidden="true"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" class="sections-menu-scrollButton"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></span></button><select aria-hidden="true" tabindex="-1" style="position:absolute;border:0;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;word-wrap:normal"></select></div></div></div><div class="section_olD1" tabindex="0"><div>CosmWasm</div><div><p class="description_C5q3">Building and interacting with Smart contracts on Osmosis.</p></div></div><div class="section_olD1" tabindex="0"><div>Frontend &amp; SDKs</div><div><p class="description_C5q3">Libraries &amp; UI components to build on top of Osmosis.</p></div></div></div><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/build">Build and Test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/localtesting">Local Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/osmosisd">Osmosis CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ide-guide">IDE Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/osmosis-core/category/modules">Modules</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modules&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osmosis-core/modules/concentrated-liquidity">Concentrated Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/cosmwasmpool">CosmWasm Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/downtime-detector">Downtime-detector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/epochs">Epochs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/osmosis-core/modules/gamm">GAMM</a><button aria-label="Toggle the collapsible sidebar category &#x27;GAMM&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/gov">Gov</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-hooks">IBC-hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-rate-limit">IBC Rate Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/incentives">Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/lockup">Lockup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/mint">Mint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-incentives">Pool Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-manager">Pool Manager Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/protorev">Osmosis modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/superfluid">Superfluid Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/tokenfactory">Token Factory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/twap">TWAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/txfees">Txfees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/valpref-module">validator-set Preference</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/asset-info">Asset Info</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/keys-management">Keys Management</a><button aria-label="Toggle the collapsible sidebar category &#x27;Keys Management&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/relayer">Relayer</a><button aria-label="Toggle the collapsible sidebar category &#x27;Relayer&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ibc">IBC Protocol</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/guides">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Concentrated Liquidity</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">​</a></h2><p>Concentrated liquidity is a novel Automated Market Maker (AMM) design introduced
by Uniswap that allows for more efficient use of capital. The improvement is
achieved by providing liquidity in specific price ranges chosen by the user.</p><p>For instance, a pool with stablecoin pairs like USDC/USDT has a spot price that
should always be trading near 1. As a result, Liquidity Providers (LPs) can
focus their capital in a small range around 1, rather than the full range from 0
to infinity. This approach leads to an average of 200-300x higher capital
efficiency. Moreover, traders benefit from lower price impact because the pool
incentivizes greater depth around the current price.</p><p>Concentrated liquidity also opens up new opportunities for providing liquidity
rewards to desired strategies. For example, it&#x27;s possible to incentivize LPs
based on their position&#x27;s proximity to the current price and the time spent
within that position. This design also allows for a new &quot;range order&quot; type,
similar to a limit order with order-books.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>The traditional Balancer AMM relies on the following curve that tracks current reserves:</p><p><img loading="lazy" alt="eq-1" src="/assets/images/eq-1-81b71433054e83d87843b45b7c1f3c52.png" width="1604" height="122" class="img_ev3q"></p><p>This formula allows for distributing liquidity along the $xy=k$ curve and across
the entire price range of (0, <!-- -->∞<!-- -->).</p><p>With the new architecture, we introduce the concept of a <code>position</code> that allows
users to concentrate liquidity within a fixed range. A position only needs to
maintain enough reserves to satisfy trading within this range. Consequently,
it functions as the traditional <code>xy = k</code> within that range.</p><p>In the new architecture, real reserves are described by the following formula:</p><p><img loading="lazy" alt="eq-2" src="/assets/images/eq-2-6b8fcc3f7cfd7a5d241bf61369eaa894.png" width="1432" height="108" class="img_ev3q"></p><p>Where <code>P_l</code> is the lower tick, <code>P_u</code> is the upper tick, and <code>L</code> is the amount
of liquidity provided,
<img loading="lazy" alt="eq-4" src="/assets/images/eq-4-e04781a2699b82780a8e39dcdea5febd.png" width="1534" height="124" class="img_ev3q"></p><p>This formula stems from the original $xy = k$ but with a limited range. In the
traditional design, a pool&#x27;s <code>x</code> and <code>y</code> tokens are tracked directly. However,
with the concentrated design, we only track $L$ and $\sqrt P$, which can be
calculated with:</p><p><img loading="lazy" alt="eq-5" src="/assets/images/eq-5-01d0538bcb20aca0f4871ff10e016111.png" width="1436" height="260" class="img_ev3q"></p><p>By rearranging the above, we obtain the following formulas to track virtual reserves:
<img loading="lazy" alt="eq-6" src="/assets/images/eq-6-b1fb77394310e0498a4e89cfe7f6e037.png" width="1544" height="256" class="img_ev3q"></p><p>Note the square root around price. By tracking it this way, we can utilize the
following core property of the architecture:</p><p><img loading="lazy" alt="eq-7" src="/assets/images/eq-7-7ad0dce4658c97b9b55a428b1c19a1a7.png" width="1492" height="136" class="img_ev3q"></p><p>Since only one of the following changes at a time:</p><ul><li>$L$: When an LP adds or removes liquidity</li><li>sqrt P: When a trader swaps</li></ul><p>We can use the above relationship to calculate the outcome of swaps as well as
pool joins that mint shares.</p><p>Conversely, we calculate liquidity from the other token in the pool:</p><p><img loading="lazy" alt="eq-8" src="/assets/images/eq-8-91907d418f1ab22f16f702184624030b.png" width="1436" height="168" class="img_ev3q"></p><p>Overall, the architecture&#x27;s goal is to enable LPs to provide concentrated
liquidity within a specific range while maintaining high capital efficiency.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ticks">Ticks<a class="hash-link" href="#ticks" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a class="hash-link" href="#context" title="Direct link to heading">​</a></h3><p>In Uniswap V3, discrete points (called ticks) are used when providing liquidity
in a concentrated liquidity pool.</p><p>The price <!-- -->[p]<!-- --> corresponding to a tick <!-- -->[t]<!-- --> is defined by the equation:</p><p><img loading="lazy" alt="eq-9" src="/assets/images/eq-9-63345af8e95f46130c267bde0df139d6.png" width="1438" height="80" class="img_ev3q"></p><p>This results in a .01% difference between adjacent tick prices. This does not,
however, allow for control over the specific prices that the ticks correspond
to. For example, if a user wants to make a limit order at the $17,100.50 price point,
they would have to interact with either tick 97473 (corresponding to price
$17,099.60) or tick 97474 (price $17101.30).</p><p>Since we know what range a pair will generally trade in, how can we provide more
granularity at that range and provide a more optimal price range between ticks
instead of the &quot;one-size-fits-all&quot; approach explained above?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="geometric-tick-spacing-with-additive-ranges">Geometric Tick Spacing with Additive Ranges<a class="hash-link" href="#geometric-tick-spacing-with-additive-ranges" title="Direct link to heading">​</a></h3><p>In Osmosis&#x27; implementation of concentrated liquidity, we will instead make use
of geometric tick spacing with additive ranges.</p><p>We start by defining an exponent for the precision factor of each incremental
tick starting at the spot price of one. This is referred to as $exponentAtPriceOne$.</p><p>In the current design, we hardcode $exponentAtPriceOne$ as -6. When used with a
tick spacing of 100, this effectively acts as an $exponentAtPriceOne$ of -4,
since only every 100 ticks are able to be initialized.</p><p>When $exponentAtPriceOne = -6$ (and tick spacing is 100), each tick starting at
0 and ending at the first factor of 10 will represents a spot price increase of 0.0001:</p><ul><li>tick_{0} = 1</li><li>tick_{100} = 1.0001</li><li>tick_{200} = 1.0002</li><li>tick_{300} = 1.0003</li></ul><p>This continues until the pool reaches a spot price of 10. At this point, since
the pool has increased by a factor of 10, the $exponentAtCurrentTick$ increases
from -4 to -3 (decreasing the incremental precision), and the ticks will
increase as follows:</p><ul><li>tick_{8999900} =  9.9999</li><li>tick_{9000000} = 10.000</li><li>tick_{9000100} = 10.001</li><li>tick_{9000200} = 10.002</li></ul><p>For spot prices less than a dollar, the precision factor decreases
(increasing the incremental precision) at every factor of 10:</p><ul><li>tick_{-100} = 0.99999</li><li>tick_{-200} = 0.99998</li><li>tick_{-500100} = 0.94999</li><li>tick_{-500200} = 0.94998</li><li>tick_{-9000100} = 0.099999</li><li>tick_{-9000200} = 0.099998</li></ul><p>This goes on in the negative direction until it reaches a spot price of
0.000000000000000001 or in the positive direction until it reaches a spot
price of 100000000000000000000000000000000000000.</p><p>The minimum spot price was chosen as this is the smallest possible number
supported by the sdk.Dec type. As for the maximum spot price, the above number
was based on gamm&#x27;s max spot price of 340282366920938463463374607431768211455.
While these numbers are not the same, the max spot price used in concentrated
liquidity utilizes the same number of significant figures as gamm&#x27;s max spot
price and is less than gamm&#x27;s max spot price which satisfies the initial design requirements.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="formulas">Formulas<a class="hash-link" href="#formulas" title="Direct link to heading">​</a></h3><p>After we define tick spacing (which effectively defines the $exponentAtPriceOne$,
since $exponentAtPriceOne$ is fixed), we can then calculate how many ticks must
be crossed in order for $k$ to be incremented
( $geometricExponentIncrementDistanceInTicks$ ).</p><p><img loading="lazy" alt="eq-10" src="/assets/images/eq-10-4b2a0309c7cb6ce18331b460c94adabe.png" width="1626" height="140" class="img_ev3q"></p><p>Since we define exponentAtPriceOne and utilize this as the increment starting
point instead of price zero, we must multiply the result by 9 as shown above.
In other words, starting at 1, it takes 9 ticks to get to the first power of 10.
Then, starting at 10, it takes 9<!-- -->*<!-- -->10 ticks to get to the next power of 10, etc.</p><p>Now that we know how many ticks must be crossed in order for our
exponentAtPriceOne to be incremented, we can then figure out what our change
in exponentAtPriceOne will be based on what tick is being traded at:</p><p><img loading="lazy" alt="eq-11" src="/assets/images/eq-11-70776a28381557a6d399efedb1d2758b.png" width="1862" height="114" class="img_ev3q"></p><p>With geometricExponentDelta and <em>exponentAtPriceOne</em>, we can figure out what
the <em>exponentAtPriceOne</em> value we will be at when we reach the provided tick:</p><p><img loading="lazy" alt="eq-13" src="/assets/images/eq-13-ab512c2aa0cb9997288941b85a6739cf.png" width="1452" height="176" class="img_ev3q"></p><p>Knowing what our <em>exponentAtCurrentTick</em> is, we must then figure out what power
of 10 this $exponentAtPriceOne$ corresponds to (by what number does the price
gets incremented with each new tick):</p><p><img loading="lazy" alt="eq-12" src="/assets/images/eq-12-16c2ffdc79d0a33b081fd3631d91f149.png" width="1484" height="126" class="img_ev3q"></p><p>Lastly, we must determine how many ticks above the current increment we are at:</p><p><img loading="lazy" alt="eq-14" src="/assets/images/eq-14-ea1303ee04a3906ddca27050f18625d1.png" width="2374" height="138" class="img_ev3q"></p><p>With this, we can determine the price:</p><p><img loading="lazy" alt="eq-15" src="/assets/images/eq-15-f4fc556da85f9735612e0b5207ec9393.png" width="2144" height="96" class="img_ev3q"></p><p>where (10^{geometricExponentDelta}) is the price after $geometricExponentDelta$
increments of <em>exponentAtPriceOne</em> (which is basically the number of decrements
of difference in price between two adjacent ticks by the power of 10)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tick-spacing-example-tick-to-price">Tick Spacing Example: Tick to Price<a class="hash-link" href="#tick-spacing-example-tick-to-price" title="Direct link to heading">​</a></h3><p>Bob sets a limit order on the <code>USD&lt;&gt;BTC</code> pool at tick 36650010. This pool&#x27;s
$exponentAtPriceOne$ is -6. What price did Bob set his limit order at?</p><p><img loading="lazy" alt="eq-16" src="/assets/images/eq-16-f17a42a76c6ec866353cba4856a39765.png" width="2564" height="364" class="img_ev3q"></p><p>Bob set his limit order at price $16,500.10</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tick-spacing-example-price-to-tick">Tick Spacing Example: Price to Tick<a class="hash-link" href="#tick-spacing-example-price-to-tick" title="Direct link to heading">​</a></h3><p>Bob sets a limit order on the <code>USD&lt;&gt;BTC</code> pool at price $16,500.10. This pool&#x27;s
$exponentAtPriceOne$ is -6. What tick did Bob set his limit order at?</p><p><img loading="lazy" alt="eq-17" src="/assets/images/eq-17-9b446f79700d0e1637412a384ca32de5.png" width="1710" height="120" class="img_ev3q"></p><p>We must loop through increasing exponents until we find the first exponent that
is greater than or equal to the desired price</p><p><img loading="lazy" alt="eq-18" src="/assets/images/eq-18-6c25c3be68dfb31171f7dd1c233a72e4.png" width="3110" height="414" class="img_ev3q"></p><p>10 is less than 16,500.10, so we must increase our exponent and try again</p><p><img loading="lazy" alt="eq-19" src="/assets/images/eq-19-fdd4a1d67e74a2b7e316ba046a0c663d.png" width="3098" height="318" class="img_ev3q"></p><p>100 is less than 16,500.10, so we must increase our exponent and try again.
This goes on until...</p><p><img loading="lazy" alt="eq-20" src="/assets/images/eq-20-5e4d6fa16fb4b5cca5ba3899395e4d5e.png" width="2902" height="290" class="img_ev3q"></p><p>100000 is greater than 16,500.10. This means we must now find out how many
additive tick in the currentAdditiveIncrementInTicks of -2 we must pass in
order to reach 16,500.10.</p><p><img loading="lazy" alt="eq-21" src="/assets/images/eq-21-f086c8a25cfdfceb52db8794b0fcac31.png" width="2770" height="168" class="img_ev3q"></p><p>Bob set his limit order at tick 36650010</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="choosing-an-exponent-at-price-one-value">Choosing an Exponent At Price One Value<a class="hash-link" href="#choosing-an-exponent-at-price-one-value" title="Direct link to heading">​</a></h2><p>The creator of a pool cannot choose an exponenetAtPriceOne as one of the input
parameters since it is hard coded to -6. The number can be psedo-controlled by
choosing the tick spacing a pool is initialized with. For example, if a pool
is desired to have an exponentAtPriceOne of -6, the pool creator can choose a
tick spacing of 1. If a pool is desired to have an exponentAtPriceOne of -4,
this is two factors of 10 greater than -6, so the pool creator can choose a
tick spacing of 100 to achieve this level of precision.</p><p>As explained previously, the exponent at price one determines how much the spot
price increases or decreases when traversing ticks. The following equation will
assist in selecting this value:</p><p><img loading="lazy" alt="eq-22" src="/assets/images/eq-22-7c0df290d89de4e6526cec83ab740a38.png" width="2512" height="322" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1">Example 1<a class="hash-link" href="#example-1" title="Direct link to heading">​</a></h3><p>SHIB is trading at $0.00001070 per SHIB
BTC is trading at $28,000 per BTC</p><p>We want to create a SHIB/BTC concentrated liquidity pool where SHIB is the
baseAsset (asset0) and BTC is the quoteAsset (asset1). In terms of the quoteAsset,
we want to increment in 10 cent values.
<img loading="lazy" alt="eq-23" src="/assets/images/eq-23-9848695196f87d361a79cb518a5282a8.png" width="2542" height="378" class="img_ev3q"></p><p>We can therefore conclude that we can use an exponent at price one of -5
(slightly under precise) or -6 (slightly over precise) for this base/quote pair
and desired price granularity. This means we would either want a tick spacing of 1
(to have an exponent at price one of -6) or 10 (to have an exponent at price one of -5).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-2">Example 2<a class="hash-link" href="#example-2" title="Direct link to heading">​</a></h3><p>Flipping the quoteAsset/baseAsset, for BTC/SHIB, lets determine what the
exponentAtPriceOne should be. For SHIB as a quote, centralized exchanges
list prices at the 10^-8, so we will set our desired increment to this value.</p><p><img loading="lazy" alt="eq-24" src="/assets/images/eq-24-606c3e499352f71549fbc5796ad63796.png" width="2528" height="374" class="img_ev3q"></p><p>We can therefore conclude that we can use an exponent at price one of -3
for this base/quote pair and desired price granularity. This means we would
want a tick spacing of 1000 (to have an exponent at price one of -3).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a class="hash-link" href="#consequences" title="Direct link to heading">​</a></h3><p>This decision allows us to define ticks at spot prices that users actually
desire to trade on, rather than arbitrarily defining ticks at .01% distance
between each other. This will also make integration with UX seamless,
instead of either:</p><p>a) Preventing trade at a desirable spot price or
b) Having the front end round the tick&#x27;s actual price to the nearest
human readable/desirable spot price</p><p>One side effect of increasing precision as we get closer to the minimum tick
is that multiple ticks can represent the same price. For example, tick
-161795100 (along with the ticks surrounding it) correlate to a price
of 0.000000000000000002. To get around any issues this may cause, when a
position is created with a user defined lower and upper tick, we determine
if a larger tick exists that represents the same price. If so, we use that tick
instead of the user defined tick. In the above example, the tick would be
changed to -161000000, which is the first tick that represents the same price.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="concentrated-liquidity-module-messages">Concentrated Liquidity Module Messages<a class="hash-link" href="#concentrated-liquidity-module-messages" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgcreateposition"><code>MsgCreatePosition</code><a class="hash-link" href="#msgcreateposition" title="Direct link to heading">​</a></h3><ul><li><strong>Request</strong></li></ul><p>This message allows LPs to provide liquidity between <code>LowerTick</code> and <code>UpperTick</code>
in a given <code>PoolId</code>. The user provides the amount of each token desired. Since
LPs are only allowed to provide liquidity proportional to the existing reserves,
the actual amount of tokens used might differ from requested. As a result, LPs
may also provide the minimum amount of each token to be used so that the system fails
to create position if the desired amounts cannot be satisfied.</p><p>Three KV stores are initialized when a position is created:</p><ol><li><code>Position ID -&gt; Position</code> - This is a mapping from a unique position ID to a
position object. The position ID is a monotonically increasing integer that is
incremented every time a new position is created.</li><li><code>Owner | Pool ID | Position ID -&gt; Position ID</code> - This is a mapping from a
composite key of the owner address, pool ID, and position ID to the position ID.
This is used to keep track of all positions owned by a given owner in a given pool.</li><li><code>Pool ID -&gt; Position ID</code> - This is a mapping from a pool ID to a position ID.
This is used to keep track of all positions in a given pool.</li></ol><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCreatePosition </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PoolId          </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender          </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LowerTick       </span><span class="token builtin" style="color:rgb(86, 156, 214)">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> UpperTick       </span><span class="token builtin" style="color:rgb(86, 156, 214)">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> TokenDesired0   types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Coin</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> TokenDesired1   types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Coin</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> TokenMinAmount0 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> TokenMinAmount1 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Response</strong></li></ul><p>On successful response, we receive the actual amounts of each token used to
create the liquidityCreated number of shares in the given range.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCreatePositionResponse </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PositionId  </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Amount0 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Amount1 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> JoinTime google</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">protobuf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Timestamp</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LiquidityCreated github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This message should call the <code>createPosition</code> keeper method that is introduced
in the <code>&quot;Liquidity Provision&quot;</code> section of this document.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgwithdrawposition"><code>MsgWithdrawPosition</code><a class="hash-link" href="#msgwithdrawposition" title="Direct link to heading">​</a></h3><ul><li><strong>Request</strong></li></ul><p>This message allows LPs to withdraw their position via their position ID,
potentially in partial amount of liquidity. It should fail if the position ID
does not exist or if attempting to withdraw an amount higher than originally
provided. If an LP withdraws all of their liquidity from a position, then the
position is deleted from state along with the three KV stores that were
initialized in the <code>MsgCreatePosition</code> section. However, the spread factor accumulators
associated with the position are still retained until a user claims them manually.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgWithdrawPosition </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PositionId      </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender          </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LiquidityAmount github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Response</strong></li></ul><p>On successful response, we receive the amounts of each token withdrawn
for the provided share liquidity amount.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgWithdrawPositionResponse </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Amount0 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Amount1 github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This message should call the <code>withdrawPosition</code> keeper method that is introduced
in the <code>&quot;Liquidity Provision&quot;</code> section of this document.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgcreatepool"><code>MsgCreatePool</code><a class="hash-link" href="#msgcreatepool" title="Direct link to heading">​</a></h3><p>This message is responsible for creating a concentrated-liquidity pool.
It propagates the execution flow to the <code>x/poolmanager</code> module for pool id
management and for routing swaps.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCreateConcentratedPool </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender                    </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Denom0                    </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Denom1                    </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> TickSpacing               </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> SpreadFactor                   github_com_cosmos_cosmos_sdk_types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Response</strong></li></ul><p>On successful response, the pool id is returned.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCreateConcentratedPoolResponse </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PoolID </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgcollectspreadrewards"><code>MsgCollectSpreadRewards</code><a class="hash-link" href="#msgcollectspreadrewards" title="Direct link to heading">​</a></h3><p>This message allows collecting rewards from spreads for multiple position IDs from a
single owner.</p><p>The spread factor collection is discussed in more detail in the &quot;Spread Rewards&quot; section of this document.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCollectSpreadRewards </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PositionIds    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender         </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Response</strong></li></ul><p>On successful response, the collected tokens are returned.
The sender should also see their balance increase by the returned
amounts.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgCollectSpreadRewardsResponse </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> CollectedSpreadRewards </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Coin</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgfungifychargedpositions"><code>MsgFungifyChargedPositions</code><a class="hash-link" href="#msgfungifychargedpositions" title="Direct link to heading">​</a></h3><p>This message allows fungifying the fully charged unlocked positions belonging to the same owner
and located in the same tick range.
MsgFungifyChargedPosition takes in a list of positionIds and combines them into a single position.
It validates that all positions belong to the same owner, are in the same ticks and are fully charged.
Fails if not. Otherwise, it creates a completely new position P. P&#x27;s liquidity equals to the sum of all
liquidities of positions given by positionIds. The uptime of the join time of the new position equals
to current block time - max authorized uptime duration (to signify that it is fully charged).
The previous positions are deleted from state. Prior to deleting, the rewards are claimed.
The old position&#x27;s unclaimed rewards are transferred to the new position.
The new position ID is returned.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgFungifyChargedPositions </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> PositionIds    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender         </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Response</strong></li></ul><p>On successful response, the new position id is returned.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> MsgFungifyChargedPositionsResponse </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> NewPositionId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="relationship-to-pool-manager-module">Relationship to Pool Manager Module<a class="hash-link" href="#relationship-to-pool-manager-module" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pool-creation">Pool Creation<a class="hash-link" href="#pool-creation" title="Direct link to heading">​</a></h3><p>As previously mentioned, the <code>x/poolmanager</code> is responsible for creating the
pool upon being called from the <code>x/concentrated-liquidity</code> module&#x27;s message server.</p><p>It does so to store the mapping from pool id to concentrated-liquidity module so
that it knows where to route swaps.</p><p>Upon successful pool creation and pool id assignment, the <code>x/poolmanager</code> module
returns the execution to <code>x/concentrated-liquidity</code> module by calling <code>InitializePool</code>
on the <code>x/concentrated-liquidity</code> keeper.</p><p>The <code>InitializePool</code> method is responsible for doing concentrated-liquidity specific
initialization and storing the pool in state.</p><p>Note, that <code>InitializePool</code> is a method defined on the <code>SwapI</code> interface that is
implemented by all swap modules. For example, <code>x/gamm</code> also implements it so that
<code>x/pool-manager</code> can route pool initialization there as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="swaps">Swaps<a class="hash-link" href="#swaps" title="Direct link to heading">​</a></h3><p>We rely on the swap messages located in <code>x/poolmanager</code>:</p><ul><li><code>MsgSwapExactAmountIn</code></li><li><code>MsgSwapExactAmountOut</code></li></ul><p>The <code>x/poolmanager</code> received the swap messages and, as long as the swap&#x27;s pool id
is associated with the <code>concentrated-liquidity</code> pool, the swap is routed
into the relevant module. The routing is done via the mapping from state that was
discussed in the &quot;Pool Creation&quot; section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity-provision">Liquidity Provision<a class="hash-link" href="#liquidity-provision" title="Direct link to heading">​</a></h2><blockquote><p>As an LP, I want to provide liquidity in ranges so that I can achieve greater
capital efficiency</p></blockquote><p>This is a basic function that should allow LPs to provide liquidity in specific ranges
to a pool.</p><p>A pool&#x27;s liquidity is consisted of two assets: asset0 and asset1. In all pools,
asset1 will be the quote asset and must be an approved denom listed in the module
parameters. At the current tick, the bucket at this tick consists of a mix of both
asset0 and asset1 and is called the virtual liquidity of the pool (or &quot;L&quot; for short).
Any positions set below the current price are consisted solely of asset0 while
positions above the current price only contain asset1.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-liquidity">Adding Liquidity<a class="hash-link" href="#adding-liquidity" title="Direct link to heading">​</a></h3><p>We can either provide liquidity above or below the current price, which would
act as a range order, or decide to provide liquidity at the current price.</p><p>As declared in the API for <code>createPosition</code>, users provide the upper and lower
tick to denote the range they want to provide the liquidity in. The users are
also prompted to provide the amount of token0 and token1 they desire to receive.
The liquidity that needs to be provided for the given token0 and token1 amounts
would be then calculated by the following methods:</p><p>Liquidity needed for token0:
$$L = \frac{\Delta x \sqrt{P_u} \sqrt{P_l}}{\sqrt{P_u} - \sqrt{P_l}}$$</p><p>Liquidity needed for token1:
$$L = \frac{\Delta y}{\sqrt{P_u}-\sqrt{P_l}}$$</p><p>Then, we pick the smallest of the two values for choosing the final <code>L</code>. The
reason we do that is because the new liquidity must be proportional to the old
one. By choosing the smaller value, we distribute the liqudity evenly between
the two tokens. In the future steps, we will re-calculate the amount of token0
and token1 as a result the one that had higher liquidity will end up smaller
than originally given by the user.</p><p>Note that the liquidity used here does not represent an amount of a specific
token, but the liquidity of the pool itself, represented in <code>sdk.Dec</code>.</p><p>Using the provided liquidity, now we calculate the delta amount of both token0
and token1, using the following equations, where L is the liquidity calculated above:</p><p>$$\Delta x = \frac{L(\sqrt{p(i_u)} - \sqrt{p(i_c)})}{\sqrt{p(i_u)}\sqrt{p(i_c)}}$$
$$\Delta y = L(\sqrt{p(i_c)} - \sqrt{p(i_l)})$$</p><p>Again, by recalculating the delta amount of both tokens, we make sure that the
new liquidity is proportional to the old one and the excess amount of the token
that originally computed a larger liquidity is given back to the user.</p><p>The delta X and the delta Y are the actual amounts of tokens joined for the
requested position.</p><p>Given the parameters needed for calculating the tokens needed for creating a
position for a given tick, the API in the keeper layer would look like the following:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">ctx sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> poolId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> owner sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AccAddress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount0Desired</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">amount1Desired</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount0Min</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount1Min sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">lowerTick</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> upperTick </span><span class="token builtin" style="color:rgb(86, 156, 214)">int64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> frozenUntil time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">createPosition</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ctx sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    poolId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    owner sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AccAddress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount0Desired</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount1Desired</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount0Min</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount1Min sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    lowerTick</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    upperTick </span><span class="token builtin" style="color:rgb(86, 156, 214)">int64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">amount0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount1 sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="removing-liquidity">Removing Liquidity<a class="hash-link" href="#removing-liquidity" title="Direct link to heading">​</a></h3><p>Removing liquidity is achieved via method <code>withdrawPosition</code> which is the inverse
of previously discussed <code>createPosition</code>. In fact, the two methods share the same
underlying logic, having the only difference being the sign of the liquidity.
Plus signifying addition while minus signifying subtraction.</p><p>Withdraw position also takes an additional parameter which represents the liqudity
a user wants to remove. It must be less than or equal to the available liquidity
in the position to be successful.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">k Keeper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">withdrawPosition</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ctx sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    poolId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    owner sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AccAddress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    lowerTick</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    upperTick </span><span class="token builtin" style="color:rgb(86, 156, 214)">int64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    frozenUntil time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    requestedLiquidityAmountToWithdraw sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">amtDenom0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amtDenom1 sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err </span><span class="token builtin" style="color:rgb(86, 156, 214)">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="swapping">Swapping<a class="hash-link" href="#swapping" title="Direct link to heading">​</a></h2><blockquote><p>As a trader, I want to be able to swap over a concentrated liquidity pool so
that my trades incur lower slippage</p></blockquote><p>Unlike balancer pools where liquidity is spread out over an infinite range,
concentrated liquidity pools allow for LPs to provide deeper liquidity for
specific price ranges, which in turn allows traders to incur less slippage on
their trades.</p><p>Despite this improvement, the liquidity at the current price is still finite,
and large single trades in times of high volume, as well as trades against
volatile assets, are eventually bound to incur some slippage.</p><p>In order to determine the depth of liquidity and subsequent amountIn/amountOut
values for a given pool, we track the swap&#x27;s state across multiple swap &quot;steps&quot;.
You can think of each of these steps as the current price following the original
xy=k curve, with the far left bound being the next initialized tick below the
current price and the far right bound being the next initialized tick above the
current price. It is also important to note that we always view prices of asset1
in terms of asset0, and selling asset1 for asset0 would, in turn, increase its
spot price. The reciprocal is also true, where if we sell asset0 for asset1,
we would decrease the pool&#x27;s spot price.</p><p>When a user swaps asset0 for asset1 (can also be seen as &quot;selling&quot; asset0), we
move left along the curve until asset1 reserves in this tick are depleted.
If the tick of the current price has enough liquidity to fulfill the order without
stepping to the next tick, the order is complete. If we deplete all of asset1 in
the current tick, this then marks the end of the first swap &quot;step&quot;. Since all
liquidity in this tick has been depleted, we search for the next closest tick
to the left of the current tick that has liquidity. Once we reach this tick, we
determine how much more of asset1 is needed to complete the swap. This process
continues until either the entire order is fulfilled or all liquidity is drained
from the pool.</p><p>The same logic is true for swapping asset1, which is analogous to buying asset0;
however, instead of moving left along the set of curves, we instead search for
liquidity to the right.</p><p>From the user perspective, there are two ways to swap:</p><ol><li><p>Swap given token in for token out.</p><ul><li>E.g. I have 1 ETH that I swap for some computed amount of DAI.</li></ul></li><li><p>Swap given token out for token in</p><ul><li>E.g. I want to get out 3000 DAI for some amount of ETH to compute.</li></ul></li></ol><p>Each case has a corresponding message discussed previously in the <code>x/poolmanager</code>
section.</p><ul><li><code>MsgSwapExactIn</code></li><li><code>MsgSwapExactOut</code></li></ul><p>Once a message is received by the <code>x/poolmanager</code>, it is propageted into a
corresponding keeper
in <code>x/concentrated-liquidity</code>.</p><p>The relevant keeper method then calls its non-mutative <code>calc</code> version which is
one of:</p><ul><li><code>calcOutAmtGivenIn</code></li><li><code>calcInAmtGivenOut</code></li></ul><p>State updates only occur upon successful execution of the swap inside the calc method.
We ensure that calc does not update state by injecting <code>sdk.CacheContext</code> as its
context parameter. The cache context is dropped on failure and committed on success.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="calculating-swap-amounts">Calculating Swap Amounts<a class="hash-link" href="#calculating-swap-amounts" title="Direct link to heading">​</a></h3><p>Let&#x27;s now focus on the core logic of calculating swap amounts.
We mainly focus on <code>calcOutAmtGivenIn</code> as the high-level steps of <code>calcInAmtGivenOut</code>
are similar.</p><p><strong>1. Determine Swap Strategy</strong></p><p>The first step we need to determine is the swap strategy. The swap strategy determines
the direction of the swap, and it is one of:</p><ul><li><p><code>zeroForOne</code> - swap token zero in for token one out.</p></li><li><p><code>oneForZero</code> - swap token one in for token zero out.</p></li></ul><p>Note that the first token in the strategy name always corresponds to the token
being swapped in, while the second token corresponds to the token being swapped
out. This is true for both <code>calcOutAmtGivenIn</code> and <code>calcInAmtGivenOut</code> calc methods.</p><p>Recall that, in our model, we fix the tokens axis at the time of pool creation.
The token on the x-axis is token zero, while the token on the y-axis is token one.</p><p>Given that the sqrt price is defined as $$\sqrt (y / x)$$, as we swap token zero
(x-axis) in for token one (y-axis), we decrease the sqrt price and move down
along the price/tick curve. Conversely, as we swap token one (y-axis) in for token
zero (x-axis), we increase the sqrt price and move up along the price/tick curve.</p><p>The reason we call this a price/tick curve is because there is a relationship
between the price and the tick. As a result, when we perform the swap, we are
likely to end up crossing a tick boundary. As a tick is crossed, the swap state
internals must be updated. We will discuss this in more detail later.</p><p><strong>2. Initialize Swap State</strong></p><p>The next step is to initialize the swap state. The swap state is a struct that
contains all of the swap state to be done within the current active tick
(before we across a tick boundary).</p><p>It contains the following fields:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// SwapState defines the state of a swap.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// It is initialized as the swap begins and is updated after every swap step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// Once the swap is complete, this state is either returned to the estimate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// swap querier or committed to state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> SwapState </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Remaining amount of specified token.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// if out given in, amount of token being swapped in.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// if in given out, amount of token being swapped out.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to the amount of the token specified by the user.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated after every swap step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> amountSpecifiedRemaining sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Amount of the other token that is calculated from the specified token.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// if out given in, amount of token swapped out.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// if in given out, amount of token swapped in.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to zero.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated after every swap step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> amountCalculated sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Current sqrt price while calculating swap.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to the pool&#x27;s current sqrt price.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated after every swap step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> sqrtPrice sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Current tick while calculating swap.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to the pool&#x27;s current tick.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated each time a tick is crossed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> tick sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Int</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Current liqudiity within the active tick.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to the pool&#x27;s current tick&#x27;s liquidity.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated each time a tick is crossed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> liquidity sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Global spread reward growth per-current swap.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Initialized to zero.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// Updated after every swap step.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> spreadRewardGrowthGlobal sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3. Compute Swap</strong></p><p>The next step is to compute the swap. Conceptually, it can be done in two ways
listed below.Before doing so, we find the next initialized tick. An initialized
tick is the tick that is touched by the edges of at least one position. If no
position has an edge at a tick, then that tick is uninitialized.</p><p>a. Swap within the same initialized tick range.</p><p>See &quot;Appendix A&quot; for details on what &quot;initialized&quot; means.</p><p>This case occurs when <code>swapState.amountSpecifiedRemaining</code> is less than or equal
to the amount needed to reach the next tick. We omit the math needed to determine
how much is enough until a later section.</p><p>b. Swap across multiple initialized tick ranges.</p><p>See &quot;Appendix A&quot; for details on what &quot;initialized&quot; means.</p><p>This case occurs when <code>swapState.amountSpecifiedRemaining</code> is greater than the
amount needed to reach the next tick</p><p>In terms of the code implementation, we loop, calling a <code>swapStrategy.ComputeSwapStepOutGivenIn</code>
or <code>swapStrategy.ComputeSwapStepInGivenOut</code> method, depending on swap out given
in or in given out, respectively.</p><p>The swap strategy is already initialized to be either <code>zeroForOne</code> or <code>oneForZero</code>
from step 1. Go dynamically determines the desired implementation via polymorphism.</p><p>We leave details of the <code>ComputeSwapStepOutGivenIn</code> and <code>ComputeSwapStepInGivenOut</code>
methods to the appendix of the &quot;Swapping&quot; section.</p><p>The iteration stops when <code>swapState.amountSpecifiedRemaining</code> runs out or when
swapState.sqrtPrice reaches the sqrt price limit specified by the user as a price
impact protection.</p><p><strong>4. Update Swap State</strong></p><p>Upon computing the swap step, we update the swap state with the results of the
swap step. Namely,</p><ul><li><p>Subtract the consumed specified amount from <code>swapState.amountSpecifiedRemaining</code>.</p></li><li><p>Add the calculated amount to <code>swapState.amountCalculated</code>.</p></li><li><p>Update <code>swapState.sqrtPrice</code> to the new sqrt price. The new sqrt price is not
necessarily the sqrt price of the next tick. It is the sqrt price of the next tick
if the swap step crosses a tick boundary. Otherwise, it is something in between
the original and the next tick sqrt price.</p></li><li><p>Update <code>swapState.tick</code> to the next initialized tick if it is reached;
otherwise, update it to the new tick calculated from the new sqrt price.
If the sqrt price is unchanged, the tick remains unchanged as well.</p></li><li><p>Update <code>swapState.liquidity</code> to the new liquidity only if the next initialized
tick is crossed. The liquidity is updated by incorporating the <code>liquidity_net</code>
amount associated with the next initialized tick being crossed.</p></li><li><p>Update <code>swapState.spreadRewardGrowthGlobal</code> to the value of the total spread factor charged within
the swap step on the amount of token in per one unit of liquidity within the
tick range being swapped in.</p></li></ul><p>Then, we either proceed to the next swap step or finalize the swap.</p><p><strong>5. Update Global State</strong></p><p>Once the swap is completed, we persiste the swap state to the global state
(if mutative action is performed) and return the <code>amountCalculated</code> to the user.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration">Migration<a class="hash-link" href="#migration" title="Direct link to heading">​</a></h2><p>Users can migrate their Balancer positions to a Concentrated Liquidity full range
position provided the underlying Balancer pool has a governance-selected canonical
Concentrated Liquidity pool. The migration is routed depending on the state of the
underlying Balancer position:</p><p>Balancer position is:</p><ul><li>Superfluid delegated<ul><li>Locked</li></ul></li><li>Superfluid undelegating<ul><li>Locked</li><li>Unlocking</li></ul></li><li>Normal lock<ul><li>Locked</li><li>Unlocking</li></ul></li><li>Unlocked</li></ul><p>Regardless of the path taken, the <code>UnlockAndMigrateSharesToFullRangeConcentratedPosition</code>
message executes all of the below logic:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-delegated-balancer-to-concentrated">Superfluid Delegated Balancer to Concentrated<a class="hash-link" href="#superfluid-delegated-balancer-to-concentrated" title="Direct link to heading">​</a></h3><p>The following diagram illustrates the migration flow for a Superfluid delegated
Balancer position to a Superfluid delegated Concentrated Liquidity position.</p><p><img loading="lazy" alt="Migrate Superfluid Delegate Balancer to Concentrated" src="/assets/images/MigrateSuperfluidDelegated-a9a2f0dcb62461f33ad41f20512fdc01.png" width="1447" height="1336" class="img_ev3q"></p><p>The migration process starts by removing the connection between the GAMM lock and
the GAMM intermediary account. The synthetic OSMO that was previously minted by
the GAMM intermediary account is immediately undelegated (skipping the two-week
unbonding period) and sent to the Superfluid module account where it is burned.</p><p>Next, the Lockup module account holding the original GAMM shares sends them back
to the user, deleting the GAMM lock in the process. These shares are used to
claim the underlying two assets from the GAMM pool, which are then immediately
put into a full range Concentrated Liquidity position in the canonical
Concentrated Liquidity pool.</p><p>The underlying liquidity this creates is tokenized (similar to GAMM shares) and
is put into a new lock, which is then routed to the Lockup module account. A new
intermediary account is created based on this new CL share denom. The new
intermediary account mints synthetic OSMO and delegates it to the validator the
user originally delegated to. Finally, a new synthetic lock in a bonded status
is created based on the new CL lock ID, the new CL intermediary account, and the
new CL synthetic denom.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-undelegating-balancer-to-concentrated">Superfluid Undelegating Balancer to Concentrated<a class="hash-link" href="#superfluid-undelegating-balancer-to-concentrated" title="Direct link to heading">​</a></h3><p>The following diagram illustrates the migration flow for a superfluid undelegating
balancer position to a superfluid undelegating concentrated liquidity position.
The reason we must account for this situation is to respect the two week unbonding
period that is required for superfluid undelegating, and be capable of slashing
a position that was migrated.</p><p><img loading="lazy" alt="Migrate Superfluid Undelegating Balancer to Concentrated" src="/assets/images/MigrateSuperfluidUndelegating-a826ba28914344970cb851ef6c22ca1c.png" width="1395" height="1285" class="img_ev3q"></p><p>The process is identical to the Superfluid delegated migration, with three
exceptions. First, the connection between the GAMM intermediary account and the
GAMM lock is already removed when a user started undelegation, so it does not
need to be done again. Second, no synthetic OSMO needs to be burned or created.
Lastly, instead of creating a new CL synthetic lock in a bonded status, we create
a new CL synthetic lock in an unlocking status. This lock will be unlocked once
the two-week unbonding period is over.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="locked-and-unlocked-balancer-to-concentrated">Locked and Unlocked Balancer to Concentrated<a class="hash-link" href="#locked-and-unlocked-balancer-to-concentrated" title="Direct link to heading">​</a></h3><p>The <code>locked&lt;&gt;locked</code> and <code>unlocked&lt;&gt;unlocked</code> migration utilizes a subset of actions
that were taken in the superfluid migration. The Lockup module account that was
holding the original GAMM shares sends them back to the user, deleting the GAMM
lock in the process. These shares are used to claim the underlying two assets
from the GAMM pool, which are then immediately put into a full range Concentrated
Liquidity position in the canonical Concentrated Liquidity pool.</p><p>If it was previously locked, we keep the concentrated locked for the same period
of time. If it was previously unlocking, we begin unlocking the concentrated lock
from where the GAMM lock left off.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="balancer-to-concentrated-with-no-lock">Balancer to Concentrated with No Lock<a class="hash-link" href="#balancer-to-concentrated-with-no-lock" title="Direct link to heading">​</a></h3><p>When GAMM shares are not locked, they are simply claimed for the underlying two
assets, which are then immediately put into a full range concentrated liquidity
position in the canonical concentrated liquidity pool. No locks are involved in
this migration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="position-fungification">Position Fungification<a class="hash-link" href="#position-fungification" title="Direct link to heading">​</a></h2><p>There is a possibility to fungify fully-charged positions within the same tick range.
Assume that there are two positions in the same tick range and both are fully charged.</p><p>As a user, I might want to combine them into a single position so that I don&#x27;t have to manage
positions inside the same tick range separately.</p><p>Therefore, I execute <code>MsgFungifyChargedPositions</code> that takes a list of position ids to fungify
and merges them into one.</p><p>Besides being fully charged, all of the positions must be in the same tick range and have the same
owner (sender). All must belong to the same pool and be unlocked. As a result, none of the positions
can be superfluid staked if they are full-range.</p><p>Once the message finishes, the user will have a completely new position with spread factors and incentive rewards
moved into the new position. The old positions will be deleted.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="swapping-appendix-a-example">Swapping. Appendix A: Example<a class="hash-link" href="#swapping-appendix-a-example" title="Direct link to heading">​</a></h2><p>Note, that the numbers used in this example are not realistic. They are used to
illustrate the concepts on the high level.</p><p>Imagine a tick range from min tick -1000 to max tick 1000 in a pool with a 1%
spread factor.</p><p>Assume that user A created a full range position from ticks -1000 to 1000 for
<code>10_000</code> liquidity units.</p><p>Assume that user B created a narrow range position from ticks 0 to 100 for <code>1_000</code>
liquidity units.</p><p>Assume the current active tick is -34 and user perform a swap in the positive
direction of the tick range by swapping 5_000 tokens one in for some tokens
zero out.</p><p>Our tick range and liquidity graph now looks like this:</p><div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">         cur_sqrt_price      //////////               &lt;--- position by user B</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/////////////////////////////////////////////////////////  &lt;---position by user A</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-1000           -34          0       100              1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The swap state is initialized as follows:</p><ul><li><code>amountSpecifiedRemaining</code> is set to 5_000 tokens one in specified by the user.</li><li><code>amountCalculated</code> is set to zero.</li><li><code>sqrtPrice</code> is set to the current sqrt price of the pool
(computed from the tick -34)</li><li><code>tick</code> is set to the current tick of the pool (-34)</li><li><code>liquidity</code> is set to the current liquidity tracked by the pool at tick -34 (10_000)</li><li><code>spreadRewardGrowthGlobal</code> is set to (0)</li></ul><p>We proceed by getting the next initialized tick in the direction of the swap (0).</p><p>Each initialized tick has 2 fields:</p><ul><li><p><code>liquidity_gross</code> - this is the total liquidity referencing that tick
at tick -1000: 10_000
at tick 0: 1_000
at tick 100: 1_000
at tick 1000: 10_000</p></li><li><p><code>liquidity_net</code> - liquidity that needs to be added to the active liquidity as
we cross the tick moving in the positive direction so that the active liquidity
is always the sum of all <code>liquidity_net</code> amounts of initialized ticks below the
current one.
at tick -1000: 10_000
at tick 0: 1_000
at tick 100: -1_000
at tick 1000: -10_000</p></li></ul><p>Next, we compute swap step from tick -34 to tick 0. Assume that 5_000 tokens one
in is more than enough to cross tick 0 and it returns 10_000 of token zero out
while consuming half of token one in (2500).</p><p>Now, we update the swap state as follows:</p><ul><li><p><code>amountSpecifiedRemaining</code> is set to 5000 - 2_500 = 2_500 tokens one in remaining.</p></li><li><p><code>amountCalculated</code> is set to 10_000 tokens zero out calculated.</p></li><li><p><code>sqrtPrice</code> is set to the sqrt price of the crossed initialized tick 0 (0).</p></li><li><p><code>tick</code> is set to the tick of the crossed initialized tick 0 (0).</p></li><li><p><code>liquidity</code> is set to the old liquidity value (10_000) + the <code>liquidity_net</code>
of the crossed tick 0 (1_000) = 11_000.</p></li><li><p><code>spreadRewardGrowthGlobal</code> is set to 2_500 <!-- -->*<!-- --> 0.01 / 10_000 = 0.0025 because we assumed
1% spread factor.</p></li></ul><p>Now, we proceed by getting the next initialized tick in the direction of
the swap (100).</p><p>Next, we compute swap step from tick 0 to tick 100. Assume that 2_500 remaining
tokens one in is not enough to reach the next initialized tick 100 and it returns
12_500 of token zero out while only reaching tick 70. The reason why we now get a
greater amount of token zero out for the same amount of token one in is because the
liquidity in this tick range is greater than the liquidity in the previous tick range.</p><p>Now, we update the swap state as follows:</p><ul><li><p><code>amountSpecifiedRemaining</code> is set to 2_500 - 2_500 = 0 tokens one in remaining.</p></li><li><p><code>amountCalculated</code> is set to 10_000 + 12_500 = 22_500 tokens zero out calculated.</p></li><li><p><code>sqrtPrice</code> is set to the reached sqrt price.</p></li><li><p><code>tick</code> is set to an uninitialized tick associated with the reached sqrt price (70).</p></li><li><p><code>liquidity</code> is set kept the same as we did not cross any initialized tick.</p></li><li><p><code>spreadRewardGrowthGlobal</code> is updated to 0.0025 + (2_500 <!-- -->*<!-- --> 0.01 / 10_000) = 0.005
because we assumed 1% spread factor.</p></li></ul><p>As a result, we complete the swap having swapped 5_000 tokens one in for 22_500
tokens zero out. The tick is now at 70 and the current liquidity at the active
tick tracked by the pool is 11_000. The global spread reward growth per unit of liquidity
has increased by 50 units of token one. See more details about the spread reward growth
in the &quot;Spread Rewards&quot; section.</p><p>TODO: Swapping, Appendix B: Compute Swap Step Internals and Math</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="range-orders">Range Orders<a class="hash-link" href="#range-orders" title="Direct link to heading">​</a></h2><blockquote><p>As a trader, I want to be able to execute ranger orders so that I have better
control of the price at which I trade</p></blockquote><p>TODO</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spread-rewards">Spread Rewards<a class="hash-link" href="#spread-rewards" title="Direct link to heading">​</a></h2><blockquote><p>As a an LP, I want to earn spread rewards on my capital so that I am incentivized to
participate in active market making.</p></blockquote><p>In Balancer-style pools, spread rewards go directly back into the pool to benefit all LPs pro-rata.
For concentrated liquidity pools, this approach is no longer feasible due to the
non-fungible property of positions. As a result, we use a different accumulator-based
mechanism for tracking and storing spread rewards.</p><p>Reference the following papers for more information on the inspiration behind our accumulator package:</p><ul><li><a href="https://uploads-ssl.webflow.com/5ad71ffeb79acc67c8bcdaba/5ad8d1193a40977462982470_scalable-reward-distribution-paper.pdf" target="_blank" rel="noopener noreferrer">Scalable Reward Distribution</a></li><li><a href="https://drops.dagstuhl.de/opus/volltexte/2020/11974/pdf/OASIcs-Tokenomics-2019-10.pdf" target="_blank" rel="noopener noreferrer">F1 Fee Distribution</a></li></ul><p>We define the following accumulator and spread-reward-related fields to be stored on various
layers of state:</p><ul><li><strong>Per-pool</strong></li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// Note that this is proto-generated.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> Pool </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SpreadFactor sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Each pool is initialized with a static spread factor value <code>SpreadFactor</code> to be paid by swappers.
Additionally, each pool&#x27;s spread reward accumulator tracks and stores the total rewards accrued from spreads
throughout its lifespan, named <code>SpreadRewardGrowthGlobal</code>.</p><ul><li><strong>Per-tick</strong></li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// Note that this is proto-generated.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">type</span><span class="token plain"> TickInfo </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   SpreadRewardGrowthOppositeDirectionOfLastTraversal sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DecCoins</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TickInfo keeps a record of spread rewards accumulated opposite the direction the tick was last traversed.
In other words, when traversing the tick from right to left, <code>SpreadRewardGrowthOppositeDirectionOfLastTraversal</code>
represents the spread rewards accumulated above that tick. When traversing the tick from left to right,
<code>SpreadRewardGrowthOppositeDirectionOfLastTraversal</code> represents the spread rewards accumulated below that tick.</p><p><img loading="lazy" alt="Tick Updates" src="/assets/images/TickUpdates-6daa2a655ccde2ebf1215f78c4232e84.png" width="2850" height="1974" class="img_ev3q"></p><p>This information is required for calculating the amount of spread rewards that accrue between
a range of two ticks.</p><p>Note that keeping track of the spread reward growth is only necessary for the ticks that
have been initialized. In other words, at least one position must be referencing
that tick to require tracking the spread reward growth occurring in that tick.</p><p>By convention, when a new tick is activated, it is set to the pool&#x27;s <code>SpreadRewardGrowthGlobal</code>
if the tick being initialized is above the current tick.</p><p>See the following code snippet:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> tickIndex </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> currentTick </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  accum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetSpreadRewardAccumulator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> poolId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  tickInfo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SpreadRewardGrowthBelow </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> accum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Essentially, setting the tick&#x27;s <code>tickInfo.SpreadRewardGrowthOppositeDirectionOfLastTraversal</code>
to the pools accum value represents the amount of spread rewards collected by the pool up until
the tick was activated.</p><p>Once a tick is activated again (crossed in either direction),
<code>tickInfo.SpreadRewardGrowthOppositeDirectionOfLastTraversal</code> is updated to add the difference
between the pool&#x27;s current accumulator value and the old value of
<code>tickInfo.SpreadRewardGrowthOppositeDirectionOfLastTraversal</code>.</p><p>Tracking how many spread rewards are collected below, in the case of a lower tick, and above,
in the case of an upper tick, allows us to calculate the
amount of spread rewards inside a position (spread reward growth inside between two ticks) on demand.
This is done by updating the activated tick with the amount of spread rewards collected for
every tick lower than the tick that is being crossed.</p><p>This has two benefits:</p><ul><li>We avoid updating <em>all</em> ticks</li><li>We can calculate a range by subtracting the upper and lower ticks for the range
using the logic below.</li></ul><p>We calculate the spread reward growth above the upper tick in the following way:</p><ul><li>If calculating spread reward growth for an upper tick, we consider the following two cases:<ul><li>currentTick &gt;= upperTick: If the current tick is greater than or equal to the
upper tick, the spread reward growth would be the pool&#x27;s spread reward growth minus the upper tick&#x27;s</li><li>currentTick &lt; upperTick: If the current tick is smaller than the upper tick,
the spread reward growth would be the upper tick&#x27;s spread reward growth outside.</li></ul></li></ul><p>This process is vice versa for calculating spread reward growth below the lower tick.</p><p>Now, by having the spread reward growth below the lower and above the upper tick of a range,
we can calculate the spread reward growth inside the range by subtracting the two from the
global per-unit-of-liquidity spread reward growth.</p><p><img loading="lazy" alt="Spread Reward Growth Outside Calculations" src="/assets/images/SpreadRewardGrowthOutsideCalcuations-6ab1e9fc131fcb9ef740d25fb970bbfb.png" width="2693" height="2662" class="img_ev3q"></p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">spreadRewardGrowthInsideRange </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> SpreadRewardGrowthGlobalOutside </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> spreadRewardGrowthBelowLowerTick </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> spreadRewardGrowthAboveUpperTick</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that although <code>tickInfo.SpreadRewardGrowthOutside</code> may be initialized at different times
for each tick, the comparison of these values between ticks is not meaningful, and
there is no guarantee that the values across ticks will follow any particular pattern.
However, this does not affect the per-position calculations since all the position
needs to know is the spread reward growth inside the position&#x27;s range since the position was
last interacted with.</p><ul><li><strong>Per-position-accumulator</strong></li></ul><p>In a concentrated liquidity pool, unlike traditional pools, spread rewards do not get automatically
re-added to pool. Instead, they are tracked by the <code>unclaimedRewards</code> fields of each
position&#x27;s accumulator.</p><p>The amount of uncollected spread rewards needs to be calculated every time a user modifies
their position. This occurs when a position is created, and liquidity is removed
(liquidity added is analogous to creating a new position).</p><p>We must recalculate the values for any modification, because with a change in liquidity
for the position, the amount of spread rewards allocated to the position must also change accordingly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="collecting-spread-rewards">Collecting Spread Rewards<a class="hash-link" href="#collecting-spread-rewards" title="Direct link to heading">​</a></h2><p>Once calculated, collecting spread rewards is a straightforward process of transferring the
calculated amount from the pool address to the position owner.</p><p>To collect spread rewards, users call <code>MsgCollectSpreadRewards</code> with the ID corresponding to
their position. The function <code>collectSpreadRewards</code> in the keeper is responsible for
executing the spread reward collection and returning the amount collected, given the owner&#x27;s
address and the position ID:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">k Keeper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">collectSpreadRewards</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ctx sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    owner sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AccAddress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    positionId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Coins</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This returns the amount of spread rewards collected by the user.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="swaps-1">Swaps<a class="hash-link" href="#swaps-1" title="Direct link to heading">​</a></h2><p>Swapping within a single tick works as the regular <code>xy = k</code> curve. For swaps
across ticks to work, we simply apply the same spread reward calculation logic for every swap step.</p><p>Consider data structures defined above. Let <code>tokenInAmt</code> be the amount of token being
swapped in.</p><p>Then, to calculate the spread reward within a single tick, we perform the following steps:</p><ol><li>Calculate an updated <code>tokenInAmtAfterSpreadReward</code> by charging the <code>pool.SpreadFactor</code> on <code>tokenInAmt</code>.</li></ol><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// Update global spread reward accumulator tracking spread rewards for denom of tokenInAmt.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// TODO: revisit to make sure if truncations need to happen.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SpreadRewardGrowthGlobalOutside</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">TokenX </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SpreadRewardGrowthGlobalOutside</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">TokenX</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenInAmt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Mul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SpreadFactor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// Update tokenInAmt to account for spread factor.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">spread_factor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenInAmt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Mul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SpreadFactor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Ceil</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tokenInAmtAfterSpreadFactor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenInAmt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Sub</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">spread_factor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bankKeeper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">SendCoins</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> swapper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">GetAddress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">// send tokenInAmtAfterSpreadFactor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Proceed to calculating the next square root price by utilizing the updated `tokenInAmtAfterSpreadFactor.</li></ol><p>Depending on which of the tokens in <code>tokenIn</code>,</p><p>If token1 is being swapped in:
$$\Delta \sqrt P = \Delta y / L$$</p><p>Here, <code>tokenInAmtAfterSpreadFactor</code> is delta y.</p><p>If token0 is being swapped in:
$$\Delta \sqrt P = L / \Delta x$$</p><p>Here, <code>tokenInAmtAfterSpreadFactor</code> is delta x.</p><p>Once we have the updated square root price, we can calculate the amount of
<code>tokenOut</code> to be returned. The returned <code>tokenOut</code> is computed with spread rewards
accounted for given that we used <code>tokenInAmtAfterSpreadFactor</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="swap-step-spread-factors">Swap Step Spread Factors<a class="hash-link" href="#swap-step-spread-factors" title="Direct link to heading">​</a></h2><p>We have a notion of <code>swapState.amountSpecifiedRemaining</code> which is the amount of
token in remaining over all swap steps.</p><p>After performing the current swap step, the following cases are possible:</p><ol><li>All amount remaining is consumed</li></ol><p>In that case, the spread factor is equal to the difference between the original amount remaining
and the one actually consumed. The difference between them is the spread factor.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">spreadRewardChargeTotal </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> amountSpecifiedRemaining</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Sub</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">amountIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Did not consume amount remaining in-full.</li></ol><p>The spread factor is charged on the amount actually consumed during a swap step.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">spreadRewardChargeTotal </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> amountIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Mul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">spreadFactor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Price impact protection makes it exit before consuming all amount remaining.</li></ol><p>The spread factor is charged on the amount in actually consumed before price impact
protection got triggered.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">spreadRewardChargeTotal </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> amountIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">Mul</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">spreadFactor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="incentiveliquidity-mining-mechanism">Incentive/Liquidity Mining Mechanism<a class="hash-link" href="#incentiveliquidity-mining-mechanism" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>Due to the nonfungibility of positions and ticks, incentives for concentrated liquidity requires a
slightly different mechanism for distributing incentives compared to Balancer and Stableswap pools.
In general, the design space of incentive mechanisms for concentrated liquidity DEXs is extremely
underexplored, so our implementation takes this as an opportunity to break some new ground in the
broader design space of order-book-style AMMs.</p><p>Below, we outline the approach for CL incentives that Osmosis will be implementing for its initial
implementation of concentrated liquidity, as well as our baseline reasoning for why we are pursuing
this design.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="target-properties">Target Properties<a class="hash-link" href="#target-properties" title="Direct link to heading">​</a></h2><p>As a starting point, it&#x27;s important to understand the properties of a healthy liquidity pool.
These are all, of course, properties that become self-sustaining once the positive feedback cycle
between liquidity and volume kicks off, but for the sake of understanding what exactly it is that
we are trying to bootstrap with incentives it helps to be explicit with our goals.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity-depth">Liquidity Depth<a class="hash-link" href="#liquidity-depth" title="Direct link to heading">​</a></h3><p>We want to ensure spread rewards and incentives are being used to maximize liquidity depth at the active tick
(i.e. the tick the current spot price is in), as this gives the best execution price for trades on
the pool.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity-breadth">Liquidity Breadth<a class="hash-link" href="#liquidity-breadth" title="Direct link to heading">​</a></h3><p>It is critical that as we roll out concentrated liquidity, there is an incentive for there to be
width in the books for our major pools. This is to avoid the scenario where the liquidity in the
active tick gets filled and liquidity falls off a cliff (e.g. when there is a large price move and
active tick LPs get bulk arbed against). It is important for our liquidity base to be broad when it
is low until our CL markets mature and active LPs begin participating.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity-uptime">Liquidity Uptime<a class="hash-link" href="#liquidity-uptime" title="Direct link to heading">​</a></h3><p>We want to ensure that the active tick is not only liquid, but that it is <em>consistently</em> liquid,
meaning that liquidity providers are incentivized to keep their liquidity on the books while
they trade.</p><p>Specifically, we want to ensure that idle liquidity waiting for volume does not sit off the
books with the goal of jumping in when a trade happens, as this makes Osmosis&#x27;s liquidity
look thinner than it is and risks driving volume to other exchanges.</p><p>While just-in-time (JIT) liquidity technically benefits the trader on a first-degree basis
(better price execution for that specific trade), it imposes a cost on the whole system by
pushing LPs to an equilibrium that ultimately hurts the DEX (namely that liquidity stays of
the books until a trade happens). This instance of <a href="https://en.wikipedia.org/wiki/Braess%27s_paradox" target="_blank" rel="noopener noreferrer">Braess&#x27;s paradox</a>
can be remedied with mechanisms designed around rewarding liquidity uptime.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-standard-pro-rata-in-active-tick">Current Standard: Pro-rata in Active Tick<a class="hash-link" href="#current-standard-pro-rata-in-active-tick" title="Direct link to heading">​</a></h2><p>The current status quo for concentrated liquidity incentives is to distribute them pro-rata
to all LPs providing liquidity in the active tick. With
some <a href="https://www.paradigm.xyz/2021/05/liquidity-mining-on-uniswap-v3" target="_blank" rel="noopener noreferrer">clever accumulator tricks</a>,
this can be designed to ensure that each LP only receives incentives for liquidity they contribute
to the active tick. This approach is incredible for liquidity depth, which is arguably the most
important property we need incentives to be able to accommodate. It is also a user flow that
on-chain market makers are already somewhat familiar with and has enough live examples where
we roughly know that it functions as intended.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="our-implementation">Our Implementation<a class="hash-link" href="#our-implementation" title="Direct link to heading">​</a></h2><p>At launch, Osmosis&#x27;s CL incentives will primarily be in the format described above while we
iron out a mechanism that achieves the remaining two properties predictably and effectively.
As a piece of foreshadowing, the primary problem space we will be tackling is the following:
status quo incentives advantage LPs who keep their liquidity off the books until a trade
happens, ultimately pushing liquidity off of the DEX and creating ambiguity around the &quot;real&quot;
liquidity depth. This forces traders to make uninformed decisions about where to trade their
assets (or worse, accept worse execution on an inferior venue).</p><p>In other words, instead of having incentives go towards bootstrapping healthy liquidity pools,
they risk going towards adversely pushing volume to other exchanges at the cost of the DEX,
active LPs, and ultimately traders.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="note-on-supported-and-authorized-uptimes">Note on supported and authorized uptimes<a class="hash-link" href="#note-on-supported-and-authorized-uptimes" title="Direct link to heading">​</a></h3><p>If you dig through our incentives logic, you might find code dealing with notions of <strong>Supported Uptimes</strong>
and <strong>Authorized Uptimes</strong>. These are for an uptime incentivization mechanism we are keeping off
at launch while we refine a more sophisticated version. We leave the state-related parts
in core logic to ensure that if we do decide to turn the feature on (even if just to
experiment), it could be done by a simple governance proposal (to add more supported
uptimes to the list of authorized uptimes) and not require a state migration for pools.
At launch, only the 1ns uptime will be authorized, which is roughly equivalent to status
quo CL incentives with the small difference that positions that are created and closed in
the same block are not eligible for any incentives.</p><p>For the sake of clarity, this mechanism functions very similarly to status quo incentives,
but it has a separate accumulator for each supported uptime and ensures that only liquidity
that has been in the pool for the required amount of time qualifies for claiming incentives.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="incentive-creation-and-querying">Incentive Creation and Querying<a class="hash-link" href="#incentive-creation-and-querying" title="Direct link to heading">​</a></h3><p>While it is technically possible for Osmosis to enable the creation of incentive records directly in the CL module, incentive creation is currently funneled through existing gauge infrastructure in the <code>x/incentives</code> module. This simplifies UX drastically for frontends, external incentive creators, and governance, while making CL incentives fully backwards-compatible with incentive creation and querying flows that everyone is already used to. As of the initial version of Osmosis&#x27;s CL, all incentive creation and querying logic will be handled by respective gauge functions (e.g. the <code>IncentivizedPools</code> query in the <code>x/incentives</code> module will include CL pools that have internal incentives on them).</p><p>To create a gauge dedicated to the concentrated liquidity pool, run a <code>MsgCreateGauge</code> message in the <code>x/incentives</code> module with the following parameter constraints:</p><ul><li><code>PoolId</code>: The ID of the CL pool to create a gauge for.</li><li><code>DistrTo.LockQueryType</code> must be set to <code>locktypes.LockQueryType.NoLock</code></li><li><code>DistrTo.Denom</code> must be an empty string.</li></ul><p>The rest of the parameters can be set according to the desired configuration of the gauge. Please read the <code>x/incentives</code> module documentation for more information on how to configure gauges.</p><p>Note, that the created gauge will start emitting at the first epoch after the given <code>StartTime</code>. During the epoch, a <code>x/concentrated-liquidity</code>
module <code>IncentiveRecord</code> will be created for every denom in the gauge. This incentive record will be configured to emit all given incentives
over the period of an epoch. If the gauge is non-perpetual (emits over several epochs), the distribution will be split evenly between the epochs.
and a new <code>IncentiveRecord</code> will be created for each denom every epoch with the emission rate and token set to finish emitting at the end of the epoch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reward-splitting-between-classic-and-cl-pools">Reward Splitting Between Classic and CL pools<a class="hash-link" href="#reward-splitting-between-classic-and-cl-pools" title="Direct link to heading">​</a></h3><p>While we want to nudge Classic pool LPs to transition to CL pools, we also want to ensure that we do not have a hard cutoff for incentives where past a certain point it is no longer worth it to provide liquidity to Classic pools. This is because we want to ensure that we have a healthy transition period where liquidity is not split between Classic and CL pools, but rather that liquidity is added to CL pools while Classic pools are slowly drained of liquidity.</p><p>To achieve this in a way that is difficult to game and efficient for the chain to process, we will be using a <strong>reward-splitting</strong> mechanism that treats <em>bonded</em> liquidity in a Classic pool that is paired by governance to a CL pool (e.g. for the purpose of migration) as a single full-range position on the CL pool for the purpose of calculating incentives. Note that this <em>does not affect spread reward distribution</em> and only applies to the flow of incentives through a CL pool.</p><p>One implication of this mechanism is that it moves the incentivization process to a higher level of abstraction (incentivizing <em>pairs</em> instead of <em>pools</em>). For internal incentives (which are governance managed), this is in line with the goal of continuing to push governance to require less frequent actions, which this change ultimately does.</p><p>To keep a small but meaningful incentive for LPs to still migrate their positions, we have added a <strong>discount rate</strong> to incentives that are redirected to Classic pools. This is initialized to 5% by default but is a governance-upgradable parameter that can be increased in the future. A discount rate of 100% is functionally equivalent to all the incentives staying in the CL pool.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="twap-integration">TWAP Integration<a class="hash-link" href="#twap-integration" title="Direct link to heading">​</a></h2><p>In the context of twap, concentrated liquidity pools function differently from
CFMM pools.</p><p>There are 2 major differences that stem from how the liquidity is added and
removed in concentrated-liquidity.</p><p>The first one is given by the fact that a user does not provide liquidity at
pool creation time. Instead, they have to issue a separate message post-pool
creation. As a result, there can be a time where there is no valid spot price
initialized for a concentrated liquidity pool. When a concentrated liquidity pool
is created, the <code>x/twap</code> module still initializes the twap records. However, these
records are invalidated by setting the &quot;last error time&quot; field to the block time
at pool creation. Only adding liquidity to the pool will initialize the spot price
and twap records correctly. One technical detail to note is that adding liquidity
in the same block as pool creation will still set the &quot;last error time&quot; field to
the block time despite spot price already being initialized. Although we fix an
error within that block, it still occurs. As a result, this is deemed acceptable.
However, this is a technical trade-off for implementation simplicity and not an
intentional design decision.</p><p>The second difference from balancer pools is focused around the fact that
liquidity can be completely removed from a concentrated liquidity pool,
making its spot price be invalid.</p><p>To recap the basic LP functionality in concentrated liquidity, a user adds
liqudity by creating a position. To remove liquidity, they withdraw their
position. Contrary to CFMM pools, adding or removing liquidity does not affect
the price in 99% of the cases in concentrated liquidity. The only two exceptions
to this rule are:</p><p><strong>Creating the first position in the pool.</strong></p><p>In this case, we transition from invalid state where there is no liqudity, and
the spot price is uninitialized to the state where there is some liqudity, and
as a result a valid spot price.</p><p>Note, that if there is a pool where liqudiity is completely drained and re-added,
the TWAP&#x27;s last error time will be pointing at the time when the liquidity was drained.
This is different from how twap functions in CFMM pool where liquidity cannot
be removed in-full.</p><p><strong>Removing the last position in the pool.</strong></p><p>In this case, we transition from a valid state with liquidity and spot price to
an invalid state where there is no liquidity and, as a result, no valid spot
price anymore. The last spot price error will be set to the block time of when
the last position was removed.</p><p>To reiterate, the above two exceptions are the only cases where twap is updated
due to adding or removing liquidity.</p><p>The major source of updates with respect to twap is the swap logic. It functions
similarly to CFMM pools where upon the completion of a swap, a listener <code>AfterConcentratedPoolSwap</code>
propagates the execution to the twap module for the purposes of tracking state updates
necessary to retrieve the spot price and update the twap accumulators
(more details in x/twap module).</p><p>Lastly, see the &quot;Listeners&quot; section for more details on how twap is enabled by
the use of these hooks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameters">Parameters<a class="hash-link" href="#parameters" title="Direct link to heading">​</a></h2><ul><li><code>AuthorizedQuoteDenoms</code> []string</li></ul><p>This is a list of quote denoms that can be used as token1 when creating a pool.
We limit the quote assets to a small set for the purposes of having convenient
price increments stemming from tick to price conversion. These increments are
in a human readable magnitude only for token1 as a quote. For limit orders in
the future, this will be a desirable property in terms of UX as to allow users
to set limit orders at prices in terms of token1 (quote asset) that are easy
to reason about.</p><p>This goes in-hand with centralized exchanges that limit the quote asset set
to only a few denoms.</p><p>Our list at launch is expected to consist of OSMO, DAI and USDC. These are set
in the v16 upgrade handler.</p><ul><li><code>IsPermisionlessPoolCreationEnabled</code> bool</li></ul><p>The flag indicating whether permissionless pool creation is enabled or not. For
launch, we have decided to disable permissionless pool creation. It will still
be enabled via governance. This is because we want to limit the number of pools
for risk management and want to avoid fragmenting liquidity for major denom
pairs with configurations of tick spacing that are not ideal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="listeners">Listeners<a class="hash-link" href="#listeners" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afterconcentratedpoolcreated"><code>AfterConcentratedPoolCreated</code><a class="hash-link" href="#afterconcentratedpoolcreated" title="Direct link to heading">​</a></h3><p>This listener executes after the pool is created.</p><p>At the time of this writing, it is only utilized by the <code>x/twap</code> module.
The twap module is expected to create twap records where the last error time
is set to the block time of when the pool was created. This is because there
is no liquidity in the pool at creation time.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afterinitialpoolpositioncreated"><code>AfterInitialPoolPositionCreated</code><a class="hash-link" href="#afterinitialpoolpositioncreated" title="Direct link to heading">​</a></h3><p>This listener executes after the first position is created in a concentrated
liquidity pool.</p><p>At the time of this writing, it is only utilized by the <code>x/twap</code> module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afterlastpoolpositionremoved"><code>AfterLastPoolPositionRemoved</code><a class="hash-link" href="#afterlastpoolpositionremoved" title="Direct link to heading">​</a></h3><p>This listener executes after the last position is removed in a concentrated
liquidity pool.</p><p>At the time of this writing, it is only utilized by the <code>x/twap</code> module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afterconcentratedpoolswap"><code>AfterConcentratedPoolSwap</code><a class="hash-link" href="#afterconcentratedpoolswap" title="Direct link to heading">​</a></h3><p>This listener executes after a swap in a concentrated liquidity pool.</p><p>At the time of this writing, it is only utilized by the <code>x/twap</code> module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-entries-and-kv-store-management">State entries and KV store management<a class="hash-link" href="#state-entries-and-kv-store-management" title="Direct link to heading">​</a></h3><p>The following are the state entries (key and value pairs) stored for the concentrated liquidity module. </p><ul><li>structs<ul><li>TickPrefix + pool ID + tickIndex ➝ Tick Info struct</li><li>PoolPrefix + pool id ➝ pool struct</li><li>IncentivePrefix | pool id | min uptime index | denom | addr ➝ Incentive Record body struct</li></ul></li><li>links<ul><li>positionToLockPrefix | position id ➝ lock id</li><li>lockToPositionPrefix | lock id ➝ position id</li><li>PositionPrefix | addr bytes | pool id | position id ➝ boolean</li><li>PoolPositionPrefix | pool id | position id ➝ boolean</li></ul></li></ul><p>Note that for storing ticks, we use 9 bytes instead of directly using uint64, first byte being reserved for the Negative / Positive prefix, and the remaining 8 bytes being reserved for the tick itself, which is of uint64. Although we directly store signed integers as values, we use the first byte to indicate and re-arrange tick indexes from negative to positive.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state-and-keys">State and Keys<a class="hash-link" href="#state-and-keys" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="incentive-records">Incentive Records<a class="hash-link" href="#incentive-records" title="Direct link to heading">​</a></h3><ul><li><code>KeyIncentiveRecord</code></li></ul><p><code>0x04|</code> || <code>string encoding of pool ID</code> || <code>|</code> || <code>string encoding of min uptime index</code> || <code>|</code> || <code>string encoding of incentive ID</code></p><p>Note that the reason for having pool ID and min uptime index is so that we can retrieve
all incentive records for a given pool ID and min uptime index by performing prefix iteration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="precision-issues-with-price">Precision Issues With Price<a class="hash-link" href="#precision-issues-with-price" title="Direct link to heading">​</a></h2><p>There are precision issues that we must be considerate of in our design.</p><p>Consider the balancer pool between <code>arb</code> base unit and <code>uosmo</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">osmosisd q gamm pool </span><span class="token number" style="color:rgb(181, 206, 168)">1011</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">pool:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;@type&#x27;</span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">:</span><span class="token plain"> /osmosis.gamm.v1beta1.Pool</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  address: osmo1pv6ffw8whyle2nyxhh8re44k4mu4smqd7fd66cu2y8gftw3473csxft8y5</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  future_pool_governor: 24h</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  id: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1011&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  pool_assets:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  - token:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      amount: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;101170077995723619690981&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      denom: ibc/10E5E5B06D78FFBB61FD9F89209DEE5FD4446ED0550CBB8E3747DA79E10D9DC6</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    weight: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;536870912000000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  - token:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      amount: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;218023341414&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      denom: uosmo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    weight: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;536870912000000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  pool_params:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    exit_fee: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0.000000000000000000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    smooth_weight_change_params: null</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    swap_fee: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0.002000000000000000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  total_shares:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    amount: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;18282469846754434906194&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    denom: gamm/pool/1011</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  total_weight: </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1073741824000000&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s say we want to migrate this into a CL pool where <code>uosmo</code> is the quote
asset and <code>arb</code> base unit is the base asset.</p><p>Note that quote asset is denom1 and base asset is denom0.
We want quote asset to be <code>uosmo</code> so that limit orders on ticks
have tick spacing in terms of <code>uosmo</code> as the quote.</p><p>Note:</p><ul><li>OSMO has precision of 6. 1 OSMO = 10**6 <code>uosmo</code></li><li>ARB has precision of 18. 1 ARB = 10**18 <code>arb</code> base unit</li></ul><p>Therefore, the true price of the pool is:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">&gt;&gt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">218023341414</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:rgb(181, 206, 168)">6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">101170077995723619690981</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:rgb(181, 206, 168)">18</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token number" style="color:rgb(181, 206, 168)">2.1550180224553714</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, in our core logic it is represented as:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token number" style="color:rgb(181, 206, 168)">218023341414</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">101170077995723619690981</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token number" style="color:rgb(181, 206, 168)">2.1550180224553714e-12</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">osmosisd q gamm spot</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">price </span><span class="token number" style="color:rgb(181, 206, 168)">1011</span><span class="token plain"> uosmo ibc</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">10E5E5B06D78FFBB61FD9F89209DEE5FD4446ED0550CBB8E3747DA79E10D9DC6</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">spot_price</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0.000000000002155018&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As a protocol, we need to accommodate prices that are very far apart.
In the example above, the difference between <code>10**6 and 10**18</code></p><p>Most of the native precision is 10<strong>6. However, most of the ETH
precision is 10</strong>18.</p><p>This starts to matter for assets such as <code>upepe</code>. That have
a precision of 18 and a very low price level relative to
the quote asset that has precision of 6 (e.g <code>uosmo</code> or <code>uusdc</code>).</p><p>The true price of PEPE in USDC terms is <code>0.0000009749</code>.</p><p>In the &quot;on-chain representation&quot;, this would be:
<code>0.0000009749 * 10**6 / 10**18 = 9.749e-19</code></p><p>Note that this is below the minimum precision of <code>sdk.Dec</code>.</p><p>Additionally, there is a problem with tick to sqrt price conversions
where at small price levels, two sqrt prices can map to the same
tick.</p><p>As a workaround, we have decided to limit min spot price to 10^-12
and min tick to <code>-108000000</code>. It has been shown at at price levels
below 10^-12, this issue is most apparent. See this issue for details:
<a href="https://github.com/osmosis-labs/osmosis/issues/5550" target="_blank" rel="noopener noreferrer">https://github.com/osmosis-labs/osmosis/issues/5550</a></p><p>Now, we have a problem that we cannot handle pairs where
the quote asset has a precision of 6 and the base asset has a
precision of 18.</p><p>Note that this is not a problem for pairs where the quote asset
has a precision of 18 and the base asset has a precision of 6.
E.g. OSMO/DAI.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a class="hash-link" href="#solution" title="Direct link to heading">​</a></h3><p>At launch, pool creation is permissioned. Therefore, we can
ensure correctness for the initial set of pools.</p><p>Long term, we will implement a wrapper contract around concentrated liquidity
that will handle the precision issues and scale the prices to all have a precision of at most 12.</p><p>The contract will have to handle truncation and rounding to determine
how to handle dust during this process. The truncated amount can be significant.
That being said, this problem is out of scope for this document.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="terminology">Terminology<a class="hash-link" href="#terminology" title="Direct link to heading">​</a></h2><p>We will use the following terms throughout the document and our codebase:</p><ul><li><p><code>Tick</code> - a unit that has a 1:1 mapping with price</p></li><li><p><code>Bucket</code> - an area between two initialized ticks.</p></li><li><p><code>Tick Range</code> - a general term to describe a concept with lower and upper bound.</p><ul><li>Position is defined on a tick range.</li><li>Bucket is defined on a tick range.</li><li>A trader performs a swap over a tick range.</li></ul></li><li><p><code>Tick Spacing</code> - the distance between two ticks that can be initialized. This is
what defines the minimum bucket size.</p></li></ul><p>Note that ticks are defined inside buckets. Assume tick spacing is 100. A liquidity provider
creates a position with amounts such that the current tick is 155 between ticks 100 and 200.</p><p>Note, that the current tick of 155 is defined inside the bucket over a range of 100 to 200.</p><ul><li><p><code>Initialized Tick</code> - a tick at which LPs can provide liquidity. Some ticks cannot be
initialized due to tick spacing. <code>MinCurrentTick</code> is an exception due to being 1 tick below
<code>MinInitializedTick</code>. Only initialized ticks are crossed during a swap (see &quot;Crossing Tick&quot;)
for details.</p></li><li><p><code>MinInitializedTick</code> - the minimum tick at which a position can be initialized. When this tick is
crossed, all liquidity is consumed at the tick ends up on <code>MinCurrentTick</code>. At that point, there
is no liquidity and the pool is in no bucket. To enter the first bucket, a swap right must be done
to cross the next initialized tick and kick in the liquidity. If at least one full range position is
defined, <code>MinInitializedTick</code> will be the first such tick.</p></li><li><p><code>MinCurrentTick</code> - is the minimum value that a current tick can take. If we consume all liquidity and
cross the min initialized tick, our current tick will equal to MinInitializedTick - 1 (MinCurrentTick)
with zero liquidity. However, note that this <code>MinCurrentTick</code> cannot be crossed. If current tick equals
to this tick, it is only possible to swap in the right (one for zero) direction.</p></li><li><p>MaxTick<code>- is the maximum tick at which a position can be initialized. It is also the maximum value that
a current tick can be. Note that this is different from the</code>MinInitializedTick<code>and</code>MinCurrentTick<code>due
to our definition of the full range (see below). The full range is inclusive of the lower tick but exclusive
of the upper tick. As a result, we do not need to differentiate between the two for the max. When the pool
is on the</code>MaxTick<code>, there is no liquidity. To kick in the liquidity, a swap left must be done to cross
the </code>MaxTick` and enter the last bucket (when sequencing from left to right).</p></li><li><p><code>Initialized Range</code> - the range of ticks that can be initialized: <code>[MinInitializedTick, MaxTick]</code></p></li><li><p><code>Full Range</code> - the maximum range at which a position can be defined: <code>[MinInitializedTick, MaxTick)</code></p></li><li><p><code>Crossing Tick</code> - crossing a tick means leaving one bucket and entering another. Each tick has a liquidity
net value defined. This value measures &quot;how much of liquidity needs to be added to the current when crossing
a tick going left-to-right and entering a new bucket&quot;. This value is positive for lower ticks of a position
and negative for higher. When going left-to-right, instead of adding, we subtract this value from the current liquidity.
There are two edge cases. First, when pool crosses a <code>MinInitializedTick</code>, the pool does not enter any bucket.
since it is now outside of the <code>Full Range</code>. Second, when pool crossed a <code>MaxTick</code>, the pool does not enter
any bucket since it is now outside of the <code>Full Range</code>. Instead, we treat this being directly on either
the <code>MinCurrentTick</code> or <code>MaxTick</code>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="external-sources">External Sources<a class="hash-link" href="#external-sources" title="Direct link to heading">​</a></h2><ul><li><a href="https://uniswap.org/whitepaper-v3.pdf" target="_blank" rel="noopener noreferrer">Uniswap V3 Whitepaper</a></li><li><a href="https://atiselsts.github.io/pdfs/uniswap-v3-liquidity-math.pdf" target="_blank" rel="noopener noreferrer">Technical Note on Liquidity Math</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/osmosis-labs/docs/tree/main/docs/osmosis-core/modules/concentrated-liquidity/README.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/osmosis-core/modules"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osmosis-core/modules/cosmwasmpool"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CosmWasm Pool</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a></li><li><a href="#ticks" class="table-of-contents__link toc-highlight">Ticks</a><ul><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#geometric-tick-spacing-with-additive-ranges" class="table-of-contents__link toc-highlight">Geometric Tick Spacing with Additive Ranges</a></li><li><a href="#formulas" class="table-of-contents__link toc-highlight">Formulas</a></li><li><a href="#tick-spacing-example-tick-to-price" class="table-of-contents__link toc-highlight">Tick Spacing Example: Tick to Price</a></li><li><a href="#tick-spacing-example-price-to-tick" class="table-of-contents__link toc-highlight">Tick Spacing Example: Price to Tick</a></li></ul></li><li><a href="#choosing-an-exponent-at-price-one-value" class="table-of-contents__link toc-highlight">Choosing an Exponent At Price One Value</a><ul><li><a href="#example-1" class="table-of-contents__link toc-highlight">Example 1</a></li><li><a href="#example-2" class="table-of-contents__link toc-highlight">Example 2</a></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a></li></ul></li><li><a href="#concentrated-liquidity-module-messages" class="table-of-contents__link toc-highlight">Concentrated Liquidity Module Messages</a><ul><li><a href="#msgcreateposition" class="table-of-contents__link toc-highlight"><code>MsgCreatePosition</code></a></li><li><a href="#msgwithdrawposition" class="table-of-contents__link toc-highlight"><code>MsgWithdrawPosition</code></a></li><li><a href="#msgcreatepool" class="table-of-contents__link toc-highlight"><code>MsgCreatePool</code></a></li><li><a href="#msgcollectspreadrewards" class="table-of-contents__link toc-highlight"><code>MsgCollectSpreadRewards</code></a></li><li><a href="#msgfungifychargedpositions" class="table-of-contents__link toc-highlight"><code>MsgFungifyChargedPositions</code></a></li></ul></li><li><a href="#relationship-to-pool-manager-module" class="table-of-contents__link toc-highlight">Relationship to Pool Manager Module</a><ul><li><a href="#pool-creation" class="table-of-contents__link toc-highlight">Pool Creation</a></li><li><a href="#swaps" class="table-of-contents__link toc-highlight">Swaps</a></li></ul></li><li><a href="#liquidity-provision" class="table-of-contents__link toc-highlight">Liquidity Provision</a><ul><li><a href="#adding-liquidity" class="table-of-contents__link toc-highlight">Adding Liquidity</a></li><li><a href="#removing-liquidity" class="table-of-contents__link toc-highlight">Removing Liquidity</a></li></ul></li><li><a href="#swapping" class="table-of-contents__link toc-highlight">Swapping</a><ul><li><a href="#calculating-swap-amounts" class="table-of-contents__link toc-highlight">Calculating Swap Amounts</a></li></ul></li><li><a href="#migration" class="table-of-contents__link toc-highlight">Migration</a><ul><li><a href="#superfluid-delegated-balancer-to-concentrated" class="table-of-contents__link toc-highlight">Superfluid Delegated Balancer to Concentrated</a></li><li><a href="#superfluid-undelegating-balancer-to-concentrated" class="table-of-contents__link toc-highlight">Superfluid Undelegating Balancer to Concentrated</a></li><li><a href="#locked-and-unlocked-balancer-to-concentrated" class="table-of-contents__link toc-highlight">Locked and Unlocked Balancer to Concentrated</a></li><li><a href="#balancer-to-concentrated-with-no-lock" class="table-of-contents__link toc-highlight">Balancer to Concentrated with No Lock</a></li></ul></li><li><a href="#position-fungification" class="table-of-contents__link toc-highlight">Position Fungification</a></li><li><a href="#swapping-appendix-a-example" class="table-of-contents__link toc-highlight">Swapping. Appendix A: Example</a></li><li><a href="#range-orders" class="table-of-contents__link toc-highlight">Range Orders</a></li><li><a href="#spread-rewards" class="table-of-contents__link toc-highlight">Spread Rewards</a></li><li><a href="#collecting-spread-rewards" class="table-of-contents__link toc-highlight">Collecting Spread Rewards</a></li><li><a href="#swaps-1" class="table-of-contents__link toc-highlight">Swaps</a></li><li><a href="#swap-step-spread-factors" class="table-of-contents__link toc-highlight">Swap Step Spread Factors</a></li><li><a href="#incentiveliquidity-mining-mechanism" class="table-of-contents__link toc-highlight">Incentive/Liquidity Mining Mechanism</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#target-properties" class="table-of-contents__link toc-highlight">Target Properties</a><ul><li><a href="#liquidity-depth" class="table-of-contents__link toc-highlight">Liquidity Depth</a></li><li><a href="#liquidity-breadth" class="table-of-contents__link toc-highlight">Liquidity Breadth</a></li><li><a href="#liquidity-uptime" class="table-of-contents__link toc-highlight">Liquidity Uptime</a></li></ul></li><li><a href="#current-standard-pro-rata-in-active-tick" class="table-of-contents__link toc-highlight">Current Standard: Pro-rata in Active Tick</a></li><li><a href="#our-implementation" class="table-of-contents__link toc-highlight">Our Implementation</a><ul><li><a href="#note-on-supported-and-authorized-uptimes" class="table-of-contents__link toc-highlight">Note on supported and authorized uptimes</a></li><li><a href="#incentive-creation-and-querying" class="table-of-contents__link toc-highlight">Incentive Creation and Querying</a></li><li><a href="#reward-splitting-between-classic-and-cl-pools" class="table-of-contents__link toc-highlight">Reward Splitting Between Classic and CL pools</a></li></ul></li><li><a href="#twap-integration" class="table-of-contents__link toc-highlight">TWAP Integration</a></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li><li><a href="#listeners" class="table-of-contents__link toc-highlight">Listeners</a><ul><li><a href="#afterconcentratedpoolcreated" class="table-of-contents__link toc-highlight"><code>AfterConcentratedPoolCreated</code></a></li><li><a href="#afterinitialpoolpositioncreated" class="table-of-contents__link toc-highlight"><code>AfterInitialPoolPositionCreated</code></a></li><li><a href="#afterlastpoolpositionremoved" class="table-of-contents__link toc-highlight"><code>AfterLastPoolPositionRemoved</code></a></li><li><a href="#afterconcentratedpoolswap" class="table-of-contents__link toc-highlight"><code>AfterConcentratedPoolSwap</code></a></li><li><a href="#state-entries-and-kv-store-management" class="table-of-contents__link toc-highlight">State entries and KV store management</a></li></ul></li><li><a href="#state-and-keys" class="table-of-contents__link toc-highlight">State and Keys</a><ul><li><a href="#incentive-records" class="table-of-contents__link toc-highlight">Incentive Records</a></li></ul></li><li><a href="#precision-issues-with-price" class="table-of-contents__link toc-highlight">Precision Issues With Price</a><ul><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li></ul></li><li><a href="#terminology" class="table-of-contents__link toc-highlight">Terminology</a></li><li><a href="#external-sources" class="table-of-contents__link toc-highlight">External Sources</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="margin-bottom--sm"><a class="footerLogoLink_DDai" href="/"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="36px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="36px"></a></div><div class="footer__row"><div class="footer__data"><div class="footer__cta"></div></div><div class="links"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Launch App</a></li><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Portal</a></li><li class="footer__item"><a href="https://osmosis.zone/ecosystem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ecosystem</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://medium.com/@Osmosis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://commonwealth.im/osmosis/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community</a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Osmosis Labs since 2023. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b997ef34.js"></script>
<script src="/assets/js/main.ed1cf7f0.js"></script>
</body>
</html>
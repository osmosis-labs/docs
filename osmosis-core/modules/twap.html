<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-osmosis-core docs-doc-id-modules/twap/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">TWAP | Osmosis Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" name="twitter:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" property="og:url" content="https://docs.osmosis.zone/osmosis-core/modules/twap"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" property="og:title" content="TWAP | Osmosis Docs"><meta data-rh="true" name="description" content="Time Weighted Average Price"><meta data-rh="true" property="og:description" content="Time Weighted Average Price"><link data-rh="true" rel="icon" href="/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.osmosis.zone/osmosis-core/modules/twap"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/twap" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/twap" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://O18C1RUI3F-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Osmosis Docs" href="/opensearch.xml">









<link rel="preconnect" href="https://app.posthog.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,a){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==a?g=e[a]=[]:a="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)c(g,o[p]);e._i.push([r,s,a])},e.__SV=1)}(document,window.posthog||[]),posthog.init("00",{api_host:"https://app.posthog.com"})</script>

<script src="https://tally.so/widgets/embed.js"></script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="c5b5e9fc-d025-4c12-b08e-9784d0e2161f" data-project-name="Osmosis" data-project-color="#7900B4" data-project-logo="https://app.osmosis.zone/tokens/osmo.svg" async></script><link rel="stylesheet" href="/assets/css/styles.792232e5.css">
<link rel="preload" href="/assets/js/runtime~main.b997ef34.js" as="script">
<link rel="preload" href="/assets/js/main.ed1cf7f0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA" height="26px" width="114px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU" height="26px" width="114px"></div></a><a class="navbar__item navbar__link" href="/overview/educate">Overview</a><a class="navbar__item navbar__link" href="/overview/integrate">Integrate</a><a class="navbar__item navbar__link" href="/overview/validate">Validate &amp; Run your Node</a><a class="navbar__item navbar__link" href="/overview/endpoints">Endpoints</a><a class="navbar__item navbar__link" href="/overview/features">Features</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/osmosis-core">Develop</a><a href="https://github.com/osmosis-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon github-icon"></a><a href="https://discord.com/invite/osmosis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon discord-icon"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link dev-portal-signup dev-portal-link">Launch Dex<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_mhZE"><div class="multiSectionContainer_bYm7"><div class="section_olD1 sectionActive_D9yk" tabindex="0"><div>Osmosis Core</div><div><div class="row_KvCx"><button type="button" role="combobox" aria-controls="" aria-expanded="false" aria-autocomplete="none" aria-label="Select Section" class="sections-menu-trigger"><span style="pointer-events:none"></span><span aria-hidden="true"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" class="sections-menu-scrollButton"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></span></button><select aria-hidden="true" tabindex="-1" style="position:absolute;border:0;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;word-wrap:normal"></select></div></div></div><div class="section_olD1" tabindex="0"><div>CosmWasm</div><div><p class="description_C5q3">Building and interacting with Smart contracts on Osmosis.</p></div></div><div class="section_olD1" tabindex="0"><div>Frontend &amp; SDKs</div><div><p class="description_C5q3">Libraries &amp; UI components to build on top of Osmosis.</p></div></div></div><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/build">Build and Test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/localtesting">Local Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/osmosisd">Osmosis CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ide-guide">IDE Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/osmosis-core/category/modules">Modules</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modules&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/concentrated-liquidity">Concentrated Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/cosmwasmpool">CosmWasm Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/downtime-detector">Downtime-detector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/epochs">Epochs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/osmosis-core/modules/gamm">GAMM</a><button aria-label="Toggle the collapsible sidebar category &#x27;GAMM&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/gov">Gov</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-hooks">IBC-hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-rate-limit">IBC Rate Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/incentives">Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/lockup">Lockup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/mint">Mint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-incentives">Pool Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-manager">Pool Manager Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/protorev">Osmosis modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/superfluid">Superfluid Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/tokenfactory">Token Factory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osmosis-core/modules/twap">TWAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/txfees">Txfees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/valpref-module">validator-set Preference</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/asset-info">Asset Info</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/keys-management">Keys Management</a><button aria-label="Toggle the collapsible sidebar category &#x27;Keys Management&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/relayer">Relayer</a><button aria-label="Toggle the collapsible sidebar category &#x27;Relayer&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ibc">IBC Protocol</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/guides">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>TWAP</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="time-weighted-average-price">Time Weighted Average Price<a class="hash-link" href="#time-weighted-average-price" title="Direct link to heading">​</a></h2><p>The TWAP package is responsible for being able to serve TWAPs for every AMM pool.</p><p>A time weighted average price is a function that takes a sequence of <code>(time, price)</code> pairs, and returns a price representing an &#x27;average&#x27; over the entire time period. The method of averaging can vary from the classic arithmetic mean, (such as geometric mean, harmonic mean), however we currently only implement arithmetic mean.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="arithmetic-mean-twap">Arithmetic mean TWAP<a class="hash-link" href="#arithmetic-mean-twap" title="Direct link to heading">​</a></h2><p>Using the arithmetic mean, the TWAP of a sequence <code>(t_i, p_i)</code>, from <code>t_0</code> to <code>t_n</code>, indexed by time in ascending order, is: $$\frac{1}{t<em>n - t_0}\sum</em>{i=0}^{n-1} p<em>i (t</em>{i+1} - t_i)$$
Notice that the latest price <code>p_n</code> isn&#x27;t used, as it has lasted for a time interval of <code>0</code> seconds in this range!</p><p>To illustrate with an example, given the sequence: <code>(0s, $1), (4s, $6), (5s, $1)</code>, the arithmetic mean TWAP is:
$$\frac{\$1 <em> (4s - 0s) + \$6 </em> (5s - 4s)}{5s - 0s} = \frac{\$10}{5} = \$2$$</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="computation-via-accumulators-method">Computation via accumulators method<a class="hash-link" href="#computation-via-accumulators-method" title="Direct link to heading">​</a></h2><p>The prior example for how to compute the TWAP takes linear time in the number of time entries in a range, which is too inefficient. We require TWAP operations to have constant time complexity (in the number of records).</p><p>This is achieved by using an accumulator. In the case of an arithmetic TWAP, we can maintain an accumulator from <code>a_n</code>, representing the numerator of the TWAP expression for the interval <code>t_0...t_n</code>, namely
$$a<em>n = \sum</em>{i=0}^{n-1} p<em>i (t</em>{i+1} - t_i)$$
If we maintain such an accumulator for every pool, with <code>t_0 = pool_creation_time</code> to <code>t_n = current_block_time</code>, we can easily compute the TWAP for any interval. The TWAP for the time interval of price points <code>t_i</code> to <code>t_j</code> is then $twap = \frac{a_j - a_i}{t_j - t_i}$, which is constant time given the accumulator values.</p><p>In Osmosis, we maintain accumulator records for every pool, for the last 48 hours.
We also maintain within each accumulator record in state, the latest spot price.
This allows us to interpolate accumulation records between times.
Namely, if I want the twap from <code>t=10s</code> to <code>t=15s</code>, but the time records are at <code>9s, 13s, 17s</code>, this is fine.
Using the latest spot price in each record, we create the accumulator value for <code>t=10</code> by computing
<code>a_10 = a_9 + a_9_latest_spot_price * (10s - 9s)</code>, and <code>a_15 = a_13 + a_13_latest_spot_price * (15s - 13s)</code>.
Given these interpolated accumulation values, we can compute the TWAP as before.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="module-api">Module API<a class="hash-link" href="#module-api" title="Direct link to heading">​</a></h2><p>The primary intended API is <code>GetArithmeticTwap</code>, which is documented below, and has a similar cosmwasm binding.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">// GetArithmeticTwap returns an arithmetic time weighted average price.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// The returned twap is the time weighted average price (TWAP), using the arithmetic mean, of:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * the base asset, in units of the quote asset (1 unit of base = x units of quote)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * from (startTime, endTime),</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * as determined by prices from AMM pool `poolId`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// startTime and endTime do not have to be real block times that occurred,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// the state machine will interpolate the accumulator values for those times</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// from the latest Twap accumulation record prior to the provided time.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// startTime must be within 48 hours of ctx.BlockTime(), if you need older TWAPs,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// you will have to maintain the accumulator yourself.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// This function will error if:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * startTime &gt; endTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * endTime in the future</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * startTime older than 48 hours OR pool creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// * pool with id poolId does not exist, or does not contain quoteAssetDenom, baseAssetDenom</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// N.B. If there is a notable use case, the state machine could maintain more historical records, e.g. at one per hour.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">k Keeper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">GetArithmeticTwap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ctx sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    poolId </span><span class="token builtin" style="color:rgb(86, 156, 214)">uint64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    baseAssetDenom </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> quoteAssetDenom </span><span class="token builtin" style="color:rgb(86, 156, 214)">string</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    startTime time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> endTime time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sdk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Dec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">...</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are convenience methods for <code>GetArithmeticTwapToNow</code> which sets <code>endTime = ctx.BlockTime()</code>, and has minor gas reduction.
For users who need TWAPs outside the 48 hours stored in the state machine, you can get the latest accumulation store record from <code>GetBeginBlockAccumulatorRecord</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-layout">Code layout<a class="hash-link" href="#code-layout" title="Direct link to heading">​</a></h2><p><strong>api.go</strong> is the main file you should look at as a user of this module.</p><p><strong>logic.go</strong> is the main file you should look at for how the TWAP implementation works.</p><ul><li>client/* - Implementation of GRPC and CLI queries</li><li>types/* - Implement TwapRecord, GenesisState. Define AMM interface, and methods to format keys.</li><li>twapmodule/module.go - SDK AppModule interface implementation.</li><li>api.go - Public API, that other users / modules can/should depend on</li><li>listeners.go - Defines hooks &amp; calls to logic.go, for triggering actions on </li><li>keeper.go - generic SDK boilerplate (defining a wrapper for store keys + params)</li><li>logic.go - Implements all TWAP module &#x27;logic&#x27;. (Arithmetic, defining what to get/set where, etc.)</li><li>store.go - Managing logic for getting and setting things to underlying stores</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="store-layout">Store layout<a class="hash-link" href="#store-layout" title="Direct link to heading">​</a></h2><p>We maintain TWAP accumulation records for every AMM pool on Osmosis. </p><p>Because Osmosis supports multi-asset pools, a complicating factor is that we have to store a record for every asset pair in the pool.
For every pool, at a given point in time, we make one twap record entry per unique pair of denoms in the pool. If a pool has <code>k</code> denoms, the number of unique pairs is <code>k * (k - 1) / 2</code>.
All public API&#x27;s for the module will sort the input denoms to the canonical representation, so the caller does not need to worry about this. (The canonical representation is the denoms in lexicographical order)</p><p>Each twap record stores <a href="https://github.com/osmosis-labs/osmosis/tree/main/proto/osmosis/gamm/twap" target="_blank" rel="noopener noreferrer">(source)</a>:</p><ul><li>last spot price of base asset A in terms of quote asset B</li><li>last spot price of base asset B in terms of quote asset A</li><li>Accumulation value of base asset A in terms of quote asset B</li><li>Accumulation value of base asset B in terms of quote asset A</li></ul><p>All TWAP records are indexed in state by the time of write.</p><p>A new TWAP record is created in two situations:</p><ul><li>When a pool is created</li><li>In the <code>EndBlock</code>, if the block contains any potentially price changing event for the pool. (Swap, LP, Exit)</li></ul><p>When a pool is created, records are created with the current spot price of the pool.</p><p>During <code>EndBlock</code>, new records are created, with:</p><ul><li>The accumulator&#x27;s value is updated based upon the most recent prior accumulator&#x27;s stored last spot price</li><li>The <code>LastSpotPrice</code> value is equal to the EndBlock spot price.</li></ul><p>In the event that a pool is created, and has a swap in the same block, the record entries are over written with the end block price.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracking-spot-price-changing-events-in-a-block">Tracking spot-price changing events in a block<a class="hash-link" href="#tracking-spot-price-changing-events-in-a-block" title="Direct link to heading">​</a></h3><p>The flow by which we currently track spot price changing events in a block is as follows:</p><ul><li>AMM hook triggers for Swapping, LPing or Exiting a pool</li><li>TWAP listens for this hook, and adds this pool ID to a local tracker</li><li>In end block, TWAP iterates over every changed pool in that block, based on the local tracker, and updates their TWAP records</li><li>In end block, TWAP clears the changed pool list, so it is blank by the next block.</li></ul><p>The mechanism by which we maintain this changed pool list, is the SDK <code>Transient Store</code>.
The transient store is a KV store in the SDK, that stores entries in memory, for the duration of a block,
and then clears on the block committing. This is done to save on gas (and I/O for the state machine).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pruning">Pruning<a class="hash-link" href="#pruning" title="Direct link to heading">​</a></h2><p>To avoid infinite growth of the state with the TWAP records, we attempt to delete some old records after every epoch.
Essentially, records younger than a configurable parameter are pruned away. Currently, this parameter is set to 48 hours.
Therefore, at the end of an epoch records younger than 48 hours before the current block time are pruned away.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-methodology">Testing Methodology<a class="hash-link" href="#testing-methodology" title="Direct link to heading">​</a></h2><p>The pre-release testing methodology planned for the twap module is:</p><ul class="contains-task-list containsTaskList_mC6p"><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Using table driven unit tests to test all foreseen states of the module<ul><li>hook testing<ul><li>All swaps correctly trigger twap record updates</li><li>Create pools cause records to be created</li></ul></li><li>store<ul><li>EndBlock triggers all relevant twaps to be saved correctly</li><li>Block commit wipes temporary stores</li></ul></li><li>logic<ul><li>Make tables of expected input / output cases for:<ul><li>getMostRecentRecord</li><li>getInterpolatedRecord</li><li>updateRecord</li><li>computeArithmeticTwap</li></ul></li><li>Test overflow handling in all relevant arithmetic</li><li>Complete testing code coverage (up to return err lines) for logic.go file</li></ul></li><li>API<ul><li>Unit tests for the public API, under foreseeable setup conditions</li></ul></li></ul></li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->End to end migration tests<ul><li>Tests that migration of Osmosis pools created prior to the TWAP upgrade, get TWAPs recorded starting at the v11 upgrade.</li></ul></li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Integration into the Osmosis simulator<ul><li>The osmosis simulator, simulates building up complex state machine states, in random ways not seen before. We plan on, in a property check, maintaining expected TWAPs for short time ranges, and seeing that the keeper query will return the same value as what we get off of the raw price history for short history intervals.</li><li>Not currently deemed release blocking, but planned: Integration for gas tracking, to ensure gas of reads/writes does not grow with time.</li></ul></li><li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Mutation testing usage<ul><li>integration of the TWAP module into <a href="https://github.com/osmosis-labs/go-mutesting" target="_blank" rel="noopener noreferrer">go mutation testing</a>: <ul><li>We&#x27;ve seen with the <code>tokenfactory</code> module that it succeeds at surfacing behavior for untested logic.
e.g. if you delete a line, or change the direction of a conditional, mutation tests show if regular Go tests catch it.</li><li>We expect to get this to a state, where after mutation testing is ran, the only items it mutates, that is not caught in a test, is: Deleting <code>return err</code>, or <code>panic</code> lines, in the situation where that error return or panic isn&#x27;t reachable.</li></ul></li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/osmosis-labs/docs/tree/main/docs/osmosis-core/modules/twap/README.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/osmosis-core/modules/tokenfactory"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Token Factory</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osmosis-core/modules/txfees"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Txfees</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#time-weighted-average-price" class="table-of-contents__link toc-highlight">Time Weighted Average Price</a></li><li><a href="#arithmetic-mean-twap" class="table-of-contents__link toc-highlight">Arithmetic mean TWAP</a></li><li><a href="#computation-via-accumulators-method" class="table-of-contents__link toc-highlight">Computation via accumulators method</a></li><li><a href="#module-api" class="table-of-contents__link toc-highlight">Module API</a></li><li><a href="#code-layout" class="table-of-contents__link toc-highlight">Code layout</a></li><li><a href="#store-layout" class="table-of-contents__link toc-highlight">Store layout</a><ul><li><a href="#tracking-spot-price-changing-events-in-a-block" class="table-of-contents__link toc-highlight">Tracking spot-price changing events in a block</a></li></ul></li><li><a href="#pruning" class="table-of-contents__link toc-highlight">Pruning</a></li><li><a href="#testing-methodology" class="table-of-contents__link toc-highlight">Testing Methodology</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="margin-bottom--sm"><a class="footerLogoLink_DDai" href="/"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="36px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="36px"></a></div><div class="footer__row"><div class="footer__data"><div class="footer__cta"></div></div><div class="links"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Launch App</a></li><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Portal</a></li><li class="footer__item"><a href="https://osmosis.zone/ecosystem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ecosystem</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://medium.com/@Osmosis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://commonwealth.im/osmosis/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community</a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Osmosis Labs since 2023. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b997ef34.js"></script>
<script src="/assets/js/main.ed1cf7f0.js"></script>
</body>
</html>
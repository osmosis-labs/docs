<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-osmosis-core docs-doc-id-modules/gamm/pool-models/stableswap/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Generalized Solidly Stableswap | Osmosis Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" name="twitter:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" property="og:url" content="https://docs.osmosis.zone/osmosis-core/modules/gamm/pool-models/stableswap"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" property="og:title" content="Generalized Solidly Stableswap | Osmosis Docs"><meta data-rh="true" name="description" content="Stableswaps are pools that offer low slippage for two assets that are intended to be tightly correlated."><meta data-rh="true" property="og:description" content="Stableswaps are pools that offer low slippage for two assets that are intended to be tightly correlated."><link data-rh="true" rel="icon" href="/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.osmosis.zone/osmosis-core/modules/gamm/pool-models/stableswap"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/gamm/pool-models/stableswap" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/gamm/pool-models/stableswap" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2CBDVP21VK-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Osmosis Docs" href="/opensearch.xml">










<link rel="preconnect" href="https://app.posthog.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,a){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==a?g=e[a]=[]:a="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)c(g,o[p]);e._i.push([r,s,a])},e.__SV=1)}(document,window.posthog||[]),posthog.init("00",{api_host:"https://app.posthog.com"})</script>

<script src="https://tally.so/widgets/embed.js"></script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="c5b5e9fc-d025-4c12-b08e-9784d0e2161f" data-project-name="Osmosis" data-project-color="#7900B4" data-project-logo="https://app.osmosis.zone/tokens/osmo.svg" async></script><link rel="stylesheet" href="/assets/css/styles.792232e5.css">
<link rel="preload" href="/assets/js/runtime~main.143ea17f.js" as="script">
<link rel="preload" href="/assets/js/main.f0ea6666.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA" height="26px" width="114px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU" height="26px" width="114px"></div></a><a class="navbar__item navbar__link" href="/overview/educate">Overview</a><a class="navbar__item navbar__link" href="/overview/integrate">Integrate</a><a class="navbar__item navbar__link" href="/overview/validate">Validate &amp; Run your Node</a><a class="navbar__item navbar__link" href="/overview/endpoints">Endpoints</a><a class="navbar__item navbar__link" href="/overview/features">Features</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/osmosis-core">Develop</a><a href="https://github.com/osmosis-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon github-icon"></a><a href="https://discord.com/invite/osmosis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon discord-icon"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link dev-portal-signup dev-portal-link">Launch Dex<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_mhZE"><div class="multiSectionContainer_bYm7"><div class="section_olD1 sectionActive_D9yk" tabindex="0"><div>Osmosis Core</div><div><div class="row_KvCx"><button type="button" role="combobox" aria-controls="" aria-expanded="false" aria-autocomplete="none" aria-label="Select Section" class="sections-menu-trigger"><span style="pointer-events:none"></span><span aria-hidden="true"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" class="sections-menu-scrollButton"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></span></button><select aria-hidden="true" tabindex="-1" style="position:absolute;border:0;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;word-wrap:normal"></select></div></div></div><div class="section_olD1" tabindex="0"><div>CosmWasm</div><div><p class="description_C5q3">Building and interacting with Smart contracts on Osmosis.</p></div></div><div class="section_olD1" tabindex="0"><div>Frontend &amp; SDKs</div><div><p class="description_C5q3">Libraries &amp; UI components to build on top of Osmosis.</p></div></div></div><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/build">Build and Test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/osmosisd">Osmosis CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ide-guide">IDE Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/osmosis-core/category/modules">Modules</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modules&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/concentrated-liquidity">Concentrated Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/cosmwasmpool">CosmWasm Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/downtime-detector">Downtime-detector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/epochs">Epochs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/osmosis-core/modules/gamm">GAMM</a><button aria-label="Toggle the collapsible sidebar category &#x27;GAMM&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/osmosis-core/modules/gamm/client/docs">client</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/osmosis-core/modules/gamm/pool-models/stableswap">pool-models</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osmosis-core/modules/gamm/pool-models/stableswap">Generalized Solidly Stableswap</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/gov">Gov</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-hooks">IBC-hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-rate-limit">IBC Rate Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/incentives">Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/lockup">Lockup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/mint">Mint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-incentives">Pool Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-manager">Pool Manager Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/protorev">Osmosis modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/superfluid">Superfluid Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/tokenfactory">Token Factory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/twap">TWAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/txfees">Txfees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/valpref-module">validator-set Preference</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/asset-info">Asset Info</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/keys-management">Keys Management</a><button aria-label="Toggle the collapsible sidebar category &#x27;Keys Management&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/relayer">Relayer</a><button aria-label="Toggle the collapsible sidebar category &#x27;Relayer&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ibc">IBC Protocol</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/guides">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Generalized Solidly Stableswap</h1><p>Stableswaps are pools that offer low slippage for two assets that are intended to be tightly correlated.
There is a price ratio they are expected to be at, and the AMM offers low slippage around this price.
There is still price impact for each trade, and as the liquidity becomes more lop-sided, the slippage drastically increases.</p><p>This package implements the Solidly stableswap curve, namely a CFMM with
invariant: $f(x, y) = xy(x^2 + y^2) = k$</p><p>It is generalized to the multi-asset setting as $f(a_1, ..., a_n) = a_1 <em> ... </em> a_n (a_1^2 + ... + a_n^2)$</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pool-configuration">Pool configuration<a class="hash-link" href="#pool-configuration" title="Direct link to heading">​</a></h2><p>One key concept, is that the pool has a native concept of</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-factor-handling">Scaling factor handling<a class="hash-link" href="#scaling-factor-handling" title="Direct link to heading">​</a></h3><p>An important concept thats up to now, not been mentioned is how do we set the expected price ratio.
In the choice of curve section, we see that its the case that when <code>x_reserves ~= y_reserves</code>, that spot price is very close to <code>1</code>. However, there are a couple issues with just this in practice:</p><ol><li>Precision of pegged coins may differ. Suppose <code>1 Foo = 10^12 base units</code>, whereas <code>1 WrappedFoo = 10^6 base units</code>, but <code>1 Foo</code> is expected to trade near the price of <code>1 Wrapped Foo</code>.</li><li>Relatedly, suppose theres a token called <code>TwoFoo</code> which should trade around <code>1 TwoFoo = 2 Foo</code></li><li>For staking derivatives, where value accrues within the token, the expected price to concentrate around dynamically changes (very slowly).</li></ol><p>To handle these cases, we introduce scaling factors. A scaling factor maps from &quot;raw coin units&quot; to &quot;amm math units&quot;, by dividing.
To handle the first case, we would make <code>Foo</code> have a scaling factor of <code>10^6</code>, and <code>WrappedFoo</code> have a scaling factor of <code>1</code>.
This mapping is done via <code>raw coin units / scaling factor</code>.
We use a decimal object for amm math units, however we still have to be precise about how we round.
We introduce an enum <code>rounding mode</code> for this, with three modes: <code>RoundUp</code>, <code>RoundDown</code>, <code>RoundBankers</code>.</p><p>The reserve units we pass into all AMM equations would then be computed based off the following reserves:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">scaled_Foo_reserves </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> decimal_round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Foo_liquidity </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token operator" style="color:rgb(212, 212, 212)">^</span><span class="token number" style="color:rgb(181, 206, 168)">6</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">descaled_Foo_reserves </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> scaled_Foo_reserves </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token operator" style="color:rgb(212, 212, 212)">^</span><span class="token number" style="color:rgb(181, 206, 168)">6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly all token inputs would be scaled as such.
The AMM equations need to each ensure that rounding happens correctly,
for cases where the scaling factor doesn&#x27;t perfectly divide into the liquidity.
We detail rounding modes and scaling details as pseudocode in the relevant sections of the spec.
(And rounding modes for &#x27;descaling&#x27; from AMM eq output to real liquidity amounts, via multiplying by the respective scaling factor)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="algorithm-details">Algorithm details<a class="hash-link" href="#algorithm-details" title="Direct link to heading">​</a></h2><p>The AMM pool interfaces requires implementing the following stateful methods:</p><div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SwapOutAmtGivenIn(tokenIn sdk.Coins, tokenOutDenom string, swapFee sdk.Dec) (tokenOut sdk.Coin, err error)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SwapInAmtGivenOut(tokenOut sdk.Coins, tokenInDenom string, swapFee sdk.Dec) (tokenIn sdk.Coin, err error)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SpotPrice(baseAssetDenom string, quoteAssetDenom string) (sdk.Dec, error)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    JoinPool(tokensIn sdk.Coins, swapFee sdk.Dec) (numShares sdk.Int, err error)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    JoinPoolNoSwap(tokensIn sdk.Coins, swapFee sdk.Dec) (numShares sdk.Int, err error)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ExitPool(numShares sdk.Int, exitFee sdk.Dec) (exitedCoins sdk.Coins, err error)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The &quot;constant&quot; part of CFMM&#x27;s imply that we can reason about all their necessary algorithms from just the CFMM equation. There are still multiple ways to solve each method. We detail below the ways in which we do so. This is organized by first discussing variable substitutions we do, to be in a more amenable form, and then the details of how we implement each method.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cfmm-function">CFMM function<a class="hash-link" href="#cfmm-function" title="Direct link to heading">​</a></h3><p>Most operations we do only need to reason about two of the assets in a pool, and sometimes only one.
We wish to have a simpler CFMM function to work within these cases.
Due to the CFMM equation $f$ being a symmetric function, we can without loss of generality reorder the arguments to the function. Thus we put the assets of relevance at the beginning of the function. So if two assets $x, y$, we write: $f(x,y, a_3, ... a_n) = xy <em> a_3 </em> ... a_n (x^2 + y^2 + a_3^2 + ... + a_n^2)$.</p><p>We then take a more convenient expression to work with, via variable substition.</p><p>$$
\begin{equation}
v =
\begin{cases}
1, &amp; \text{if } n=2 <!-- -->\<!-- -->
\prod\negthinspace \negthinspace \thinspace^{n}_{i=3} \space a_i, &amp; \text{otherwise}
\end{cases}
\end{equation}
$$</p><p>$$
\begin{equation}
w =
\begin{cases}
0, &amp; \text{if}\ n=2 <!-- -->\<!-- -->
\sum\negthinspace \negthinspace \thinspace^{n}_{i=3} \space {a_i^2}, &amp; \text{otherwise}
\end{cases}
\end{equation}
$$</p><p>$$\text{then } g(x,y,v,w) = xyv(x^2 + y^2 + w) = f(x,y, a_3, ... a_n)$$</p><p>As a corollary, notice that $g(x,y,v,w) = v * g(x,y,1,w)$, which will be useful when we have to compare before and after quantities. We will use $h(x,y,w) := g(x,y,1,w)$ as short-hand for this.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="swaps">Swaps<a class="hash-link" href="#swaps" title="Direct link to heading">​</a></h3><p>The question we need to answer for a swap is &quot;suppose I want to swap $a$ units of $x$, how many units $b$ of $y$ would I get out&quot;.</p><p>Since we only deal with two assets at a time, we can then work with our prior definition of $g$. Let the input asset&#x27;s reserves be $x$, the output asset&#x27;s reserves be $y$, and we compute $v$ and $w$ given the other asset reserves, whose reserves are untouched throughout the swap.</p><p>First we note the direct way of solving this, its limitation, and then an iterative approximation approach that we implement.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="direct-swap-solution">Direct swap solution<a class="hash-link" href="#direct-swap-solution" title="Direct link to heading">​</a></h4><p>The method to compute this under 0 swap fee is implied by the CFMM equation itself, since the constant refers to:
$g(x_0, y_0, v, w) = k = g(x_0 + a, y_0 - b, v, w)$. As $k$ is linearly related to $v$, and $v$ is unchanged throughout the swap, we can simplify the equation to be reasoning about $k&#x27; = \frac{k}{v}$ as the constant, and $h$ instead of $g$</p><p>We then model the solution by finding a function $\text{solve cfmm}(x, w, k&#x27;) = y\text{ s.t. }h(x, y, w) = k&#x27;$.
Then we can solve the swap amount out by first computing $k&#x27;$ as $k&#x27; = h(x_0, y_0, w)$, and
computing $y_f := \text{solve cfmm}(x_0 + a, w, k&#x27;)$. We then get that $b = y_0 - y_f$.</p><p>So all we need is an equation for $\text{solve cfmm}$! Its essentially inverting a multi-variate polynomial, and in this case is solvable: <a href="https://www.wolframalpha.com/input?i=solve+for+y+in+x+*+y+*+%28x%5E2+%2B+y%5E2+%2B+w%29+%3D+k" target="_blank" rel="noopener noreferrer">wolfram alpha link</a></p><p>Or if were clever with simplification in the two asset case, we can reduce it to: <a href="https://www.desmos.com/calculator/hag1f0wieg" target="_blank" rel="noopener noreferrer">desmos link</a>.</p><p>These functions are a bit complex, which is fine as they are easy to prove correct. However, they are relatively expensive to compute, the latter needs precision on the order of x^4, and requires computing multiple cubic roots.</p><p>Instead there is a more generic way to compute these, which we detail in the next subsection.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="iterative-search-solution">Iterative search solution<a class="hash-link" href="#iterative-search-solution" title="Direct link to heading">​</a></h4><p>Instead of using the direct solution for $\text{solve cfmm}(x, w, k&#x27;)$, instead notice that $h(x, y, w)$ is an increasing function in $y$.
So we can simply binary search for $y$ such that $h(x, y, w) = k&#x27;$, and we are guaranteed convergence within some error bound.</p><p>In order to do a binary search, we need bounds on $y$.
The lowest lowerbound is $0$, and the largest upperbound is $\infty$.
The maximal upperbound is obviously unworkable, and in general binary searching around wide ranges is unfortunate, as we expect most trades to be centered around $y_0$.
This would suggest that we should do something smarter to iteratively approach the right value for the upperbound at least.
Notice that $h$ is super-linearly related in $y$, and at most cubically related to $y$.
This means that $\forall c \in \mathbb{R}^+, c <em> h(x,y,w) &lt; h(x,c</em>y,w) &lt; c^3 * h(x,y,w)$.
We can use this fact to get a pretty-good initial upperbound guess for $y$ using the linear estimate.
In the lowerbound case, we leave it as lower-bounded by $0$, otherwise we would need to take a cubed root to get a better estimate.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="altering-binary-search-equations-due-to-error-tolerance">Altering binary search equations due to error tolerance<a class="hash-link" href="#altering-binary-search-equations-due-to-error-tolerance" title="Direct link to heading">​</a></h5><p>Great, we have a binary search to finding an input <code>new_y_reserve</code>, such that we get a value <code>k</code> within some error bound close to the true desired <code>k</code>! We can prove that an error by a factor of <code>e</code> in <code>k</code>, implies an error of a factor less than <code>e</code> in <code>new_y_reserve</code>. So we could set <code>e</code> to be close to some correctness bound we want. Except... <code>new_y_reserve &gt;&gt; y_in</code>, so we&#x27;d need an extremely high error tolerance for this to work. So we actually want to adapt the equations, to reduce the &quot;common terms&quot; in <code>k</code> that we need to binary search over, to help us search. To do this, we open up what are we doing again, and re-expose <code>y_out</code> as a variable we explicitly search over (and therefore get error terms in <code>k</code> implying error in <code>y_out</code>)</p><p>What we are doing above in the binary search is setting <code>k_target</code> and searching over <code>y_f</code> until we get <code>k_iter</code> {within tolerance} to <code>k_target</code>. Sine we want to change to iterating over $y<em>{out}$, we unroll that $y_f = y_0 - y</em>{out}$ where they are defined as:
$$k<em>{target} = x_0 y_0 (x_0^2 + y_0^2 + w)$$
$$k</em>{iter}(y<em>0 - y</em>{out}) = h(x<em>f, y_0 - y</em>{out}, w) = x<em>f (y_0 - y</em>{out}) (x<em>f^2 + (y_0 - y</em>{out})^2 + w)$$</p><p>But we can remove many of these terms! First notice that <code>x_f</code> is a constant factor in <code>k_iter</code>, so we can just divide <code>k_target</code> by <code>x_f</code> to remove that. Then we switch what we search over, from <code>y_f</code> to <code>y_out</code>, by fixing <code>y_0</code>, so were at:</p><p>$$k_{target} = x_0 y_0 (x_0^2 + y_0^2 + w) / x_f$$</p><p>$$k<em>{iter}(y</em>{out}) = (y<em>0 - y</em>{out}) (x<em>f^2 + (y_0 - y</em>{out})^2 + w) = (y<em>0 - y</em>{out}) (x<em>f^2 + w) + (y_0 - y</em>{out})^3$$</p><p>So $k<em>{iter}(y</em>{out})$ is a cubic polynomial in $y<em>{out}$. Next we remove the terms that have no dependence on `y</em>{delta}` (the constant term in the polynomial). To do this first we rewrite this to make the polynomial clearer:</p><p>$$k<em>{iter}(y</em>{out}) = (y<em>0 - y</em>{out}) (x<em>f^2 + w) + y_0^3 - 3y_0^2 y</em>{out} + 3 y<em>0 y</em>{out}^2 - y_{out}^3$$</p><p>$$k<em>{iter}(y</em>{out}) = y<em>0 (x_f^2 + w) - y</em>{out}(x<em>f^2 + w) + y_0^3 - 3y_0^2 y</em>{out} + 3 y<em>0 y</em>{out}^2 - y_{out}^3$$</p><p>$$k<em>{iter}(y</em>{out}) = -y<em>{out}^3 + 3 y_0 y</em>{out}^2 - (x<em>f^2 + w + 3y_0^2)y</em>{out} + (y_0 (x_f^2 + w) + y_0^3)$$</p><p>So we can subtract this constant term <code>y_0 (x_f^2 + w) + y_0^3</code>, which for <code>y_out &lt; y_0</code> is the dominant term in the expression!</p><p>So lets define this as:</p><p>$$k_{target} = \frac{x_0 y_0 (x_0^2 + y_0^2 + w)}{x_f} - (y_0 (x_f^2 + w) + y_0^3)$$</p><p>$$k<em>{iter}(y</em>{out}) = -y<em>{out}^3 + 3 y_0 y</em>{out}^2 - (x<em>f^2 + w + 3y_0^2)y</em>{out}$$</p><p>We prove <a href="#err_proof">here</a> that an error of a multiplicative <code>e</code> between <code>target_k</code> and <code>iter_k</code>, implies an error of less than a factor of <code>10e</code> in <code>y_{out}</code>, as long as <code>|y_{out}| &lt; y_0</code>. (The proven bounds are actually better)</p><p>We target an error of less than <code>10^{-8}</code> in <code>y_{out}</code>, so we conservatively set a bound of <code>10^{-12}</code> for <code>e_k</code>.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="combined-pseudocode">Combined pseudocode<a class="hash-link" href="#combined-pseudocode" title="Direct link to heading">​</a></h5><p>Now we want to wrap this binary search into <code>solve_cfmm</code>. We changed the API slightly, from what was previously denoted, to have this &quot;y_0&quot; term, in order to derive initial bounds.</p><p>One complexity is that in the iterative search, we iterate over $y_f$, but then translate to $y_0$ in the internal equations.
So we also use the </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># solve_y returns y_out s.t. CFMM_eq(x_f, y_f, w) = k = CFMM_eq(x_0, y_0, w)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># for x_f = x_0 + x_in.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">solve_y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x_in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  x_f </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> x_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> x_in</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  err_tolerance </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;within factor of 10^-12&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundUp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  y_f </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> iterative_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err_tolerance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  y_out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> y_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> y_f</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> y_out</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">iter_k_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">y_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    y_out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> y_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> y_f</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">y_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"> y_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> y_out</span><span class="token operator" style="color:rgb(212, 212, 212)">^</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_f</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> w </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">y_0</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> y_out</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">iterative_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err_tolerance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  target_k </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> target_k_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  iter_k_calculator </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> iter_k_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># use original CFMM to get y_f reserve bounds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  bound_estimation_target_k </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cfmm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  bound_estimation_k0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cfmm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  lowerbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> upperbound </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> y_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> y_0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  k_ratio </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bound_estimation_k0 </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> bound_estimation_target_k</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> k_ratio </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># k_0 &lt; k. Need to find an upperbound. Worst case assume a linear relationship, gives an upperbound</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># We could derive better bounds via reasoning about coefficients in the cubic,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># however this is deemed as not worth it, since the solution is quite close</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># when we are in the &quot;stable&quot; part of the curve.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    upperbound </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ceil</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">y_0 </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> k_ratio</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> k_ratio </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># need to find a lowerbound. We could use a cubic relation, but for now we just set it to 0.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    lowerbound </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> y_0 </span><span class="token comment" style="color:rgb(106, 153, 85)"># means x_f = x_0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  max_iteration_count </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> binary_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">lowerbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> upperbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k_calculator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> target_k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err_tolerance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">binary_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">lowerbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> upperbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> approximation_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_iteration_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err_tolerance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  iter_count </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  cur_k_guess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> satisfies_bounds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cur_k_guess</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> err_tolerance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> iter_count </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> max_iteration_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    iter_count </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    cur_y_guess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">lowerbound </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> upperbound</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    cur_k_guess </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> approximation_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cur_y_guess</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cur_k_guess </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      upperbound </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cur_y_guess</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cur_k_guess </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      lowerbound </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cur_y_guess</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> iter_count </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> max_iteration_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> Error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max iteration count reached&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> cur_y_guess</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="setting-the-error-tolerance">Setting the error tolerance<a class="hash-link" href="#setting-the-error-tolerance" title="Direct link to heading">​</a></h5><p>What remains is setting the error tolerance. We need two properties:</p><ul><li>The returned value to be within some correctness threshold of the true value</li><li>The returned value to be rounded correctly (always ending with the user having fewer funds to avoid pool drain attacks). Mitigated by swap fees for normal swaps, but needed for 0-fee to be safe.</li></ul><p>The error tolerance we set is defined in terms of error in <code>k</code>, which itself implies some error in <code>y</code>.
An error of <code>e_k</code> in <code>k</code>, implies an error <code>e_y</code> in <code>y</code> that is less than <code>e_k</code>. We prove this <a href="#err_proof">here</a> (and show that <code>e_y</code> is actually much less than the error in <code>e_k</code>, but for simplicity ignore this fact). We want <code>y</code> to be within a factor of <code>10^(-12)</code> of its true value.
To ensure the returned value is always rounded correctly, we define the rounding behavior expected.</p><ul><li>If <code>x_in</code> is positive, then we take <code>y_out</code> units of <code>y</code> out of the pool. <code>y_out</code> should be rounded down. Note that <code>y_f &lt; y_0</code> here. Therefore to round <code>y_out = y_0 - y_f</code> down, given fixed <code>y_0</code>, we want to round <code>y_f</code> up.</li><li>If <code>x_in</code> is negative, then <code>y_out</code> is also negative. The reason is that this is called in CalcInAmtGivenOut, so confusingly <code>x_in</code> is the known amount out, as a negative quantity. <code>y_out</code> is negative as well, to express that we get that many tokens out. (Since negative, <code>-y_out</code> is how many we add into the pool). We want <code>y_out</code> to be a larger negative, which means we want to round it down. Note that <code>y_f &gt; y_0</code> here. Therefore <code>y_out = y_0 - y_f</code> is more negative, the higher <code>y_f</code> is. Thus we want to round <code>y_f</code> up.</li></ul><p>And therefore we round up in both cases.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="further-optimization">Further optimization<a class="hash-link" href="#further-optimization" title="Direct link to heading">​</a></h5><ul><li>The astute observer may notice that the equation we are solving in $\text{solve cfmm}$ is actually a cubic polynomial in $y$, with an always-positive derivative.
We should then be able to use newton&#x27;s root finding algorithm to solve for the solution with quadratic convergence.
We do not pursue this today, due to other engineering tradeoffs, and insufficient analysis being done.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="using-this-in-swap-methods">Using this in swap methods<a class="hash-link" href="#using-this-in-swap-methods" title="Direct link to heading">​</a></h4><p>So now we put together the components discussed in prior sections to achieve pseudocode for the SwapExactAmountIn
and SwapExactAmountOut functions.</p><p>We assume existence of a function <code>pool.ScaledLiquidity(input, output, rounding_mode)</code> that returns <code>in_reserve, out_reserve, rem_reserves</code>, where each are scaled by their respective scaling factor using the provided rounding mode.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="swapexactamountin">SwapExactAmountIn<a class="hash-link" href="#swapexactamountin" title="Direct link to heading">​</a></h5><p>So now we need to put together the prior components.
When we scale liquidity, we round down, as lower reserves -&gt; higher slippage.
Similarly when we scale the token in, we round down as well.
These both ensure no risk of over payment.</p><p>The amount of tokens that we treat as going into the &quot;0-swap fee&quot; pool we defined equations off of is: <code>amm_in = in_amt_scaled * (1 - swapfee)</code>. (With <code>swapfee * in_amt_scaled</code> just being added to pool liquidity)</p><p>Then we simply call <code>solve_y</code> with the input reserves, and <code>amm_in</code>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">CalcOutAmountGivenExactAmountIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> in_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> swap_fee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  in_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> rem_reserves </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ScaledLiquidity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">in_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">RoundDown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  in_amt_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ScaleToken</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">in_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">RoundDown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  amm_in </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> in_amt_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> swap_fee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  out_amt_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> solve_y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">in_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> remReserves</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amm_in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  out_amt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DescaleToken</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">out_amt_scaled</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> out_amt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="swapexactamountout">SwapExactAmountOut<a class="hash-link" href="#swapexactamountout" title="Direct link to heading">​</a></h5><p>When we scale liquidity, we round down, as lower reserves -&gt; higher slippage.
Similarly when we scale the exact token out, we round up to increase required token in.</p><p>We model the <code>solve_y</code> call as we are doing a known change to the <code>out_reserve</code>, and solving for the implied unknown change to <code>in_reserve</code>.
To handle the swapfee, we apply the swapfee on the resultant needed input amount.
We do this by having <code>token_in = amm_in / (1 - swapfee)</code>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">CalcInAmountGivenExactAmountOut</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> in_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> swap_fee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  in_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> rem_reserves </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ScaledLiquidity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">in_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> out_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">RoundDown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  out_amt_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ScaleToken</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">out_coin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> RoundingMode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">RoundUp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  amm_in_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> solve_y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">out_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> in_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> remReserves</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">out_amt_scaled</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  swap_in_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ceil</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">amm_in_scaled </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> swapfee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  in_amt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DescaleToken</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">swap_in_scaled</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> in_denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> in_amt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see correctness of the swap fee, by imagining what happens if we took this resultant input amount, and ran <code>SwapExactAmountIn (seai)</code>. Namely, that <code>seai_amm_in = amm_in * (1 - swapfee) = amm_in</code>, as desired!</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="precision-handling">Precision handling<a class="hash-link" href="#precision-handling" title="Direct link to heading">​</a></h4><p>{Something we have to be careful of is precision handling, notes on why and how we deal with it.}</p><a name="err_proof"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="proof-that-e_y--100e_k">Proof that |e_y| &lt; 100|e_k|<a class="hash-link" href="#proof-that-e_y--100e_k" title="Direct link to heading">​</a></h4></a><p>The function $f(y<em>{out}) = -y</em>{out}^3 + 3 y<em>0 y</em>{out}^2 - (x<em>f^2 + w + 3y_0^2)y</em>{out}$ is monotonically increasing over the reals.
You can prove this, by seeing that its <a href="https://www.wolframalpha.com/input?i=d%2Fdx+-x%5E3+%2B+3a+x%5E2+-+%28b+%2B+3a%5E2%29+x+" target="_blank" rel="noopener noreferrer">derivative&#x27;s</a> 0 values are both imaginary, and therefore has no local minima or maxima in the reals.
Therefore, there exists exactly one real $y<em>{out}$ s.t. $f(y</em>{out}) = k$.
Via binary search, we solve for a value $y<em>{out}^{<!-- -->*<!-- -->}$ such that $\left|\frac{ k - k^{<!-- -->*<!-- -->} }{k}\right| &lt; e_k$, where $k^{<!-- -->*<!-- -->} = f(y</em>{out}^{<!-- -->*<!-- -->})$. We seek to then derive bounds on $e<em>y = \left|\frac{ y</em>{out} - y<em>{out}^{<!-- -->*<!-- -->} }{y</em>{out}}\right|$ in relation to $e_k$.</p><p><strong>Theorem</strong>: $e<em>y &lt; 100 e_k$ as long as $|y</em>{out}| &lt;= .9y<em>0$.
<strong>Informal</strong>, we claim that for $.9y_0 &lt; |y</em>{out}| &lt; y<em>0$, <code>e_y</code> is &quot;close&quot; to <code>e_k</code> under expected parameterizations. And for $y</em>{out}$ significantly less than $.9y_0$, the error bounds are much better. (Often better than $e_k$)</p><p>Let $y<em>{out} - y</em>{out}^<em> = a<em>y$, we are going to assume that $a_y &lt;&lt; y</em>{out}$, and will justify this later. But due to this, we treat $a<em>y^c = 0$ for $c &gt; 1$. This then implies that $y</em>{out}^2 - y_{out}^{</em>2} = y<em>{out}^2 - (y</em>{out} - a<em>y)^2 \approx 2y</em>{out}a<em>y$, and similarly $y</em>{out}^3 - y<em>{out}^{*3} \approx 3y</em>{out}^2 a_y$</p><p>Now we are prepared to start bounding this.
$$k - k^{<!-- -->*<!-- -->} = -(y<em>{out}^3 - y</em>{out}^{3<!-- -->*<!-- -->}) + 3y<em>0(y</em>{out}^2 - y<em>{out}^{2<!-- -->*<!-- -->}) - (x_f^2 + w + 3y_0^2)(y</em>{out} - y_{out}^{<!-- -->*<!-- -->})$$</p><p>$$k - k^{<!-- -->*<!-- -->} \approx -(3y<em>{out}^2 a_y) + 3y_0 (2y</em>{out}a_y) - (x_f^2 + w + 3y_0^2)a_y$$</p><p>$$k - k^{<!-- -->*<!-- -->} \approx a<em>y(-3y</em>{out}^2 + 6y<em>0y</em>{out} - (x_f^2 + w + 3y_0^2))$$</p><p>Rewrite $k = y<em>{out}(-y</em>{out}^2 + 3y<em>0y</em>{out} - (x_f^2 + w + 3y_0^2))$</p><p>$$e<em>k &gt; \left|\frac{ k - k^{<!-- -->*<!-- -->} }{k}\right| = \left|\frac{a_y}{y</em>{out}} \frac{(-3y<em>{out}^2 + 6y_0y</em>{out} - (x<em>f^2 + w + 3y_0^2))}{(-y</em>{out}^2 + 3y<em>0y</em>{out} - (x_f^2 + w + 3y_0^2))}\right|$$</p><p>Notice that $\left|\frac{a<em>y}{y</em>{out}}\right| = e_y$! Therefore</p><p>$$e<em>k &gt; e_y\left|\frac{(-3y</em>{out}^2 + 6y<em>0y</em>{out} - (x<em>f^2 + w + 3y_0^2))}{(-y</em>{out}^2 + 3y<em>0y</em>{out} - (x_f^2 + w + 3y_0^2))}\right|$$</p><p>We bound the right hand side, with the assistance of wolfram alpha. Let $a = y_{out}, b = y_0, c = x_f^2 + w$. Then we see from <a href="https://www.wolframalpha.com/input?i=%7C%28-3a%5E2+%2B+6ab+-+%28c+%2B+3b%5E2%29%29+%2F+%28-a%5E2+%2B+3ab+-+%28c+%2B+3b%5E2%29%29+%7C+%3E+.01" target="_blank" rel="noopener noreferrer">wolfram alpha here</a>, that this right hand expression is provably greater than <code>.01</code> if some set of decisions hold. We describe the solution set that satisfies our use case here:</p><ul><li>When $y_{out} &gt; 0$<ul><li>Use solution set: $a &gt; 0, b &gt; \frac{2}{3} a, c &gt; \frac{1}{99} (-299a^2 + 597ab - 297b^2)$<ul><li>$a &gt; 0$ by definition.</li><li>$b &gt; \frac{2}{3} a$, as thats equivalent to $y<em>0 &gt; \frac{2}{3} y</em>{out}$. We already assume that $y<em>0 &gt;= y</em>{out}$.</li><li>Set $y_{out} = .9y_0$, per our theorem assumption. So $b = .9a$. Take $c = x^2 + w = 0$. Then <a href="https://www.wolframalpha.com/input?i=0+%3E+-299a%5E2+%2B+597ab+-+297b%5E2%2C+when+b%3D+.90a" target="_blank" rel="noopener noreferrer">we can show that</a> $(-299a^2 + 597ab - 297b^2) &lt; 0$ for all $a$. This completes the constraint set.</li></ul></li></ul></li><li>When $y_{out} &lt; 0$<ul><li>Use solution set: $a &lt; 0, b &gt; \frac{2}{3} a, c &gt; -a^2 + 3ab - 3b^2$<ul><li>$a &lt; 0$ by definition.</li><li>$b &gt; \frac{2}{3} a$, as $y_0$ is positive.</li><li>$c &gt; 0$ is by definition, so we just need to bound when $-a^2 + 3ab - 3b^2 &lt; 0$. This is always the case as long as one of $a$ or $b$ is non-zero, per <a href="https://www.wolframalpha.com/input?i=-a%5E2+%2B+3ab+-+3b%5E2+%3C+0" target="_blank" rel="noopener noreferrer">here</a>.</li></ul></li></ul></li></ul><p>Tieing this all together, we have that $e_k &gt; .01e_y$. Therefore $e_y &lt; 100 e_k$, satisfying our theoerem!</p><p>To show the informal claims, the constraint that led to this 100x error blowup was trying to accomodate high $y<em>{out}$. When $y</em>{out}$ is smaller, the error is far lower. (Often to the case that $e<em>y &lt; e_k$, you can convince yourself of this by setting the ratio to being greater than 1 in wolfram alpha) When $y</em>{out}$ is bigger than $.9y_0$, we can rely on x_f^2 + w being much larger to lower this error. In these cases, the $x_f$ term must be large relative to $y_0$, which would yield a far better error bound.</p><p>TODO: Justify a_y &lt;&lt; y_out. (This should be easy, assume its not, that leads to e_k being high. Ratio test probably easiest. Maybe just add a sentence to that effect)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spot-price">Spot Price<a class="hash-link" href="#spot-price" title="Direct link to heading">​</a></h3><p>Spot price for an AMM pool is the derivative of its <code>CalculateOutAmountGivenIn</code> equation.
However for the stableswap equation, this is painful: <a href="https://www.wolframalpha.com/input?i=dy%2Fdx+of+y+%3D+%28sqrt%28729+k%5E2+x%5E4+%2B+108+x%5E3+%28w+x+%2B+x%5E3%29%5E3%29+%2B+27+k+x%5E2%29%5E%281%2F3%29%2F%283+2%5E%281%2F3%29+x%29+-+%282%5E%281%2F3%29+%28w+x+%2B+x%5E3%29%29%2F%28sqrt%28729+k%5E2+x%5E4+%2B+108+x%5E3+%28w+x+%2B+x%5E3%29%5E3%29+%2B+27+k+x%5E2%29%5E%281%2F3%29+" target="_blank" rel="noopener noreferrer">wolfram alpha link</a></p><p>So instead we compute the spot price by approximating the derivative via a small swap.</p><p>Let $\epsilon$ be a sentinel very small swap in amount.</p><p>Then $\text{spot price} = \frac{\text{CalculateOutAmountGivenIn}(\epsilon)}{\epsilon}$.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lp-equations">LP equations<a class="hash-link" href="#lp-equations" title="Direct link to heading">​</a></h3><p>We divide this section into two parts, <code>JoinPoolNoSwap &amp; ExitPool</code>, and <code>JoinPool</code>.</p><p>First we recap what are the properties that we&#x27;d expect from <code>JoinPoolNoSwap</code>, <code>ExitPool</code>, and LP shares.
From this, we then derive what we&#x27;d expect for <code>JoinPool</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="joinpoolnoswap-and-exitpool">JoinPoolNoSwap and ExitPool<a class="hash-link" href="#joinpoolnoswap-and-exitpool" title="Direct link to heading">​</a></h4><p>Both of these methods can be implemented via generic AMM techniques.
(Link to them or describe the idea)</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="joinpool">JoinPool<a class="hash-link" href="#joinpool" title="Direct link to heading">​</a></h4><p>The JoinPool API only supports JoinPoolNoSwap if</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="join-pool-single-asset-in">Join pool single asset in<a class="hash-link" href="#join-pool-single-asset-in" title="Direct link to heading">​</a></h4><p>There are a couple ways to define <code>JoinPoolSingleAssetIn</code>. The simplest way is to define it from its intended relation from the CFMM, with Exit pool. We describe this below under the zero swap fee case.</p><p>Let <code>pool_{L, S}</code> represent a pool with liquidity <code>L</code>, and <code>S</code> total LP shares.
If we call <code>pool_{L, S}.JoinPoolSingleAssetIn(tokensIn) -&gt; (N, pool_{L + tokensIn, S + N})</code>, or in others we get out <code>N</code> new LP shares, and a pool with with tokensIn added to liquidity.
It must then be the case that <code>pool_{L+tokensIn, S+N}.ExitPool(N) -&gt; (tokensExited, pool_{L + tokensIn - tokensExited, S})</code>.
Then if we swap all of <code>tokensExited</code> back to tokensIn, under 0 swap fee, we should get back to <code>pool_{L, S}</code> under the CFMM property.</p><p>In other words, if we single asset join pool, and then exit pool, we should return back to the same CFMM <code>k</code> value we started with. Then if we swap back to go entirely back into our input asset, we should have exactly many tokens as we started with, under 0 swap fee.</p><p>We can solve this relation with a binary search over the amount of LP shares to give!</p><p>Thus we are left with how to account swap fee. We currently account for swap fee, by considering the asset ratio in the pool. If post scaling factors, the pool liquidity is say 60:20:20, where 60 is the asset were bringing in, then we consider &quot;only (1 - 60%) = 40%&quot; of the input as getting swapped. So we charge the swap fee on 40% of our single asset join in input. So the pseudocode for this is roughly:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">JoinPoolSingleAssetIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tokenIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  swapFeeApplicableFraction </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">ScaledLiquidityOf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Denom</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SumOfAllScaledLiquidity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  effectiveSwapFee </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">SwapFee </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> swapFeeApplicableFraction</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  effectiveTokenIn </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RoundDown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenIn </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> effectiveSwapFee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> BinarySearchSingleJoinLpShares</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> effectiveTokenIn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We leave the rounding mode for the scaling factor division unspecified.
This is because its expected to be tiny (as the denominator is larger than the numerator, and we are operating in BigDec),
and it should be dominated by the later step of rounding down.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="code-structure">Code structure<a class="hash-link" href="#code-structure" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-strategy">Testing strategy<a class="hash-link" href="#testing-strategy" title="Direct link to heading">​</a></h2><ul><li>Unit tests for every pool interface method</li><li>Msg tests for custom messages<ul><li>CreatePool</li><li>SetScalingFactors</li></ul></li><li>Simulator integrations:<ul><li>Pool creation</li><li>JoinPool + ExitPool gives a token amount out that is lte input</li><li>SingleTokenIn + ExitPool + Swap to base token gives a token amount that is less than input</li><li>CFMM k adjusting in the correct direction after every action</li></ul></li><li>Fuzz test binary search algorithm, to see that it still works correctly across wide scale ranges</li><li>Fuzz test approximate equality of iterative approximation swap algorithm and direct equation swap.</li><li>Flow testing the entire stableswap scaling factor update process</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/osmosis-labs/docs/tree/main/docs/osmosis-core/modules/gamm/pool-models/stableswap/README.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/osmosis-core/modules/gamm/client/docs/create-pool"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Create-pool</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osmosis-core/modules/gov"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Gov</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pool-configuration" class="table-of-contents__link toc-highlight">Pool configuration</a><ul><li><a href="#scaling-factor-handling" class="table-of-contents__link toc-highlight">Scaling factor handling</a></li></ul></li><li><a href="#algorithm-details" class="table-of-contents__link toc-highlight">Algorithm details</a><ul><li><a href="#cfmm-function" class="table-of-contents__link toc-highlight">CFMM function</a></li><li><a href="#swaps" class="table-of-contents__link toc-highlight">Swaps</a></li><li><a href="#spot-price" class="table-of-contents__link toc-highlight">Spot Price</a></li><li><a href="#lp-equations" class="table-of-contents__link toc-highlight">LP equations</a></li></ul></li><li><a href="#code-structure" class="table-of-contents__link toc-highlight">Code structure</a></li><li><a href="#testing-strategy" class="table-of-contents__link toc-highlight">Testing strategy</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="margin-bottom--sm"><a class="footerLogoLink_DDai" href="/"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="36px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="36px"></a></div><div class="footer__row"><div class="footer__data"><div class="footer__cta"></div></div><div class="links"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Launch App</a></li><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Portal</a></li><li class="footer__item"><a href="https://osmosis.zone/ecosystem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ecosystem</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://medium.com/@Osmosis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://commonwealth.im/osmosis/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community</a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Osmosis Labs since 2023. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.143ea17f.js"></script>
<script src="/assets/js/main.f0ea6666.js"></script>
</body>
</html>
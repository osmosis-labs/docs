<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-osmosis-core docs-doc-id-modules/superfluid/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Superfluid Staking | Osmosis Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" name="twitter:image" content="https://docs.osmosis.zone/img/osmosis-docs-card.png"><meta data-rh="true" property="og:url" content="https://docs.osmosis.zone/osmosis-core/modules/superfluid"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-osmosis-core-current"><meta data-rh="true" property="og:title" content="Superfluid Staking | Osmosis Docs"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.osmosis.zone/osmosis-core/modules/superfluid"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/superfluid" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.osmosis.zone/osmosis-core/modules/superfluid" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://O18C1RUI3F-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Osmosis Docs" href="/opensearch.xml">









<link rel="preconnect" href="https://app.posthog.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,a){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==a?g=e[a]=[]:a="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)c(g,o[p]);e._i.push([r,s,a])},e.__SV=1)}(document,window.posthog||[]),posthog.init("00",{api_host:"https://app.posthog.com"})</script>

<script src="https://tally.so/widgets/embed.js"></script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="c5b5e9fc-d025-4c12-b08e-9784d0e2161f" data-project-name="Osmosis" data-project-color="#7900B4" data-project-logo="https://app.osmosis.zone/tokens/osmo.svg" async></script><link rel="stylesheet" href="/assets/css/styles.792232e5.css">
<link rel="preload" href="/assets/js/runtime~main.e6c983dc.js" as="script">
<link rel="preload" href="/assets/js/main.8b3b5676.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA" height="26px" width="114px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU" height="26px" width="114px"></div></a><a class="navbar__item navbar__link" href="/overview/educate">Overview</a><a class="navbar__item navbar__link" href="/overview/integrate">Integrate</a><a class="navbar__item navbar__link" href="/overview/validate">Validate &amp; Run your Node</a><a class="navbar__item navbar__link" href="/overview/endpoints">Endpoints</a><a class="navbar__item navbar__link" href="/overview/features">Features</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/osmosis-core">Develop</a><a href="https://github.com/osmosis-labs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon github-icon"></a><a href="https://discord.com/invite/osmosis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link pseudo-icon discord-icon"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link dev-portal-signup dev-portal-link">Launch Dex<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_mhZE"><div class="multiSectionContainer_bYm7"><div class="section_olD1 sectionActive_D9yk" tabindex="0"><div>Osmosis Core</div><div><div class="row_KvCx"><button type="button" role="combobox" aria-controls="" aria-expanded="false" aria-autocomplete="none" aria-label="Select Section" class="sections-menu-trigger"><span style="pointer-events:none"></span><span aria-hidden="true"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" class="sections-menu-scrollButton"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg></span></button><select aria-hidden="true" tabindex="-1" style="position:absolute;border:0;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;word-wrap:normal"></select></div></div></div><div class="section_olD1" tabindex="0"><div>CosmWasm</div><div><p class="description_C5q3">Building and interacting with Smart contracts on Osmosis.</p></div></div><div class="section_olD1" tabindex="0"><div>Frontend &amp; SDKs</div><div><p class="description_C5q3">Libraries &amp; UI components to build on top of Osmosis.</p></div></div></div><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/build">Build and Test</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/localtesting">Local Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/osmosisd">Osmosis CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ide-guide">IDE Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/osmosis-core/category/modules">Modules</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modules&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/concentrated-liquidity">Concentrated Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/cosmwasmpool">CosmWasm Pool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/downtime-detector">Downtime-detector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/epochs">Epochs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/osmosis-core/modules/gamm">GAMM</a><button aria-label="Toggle the collapsible sidebar category &#x27;GAMM&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/gov">Gov</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-hooks">IBC-hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/ibc-rate-limit">IBC Rate Limit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/incentives">Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/lockup">Lockup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/mint">Mint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-incentives">Pool Incentives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/pool-manager">Pool Manager Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/protorev">Osmosis modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osmosis-core/modules/superfluid">Superfluid Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/tokenfactory">Token Factory</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/twap">TWAP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/txfees">Txfees</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osmosis-core/modules/valpref-module">validator-set Preference</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/asset-info">Asset Info</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/keys-management">Keys Management</a><button aria-label="Toggle the collapsible sidebar category &#x27;Keys Management&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/relayer">Relayer</a><button aria-label="Toggle the collapsible sidebar category &#x27;Relayer&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/osmosis-core/ibc">IBC Protocol</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/osmosis-core/category/guides">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Superfluid Staking</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstract">Abstract<a class="hash-link" href="#abstract" title="Direct link to heading">​</a></h2><p>Superfluid Staking provides the consensus layer more security with a
sort of &quot;Proof of Useful Stake&quot;. Each person gets an amount of Osmo
representative of the value of their share of liquidity pool tokens
staked and delegated to validators, resulting in the security guarantee
of the consensus layer to also be based on GAMM LP shares. The OSMO
token is minted and burned in the context of Superfluid Staking.
Throughout all of this, OSMO&#x27;s supply is preserved in queries to the
bank module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-process">The process<a class="hash-link" href="#the-process" title="Direct link to heading">​</a></h3><p>All of the below methods are found under the <a href="https://github.com/osmosis-labs/osmosis/tree/main/x/superfluid" target="_blank" rel="noopener noreferrer">Superfluid
modules</a>.</p><ul><li>The <code>SuperfluidDelegate</code> method stores your share of bonded
liquidity pool tokens, with <code>validateLock</code> as a verifier for lockup
time.</li><li><code>GetSuperfluidOsmo</code> mints OSMO tokens each day for delegation as a
representative of the value of your pool share. This amount is
minted because the staking module at the moment requires staked
tokens to be in OSMO. This amount is burned each day and re-minted
to keep the representative amount of the value of your pool share
accurate. The lockup duration is guaranteed from the underlying
lockup module.</li><li><code>GetExpectedDelegationAmount</code> iterates over each (denom, delegate)
pair and checks for how much OSMO we have delegated. The difference
from the current balance to what is expected is burned / minted to
match with the expected.</li><li>A <code>messageServer</code> method executes the Superfluid delegate message.</li><li><code>syntheticLockup</code> is used to index bond holders and tracking their
addresses for reward distribution or potentially slashing purposes.
These track whether if your Superfluid stake is currently bonding or
unbonding.</li><li>An <code>IntermediaryAccount</code> is mostly used for the actual reward
distribution or slashing events, and are responsible for
establishing the connection between each superfluid staked lock and
their delegation to the validator. These work by transferring the
superfluid OSMO to their respective delegators. Rewards are linearly
scaled based on how much you have locked for a given (validator,
denom) pair. Rewards are first moved to the incentive gauges, then
distributed from the gauges. In this way, we&#x27;re using the existing
gauge reward system for paying out superfluid staking rewards and
tracking the amount you have superfluidly staked using the lockup
module.</li><li>Rewards are distributed per epoch, which is currently a day.
<code>abci.go</code> checks whether or not the current block is at the
beginning of the epoch using <code>BeginBlock</code>.</li><li>Superfluid staking will continue to expand to other Osmosis pools
based on governance proposals and vote turnouts.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a class="hash-link" href="#example" title="Direct link to heading">​</a></h3><p>If Alice has 500 GAMM tokens bonded to the ATOM \&lt;<!-- -->&gt;<!-- --> OSMO, she will have
the equivalent value of OSMO minted, delegated to her chosen staker, and
burned for her each day with Superfluid staking. On the user side, all
she has to know is who she wants to delegate her tokens to. In order to
switch delegation, she has to unbond her tokens from the pool first and
then redeposit. Bob, who has a share of the same liquidity pool before
Superfluid Staking went live, also has to re-deposit into the pool for
the above process to kickstart.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-mint-osmo-how-is-this-method-safe-and-accurate">Why mint Osmo? How is this method safe and accurate?<a class="hash-link" href="#why-mint-osmo-how-is-this-method-safe-and-accurate" title="Direct link to heading">​</a></h3><p>Superfluid staking requires the minting of OSMO because in order to
stake on the Osmosis chain, OSMO tokens are required as the chosen
collateral. Synthetic Osmo is minted here as a representative of the
value of each superfluid staker&#x27;s liquidity pool tokens.</p><p>The pool tokens are acquired by the user from normally staking in a
liquidity pool. They get minted an amount of OSMO equivalent to the
value of their GAMM pool tokens. This method is accurate because
querying the value OSMO every day allows for burning and minting
according to the difference in value of OSMO relative to the expected
delegation amount (as seen with
<a href="https://github.com/osmosis-labs/osmosis/blob/main/x/superfluid/keeper/stake.go" target="_blank" rel="noopener noreferrer">GetExpectedDelegationAmount</a>).
It&#x27;s like having a price oracle for fairly calculating the amount the
user has superfluidly staked.</p><p>On epoch (start of every day), we read from the lockup module how much
GAMM tokens we have locked which acts as an oracle for the
representative price of the GAMM token shares. The superfluid module has
&quot;hooks&quot; messages to refresh delegation amounts
(<code>RefreshIntermediaryDelegationAmounts</code>) and to increase delegation on
lockup (<code>IncreaseSuperfluidDelegation</code>). Then, we see whether or not the
superfluid OSMO currently delegated is worth more or less than this
expected delegation amount. If the OSMO is worth more, we do
instant undelegations and immediately burn the OSMO. If less, we mint
OSMO and update the amount delegated. A simplified diagram of this whole
process is found below:</p><img loading="lazy" src="https://raw.githubusercontent.com/osmosis-labs/osmosis/main/x/superfluid/superfluiddiagram.png" height="300" class="img_ev3q"><p>This minting is safe because we strict constrain the permissions of Bank
(the module that burns and mints OSMO) to do what it&#x27;s designed to do.
The authority is mediated through <code>mintOsmoTokensAndDelegate</code> and
<code>forceUndelegateAndBurnOsmoTokens</code> keeper methods called by the
<code>SuperfluidDelegate</code> and <code>SuperfluidUndelegate</code> message handlers for the
tokens. The hooks above that increase delegation and refresh delegation
amounts also call this keeper method.</p><p>The delegation is then verified to not already be associated with an
intermediary account (to prevent double-staking), and is always
delegated or withdrawn taking into account various multipliers for
synthetic OSMO value (its worth with respect to the liquidity pool, and
a risk modifier) to prevent mint inaccuracies. Before minting, we also
check that the message sender is the owner of the locked funds; that the
lock is not unlocking; is locked for at least the unbonding period, and
is bonded to a single asset. We also check to see if the lock isn&#x27;t
already in superfluid and that the same lock isn&#x27;t currently being
unbonded.</p><p>On the end of each epoch, we iterate through all intermediary accounts
to withdraw delegation rewards they may have received and put it all
into the perpetual gauges corresponding to each account for reward
delegation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bonding-unbonding-slashing">Bonding, unbonding, slashing<a class="hash-link" href="#bonding-unbonding-slashing" title="Direct link to heading">​</a></h3><p>Here, we describe how token bonding and unbonding works, and what
happens to your superfluid tokens in the case of a slashing event.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bonding">Bonding<a class="hash-link" href="#bonding" title="Direct link to heading">​</a></h3><p>When bonding, your input tokens are locked up and you are given GAMM
pool tokens in exchange. These GAMM pool tokens represent a share of the
total liquidity pool, and allows you to get transaction fees or
participate in external incentive gauge token distributions. When
bonding, on top of the regular bonding transaction there will also be a
selection of validators. As stated above, OSMO is also minted and burned
each day and superfluidly staked to whoever you have chosen to be your
validator. You gain additional APR as a reward for bolstering the
Osmosis chain&#x27;s consensus integrity by delegating.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unbonding">Unbonding<a class="hash-link" href="#unbonding" title="Direct link to heading">​</a></h3><p>When unbonding, superfluid tokens get un-delegated. After making sure
that the unbond message sender is the owner of their corresponding
locked funds, the existing synthetic lockup is deleted and replaced with
a new synthetic lockup for unbonding purposes. The undelegated OSMO is
then instantly withdrawn from the intermediate account and validator
using the InstantUndelegate function. The OSMO that was originally used
for representing your LP shares are burnt. Moves the tracker for
unbonding, allows the underlying lock to start unlocking if desired</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="concepts">Concepts<a class="hash-link" href="#concepts" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="syntheticlockups">SyntheticLockups<a class="hash-link" href="#syntheticlockups" title="Direct link to heading">​</a></h3><p>SyntheticLockups are synthetic forms of PeriodLocks, but different in the
sense that they store suffix, which is a combination of
bonding/unbonding status + validator address. This is mainly used to
track whether an individual lock that has been superfluid staked has an
bonding status or an unbonding status from the staking delegations.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="intermediary-account">Intermediary Account<a class="hash-link" href="#intermediary-account" title="Direct link to heading">​</a></h3><p>Intermediary Accounts establish the connections between the superfluid
staked locks and delegations to the validator. Intermediary accounts
exist for every denom + validator combination, so that it would group
locks with the same denom + validator selection. Superfluid staking a
lock would mint equivalent amount of OSMO of the lock and send it to the
intermediary account and the intermediary accounts would be delegating
to the specified validator.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="intermediary-account-connection">Intermediary Account Connection<a class="hash-link" href="#intermediary-account-connection" title="Direct link to heading">​</a></h3><p>Intermediary Accounts Connection serves the role of tracking the locks
that an Intermediary Account is dedicated to.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state">State<a class="hash-link" href="#state" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-asset">Superfluid Asset<a class="hash-link" href="#superfluid-asset" title="Direct link to heading">​</a></h3><p>A superfluid asset is an alternative asset (non-OSMO) that is allowed by
governance to be used for staking.</p><p>It can only be updated by governance proposals. We validate at proposal
creation time that the denom + pool exists. (Are we going to ignore edge
cases around a reference pool getting deleted it)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="intermediary-accounts">Intermediary Accounts<a class="hash-link" href="#intermediary-accounts" title="Direct link to heading">​</a></h3><p>Lots of questions to be answered here</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dedicated-gauges">Dedicated Gauges<a class="hash-link" href="#dedicated-gauges" title="Direct link to heading">​</a></h3><p>Each intermediary account has a dedicated gauge where it sends the
delegation rewards to. Gauges are distributing the rewards to end users
at the end of the epoch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="synthetic-lockups-created">Synthetic Lockups created<a class="hash-link" href="#synthetic-lockups-created" title="Direct link to heading">​</a></h3><p>At the moment, one lock can only be fully bonded to one validator.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="osmo-equivalent-multipliers">Osmo Equivalent Multipliers<a class="hash-link" href="#osmo-equivalent-multipliers" title="Direct link to heading">​</a></h3><p>The Osmo Equivalent Multiplier for an asset is the multiplier it has for
its value relative to OSMO.</p><p>Different types of assets can have different functions for calculating
their multiplier. We currently support two asset types.</p><ol><li>Native Token</li></ol><p>The multiplier for OSMO is always 1.</p><ol start="2"><li>Gamm LP Shares</li></ol><p>Currently we use the spot price for an asset based on a designated
osmo-basepair pool of an asset. The multiplier is set once per epoch, at
the beginning of the epoch. In the future, we will switch this out to
use a TWAP instead.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-changes">State changes<a class="hash-link" href="#state-changes" title="Direct link to heading">​</a></h3><p>The state of superfluid module state modifiers are classified into below
categories.</p><ul><li><a href="#proposals">Proposals</a></li><li><a href="#messages">Messages</a></li><li><a href="#epochs">Epoch</a></li><li><a href="#superfluid-hooks">Hooks</a></li></ul><h1>Messages</h1><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-delegate">Superfluid Delegate<a class="hash-link" href="#superfluid-delegate" title="Direct link to heading">​</a></h3><p>Owners of superfluid asset locks can submit <code>MsgSuperfluidDelegate</code>
transactions to delegate the Osmo in their locks to a selected
validator.</p><div class="language-{.go} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.go} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">type MsgSuperfluidDelegate struct {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender  string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LockId  uint64</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> ValAddr string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>State Modifications:</strong></p><ul><li>Safety Checks that are being done before running superfluid logic:<ul><li>Check that <code>Sender</code> is the owner of <code>lock</code></li><li>Check that <code>lock</code> corresponds to a single locked asset</li><li>Check that <code>lock</code> is not unlocking</li><li>Check that <code>lock</code> is locked for at least the unbonding period</li><li>Check that this <code>LockID</code> is not already superfluided</li><li>Check that the same lock isn&#x27;t being unbonded</li></ul></li><li>Get the <code>IntermediaryAccount</code> for this lock&#x27;s <code>Denom</code> and <code>ValAddr</code>
pair.<ul><li>Create it + a new gauge for the synthetic denom, if it does not
yet exist.</li></ul></li><li>Create a SyntheticLockup.</li><li>Calculate <code>Osmo</code> to delegate on behalf of this <code>lock</code>, as
<code>Osmo Equivalent Multiplier</code> <!-- -->*<!-- --> <code># LP Shares</code> <!-- -->*<code>Risk Adjustment Factor</code><ul><li>If this amount is less than 0.000001 <code>Osmo</code> (<code>1 uosmo</code>) reject
the transaction, as it would be delegating <code>0 uosmo</code></li></ul></li><li>Mint <code>Osmo</code> to match this amount and send to <code>IntermediaryAccount</code></li><li>Create a delegation from <code>IntermediaryAccount</code> to <code>Validator</code></li><li>Create a new perpetual <code>Gauge</code> for distributing staking payouts to
locks of a synethic asset based on this <code>Validator</code> / <code>Denom</code> pair.</li><li>Create a connection between this <code>lockID</code> and this
<code>IntermediaryAccount</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-undelegate">Superfluid Undelegate<a class="hash-link" href="#superfluid-undelegate" title="Direct link to heading">​</a></h3><div class="language-{.go} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.go} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">type MsgSuperfluidUndelegate struct {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LockId uint64</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>State Modifications:</strong></p><ul><li>Lookup <code>lock</code> by <code>LockID</code></li><li>Check that <code>Sender</code> is the owner of <code>lock</code></li><li>Get the <code>IntermediaryAccount</code> for this <code>lockID</code></li><li>Delete the <code>SyntheticLockup</code> associated to this <code>lockID</code> + <code>ValAddr</code>
pair</li><li>Create a new <code>SyntheticLockup</code> which is unbonding</li><li>Calculate the amount of <code>Osmo</code> delegated on behalf of this <code>lock</code> as
<code>Osmo Equivalent Multiplier</code> <!-- -->*<!-- --> <code># LP Shares</code> <!-- -->*<code>Risk Adjustment Factor</code><ul><li>If this amount is less than 0.000001 <code>Osmo</code>, there is no
delegated <code>Osmo</code> to undelegate and burn</li></ul></li><li>Use <code>InstantUndelegate</code> to instantly remove delegation from
<code>IntermediaryAccount</code> to <code>Validator</code></li><li>Immediately burn undelegated <code>Osmo</code></li><li>Delete the connection between <code>lockID</code> and <code>IntermediaryAccount</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lock-and-superfluid-delegate">Lock and Superfluid Delegate<a class="hash-link" href="#lock-and-superfluid-delegate" title="Direct link to heading">​</a></h3><div class="language-{.go} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.go} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">type MsgLockAndSuperfluidDelegate struct {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Coins sdk.Coins</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> ValAddr string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is effectively a multimsg tx of lockup&#x27;s <code>MsgLockTokens</code> and
superfluid&#x27;s <code>MsgSuperfluidDelegate</code>, but it is implemented as a single
msg, because currently we don&#x27;t have a way of passing the lockid
outputted by <code>MsgLockTokens</code> as an input into the
<code>MsgSuperfluidDelegate</code> prior to execution.</p><p><strong>State Modifications:</strong></p><ul><li>Ensures that Coins has a length of only 1 (we use sdk.Coins instead
of sdk.Coin in order to allow more flexibility in the future)</li><li>Creates a lockup with Coins of a lock duration equivalent to the
unstaking period from the staking module<ul><li>Uses the lockup module&#x27;s MsgServer</li></ul></li><li>Gets the lock id of the created lock, and uses it generate and
execute a MsgSuperfluidDelegate message<ul><li>Uses the SuperfluidDelegate function on this msg server</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-unbond-lock">Superfluid Unbond Lock<a class="hash-link" href="#superfluid-unbond-lock" title="Direct link to heading">​</a></h3><div class="language-{.go} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.go} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">type MsgSuperfluidUnbondLock struct {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> Sender string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> LockId uint64</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This message does all the functionality of <code>MsgSuperfluidUndelegate</code> but
also starts unbonding the underlying lock as well, allowing both the
unstaking and unlocking to complete at the same time. Without using this
function, a user will not be able to start unbonding their underlying
lock until after the unstaking has finished.</p><p><strong>State Modifications:</strong></p><ul><li>This runs the functionality of <code>MsgSuperfluidUndelegate</code></li><li>It then triggers a force unbond of the underlying lock id</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="epochs">Epochs<a class="hash-link" href="#epochs" title="Direct link to heading">​</a></h2><p>Overall Epoch sequence</p><ul><li>Epoch N ends, during AfterEpochEnd:<ul><li>Distribute gauge rewards for all non-superfluid gauges</li><li>Mint new tokens<ul><li>Issue new Osmo, and send to various modules (distribution,
incentives, etc.)</li><li>25% currently goes to <code>x/distribution</code> which funds <code>Staking</code>
and <code>Superfluid</code> rewards</li><li>Rewards for <code>Superfluid</code> are based on the just updated
delegation amounts, and queued for payout in the next epoch</li></ul></li></ul></li><li>BeginBlock for Distribution<ul><li>Distribute staking rewards to all of the &#x27;lazy accounting&#x27;
accumulators. (F1)</li></ul></li><li>Epoch N ends, during BeginBlock for superfluid <strong>After</strong>
AfterEpochEnd:<ul><li>Claim staking rewards for every <code>Intermediary Account</code>, put them
into gauges.</li><li>Distribute Superfluid staking rewards from gauges to bonded
Synthetic Lock owners</li><li>Update <code>Osmo Equivalent Multiplier</code> value for each LP token<ul><li>(Currently spot price at epoch)</li></ul></li><li>Refresh delegation amounts for all <code>Intermediary Accounts</code><ul><li>Calculate the expected delegation for this account as
<code>Osmo Equivalent Multiplier</code> <em><code># LP Shares</code></em><code>Risk adjustment</code><ul><li>If this is less than 0.000001 <code>Osmo</code> it will be rounded
to 0</li></ul></li><li>Lookup current delegation amount for <code>Intermediary Account</code><ul><li>If there is no delegation, treat the current delegation
as 0</li></ul></li><li>If expected amount <!-- -->&gt;<!-- --> current delegation:<ul><li>Mint new <code>Osmo</code> and <code>Delegate</code> to <code>Validator</code></li></ul></li><li>If expected amount \&lt; current delegation:<ul><li>Use <code>InstantUndelegate</code> and burn the received <code>Osmo</code></li></ul></li></ul></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="staking-power-updates">Staking power updates<a class="hash-link" href="#staking-power-updates" title="Direct link to heading">​</a></h2><p>We need to be concerned with how/when validators enter and leave the
active set.</p><p>We expect the guarantee that there is an Intermediary account for every
(active validator, superfluid denom) pair, and every (unbonding
validator, superfluid denom) pair. (TODO: Where/why)</p><p>We also want to avoid resource exhaustion attacks. We relegate concerns
around upper-bounding the number of active + unbonding validators to the
staking module. This module is liable to potentially cause a 100-1000x
amplification factor on this workload.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-we-handle-it-now">How we handle it now<a class="hash-link" href="#how-we-handle-it-now" title="Direct link to heading">​</a></h3><ul><li>Intermediary accounts are not created on SetSuperfluidAsset</li><li>They are created at-time-of-need on MsgSuperfluidDelegate</li><li>Concerns: What happens if you delegate to an unbonding or jailed
validator. Note: Isn&#x27;t it same as normal delegation for unbonding
validator?</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-module-hooks">Other Module Hooks<a class="hash-link" href="#other-module-hooks" title="Direct link to heading">​</a></h2><p>-----;</p><p>In this section we describe the &quot;hooks&quot; that <code>superfluid</code> module
receives from other modules.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afterepochend">AfterEpochEnd<a class="hash-link" href="#afterepochend" title="Direct link to heading">​</a></h3><p>On AfterEpochEnd, we iterate through all existing intermediary accounts
and withdraw delegation rewards they have received. Then we send the
collective rewards to the perpetual gauge corresponding to the
intermediary account. Then we update OSMO backing per share for the
specific pool. After the update, iteration through all intermediate
accounts happen, undelegating and bonding existing delegations for all
superfluid staking and use the updated spot price at epoch time to mint
and delegate.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="afteraddtokenstolock">AfterAddTokensToLock<a class="hash-link" href="#afteraddtokenstolock" title="Direct link to heading">​</a></h3><p>When a token is locked, we first check if the corresponding lock is
currently in the state of superfluid delegation. If it is, we run the
logic to add delegation via intermediary account.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="beforevalidatorslashed">BeforeValidatorSlashed<a class="hash-link" href="#beforevalidatorslashed" title="Direct link to heading">​</a></h3><p>Slashes the synthetic lockups and native lockups that is connected to
the to be slashed validator.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proposal-hooks">Proposal Hooks<a class="hash-link" href="#proposal-hooks" title="Direct link to heading">​</a></h2><p>-----;</p><p>In this section we describe the proposals that is associated to
superfluid module.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setsuperfluidassetsproposal">SetSuperfluidAssetsProposal<a class="hash-link" href="#setsuperfluidassetsproposal" title="Direct link to heading">​</a></h3><p>Enable multiple superfluid assets to be used for superfluid staking.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="removesuperfluidassetsproposal">RemoveSuperfluidAssetsProposal<a class="hash-link" href="#removesuperfluidassetsproposal" title="Direct link to heading">​</a></h3><p>Disable multiple assets from being used for superfluid staking.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="events">Events<a class="hash-link" href="#events" title="Direct link to heading">​</a></h2><p>There are 7 types of events that exist in Superfluid module:</p><ul><li><code>types.TypeEvtSetSuperfluidAsset</code> - &quot;set_superfluid_asset&quot;</li><li><code>types.TypeEvtRemoveSuperfluidAsset</code> - &quot;remove_superfluid_asset&quot;</li><li><code>types.TypeEvtSuperfluidDelegate</code> - &quot;superfluid_delegate&quot;</li><li><code>types.TypeEvtSuperfluidIncreaseDelegation</code> - &quot;superfluid_increase_delegation&quot;</li><li><code>types.TypeEvtSuperfluidUndelegate</code> - &quot;superfluid_undelegate&quot;</li><li><code>types.TypeEvtSuperfluidUnbondLock</code> - &quot;superfluid_unbond_lock&quot;</li><li><code>types.TypeEvtUnpoolId</code> - &quot;unpool_pool_id&quot;</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtsetsuperfluidasset"><code>types.TypeEvtSetSuperfluidAsset</code><a class="hash-link" href="#typestypeevtsetsuperfluidasset" title="Direct link to heading">​</a></h3><p>This event is emitted in the proposal which set new superfluid asset</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeDenom</code><ul><li>The value is the asset denom.</li></ul></li><li><code>types.AttributeSuperfluidAssetType</code><ul><li>The value is the type of asset.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtremovesuperfluidasset"><code>types.TypeEvtRemoveSuperfluidAsset</code><a class="hash-link" href="#typestypeevtremovesuperfluidasset" title="Direct link to heading">​</a></h3><p>This event is emitted in the proposal which removes the superfluid asset</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeDenom</code><ul><li>The value is the asset denom.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtsuperfluiddelegate"><code>types.TypeEvtSuperfluidDelegate</code><a class="hash-link" href="#typestypeevtsuperfluiddelegate" title="Direct link to heading">​</a></h3><p>This event is emitted in the message server after successfully creating a delegation for the given lock ID and the validator to delegate to.</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeLockId</code><ul><li>The value is the given lock ID.</li></ul></li><li><code>types.AttributeValidator</code><ul><li>The value is the validator address to delegate to.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtsuperfluidincreasedelegation"><code>types.TypeEvtSuperfluidIncreaseDelegation</code><a class="hash-link" href="#typestypeevtsuperfluidincreasedelegation" title="Direct link to heading">​</a></h3><p>This event is emitted in the hook after adding more token to the existing lock</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeLockId</code><ul><li>The value is the given lock ID.</li></ul></li><li><code>types.AttributeAmount</code><ul><li>The value is the token amount added to the lock.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtsuperfluidundelegate"><code>types.TypeEvtSuperfluidUndelegate</code><a class="hash-link" href="#typestypeevtsuperfluidundelegate" title="Direct link to heading">​</a></h3><p>This event is emitted in the message server after undelegating the currently superfluid delegated position given by lock ID.</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeLockId</code><ul><li>The value is the given lock ID.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtsuperfluidunbondlock"><code>types.TypeEvtSuperfluidUnbondLock</code><a class="hash-link" href="#typestypeevtsuperfluidunbondlock" title="Direct link to heading">​</a></h3><p>This event is emitted in the message server after starting unbonding for the currently superfluid undelegating lock.</p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeLockId</code><ul><li>The value is the given lock ID.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typestypeevtunpoolid"><code>types.TypeEvtUnpoolId</code><a class="hash-link" href="#typestypeevtunpoolid" title="Direct link to heading">​</a></h3><p>This event is emitted in the message server <code>UnPoolWhitelistedPool</code></p><p>It consists of the following attributes:</p><ul><li><code>types.AttributeKeySender</code><ul><li>The value is the msg sender address.</li></ul></li><li><code>types.AttributeLockId</code><ul><li>The value is the pool lpShareDenom.</li></ul></li><li><code>types.AttributeNewLockIds</code><ul><li>The value is the exited lock ids in byte[].</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="messages-1">Messages<a class="hash-link" href="#messages-1" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgsuperfluiddelegate">MsgSuperfluidDelegate<a class="hash-link" href="#msgsuperfluiddelegate" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>superfluid_delegate</td><td>lock_id</td><td>{lock_id}</td></tr><tr><td>superfluid_delegate</td><td>validator</td><td>{validator}</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgsuperfluidundelegate">MsgSuperfluidUndelegate<a class="hash-link" href="#msgsuperfluidundelegate" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>superfluid_undelegate</td><td>lock_id</td><td>{lock_id}</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msgsuperfluidunbondlock">MsgSuperfluidUnbondLock<a class="hash-link" href="#msgsuperfluidunbondlock" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>superfluid_unbond_lock</td><td>lock_id</td><td>{lock_id}</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="msglockandsuperfluiddelegate">MsgLockAndSuperfluidDelegate<a class="hash-link" href="#msglockandsuperfluiddelegate" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>lock_tokens</td><td>period_lock_id</td><td>{periodLockID}</td></tr><tr><td>lock_tokens</td><td>owner</td><td>{owner}</td></tr><tr><td>lock_tokens</td><td>amount</td><td>{amount}</td></tr><tr><td>lock_tokens</td><td>duration</td><td>{duration}</td></tr><tr><td>lock_tokens</td><td>unlock_time</td><td>{unlockTime}</td></tr><tr><td>message</td><td>action</td><td>lock_tokens</td></tr><tr><td>message</td><td>sender</td><td>{owner}</td></tr><tr><td>transfer</td><td>recipient</td><td>{moduleAccount}</td></tr><tr><td>transfer</td><td>sender</td><td>{owner}</td></tr><tr><td>transfer</td><td>amount</td><td>{amount}</td></tr><tr><td>superfluid_delegate</td><td>lock_id</td><td>{lock_id}</td></tr><tr><td>superfluid_delegate</td><td>validator</td><td>{validator}</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="proposals">Proposals<a class="hash-link" href="#proposals" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setsuperfluidassetsproposal-1">SetSuperfluidAssetsProposal<a class="hash-link" href="#setsuperfluidassetsproposal-1" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>set_superfluid_asset</td><td>denom</td><td>{denom}</td></tr><tr><td>set_superfluid_asset</td><td>superfluid_asset_type</td><td>{asset_type}</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="removesuperfluidassetsproposal-1">RemoveSuperfluidAssetsProposal<a class="hash-link" href="#removesuperfluidassetsproposal-1" title="Direct link to heading">​</a></h3><table><thead><tr><th>Type</th><th>Attribute Key</th><th>Attribute Value</th></tr></thead><tbody><tr><td>remove_superfluid_asset</td><td>denom</td><td>{denom}</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="queries">Queries<a class="hash-link" href="#queries" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="params">Params<a class="hash-link" href="#params" title="Direct link to heading">​</a></h3><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message ParamsRequest {};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message ParamsResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  // params defines the parameters of the module.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Params params = 1 [ (gogoproto.nullable) = false ];</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message Params {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  sdk.Dec minimum_risk_factor = 1; // serialized as string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The params query returns the params for the superfluid module. This
currently contains:</p><ul><li><code>MinimumRiskFactor</code> which is an sdk.Dec that represents the discount
to apply to all superfluid staked modules when calculating their
staking power. For example, if a specific denom has an OSMO
equivalent value of 100 OSMO, but the <code>MinimumRiskFactor</code> param
is 0.05, then the denom will only get 95 OSMO worth of staking power
when staked.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="assettype">AssetType<a class="hash-link" href="#assettype" title="Direct link to heading">​</a></h3><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AssetTypeRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    string denom = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AssetTypeResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    SuperfluidAssetType asset_type = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">enum SuperfluidAssetType {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  SuperfluidAssetTypeNative = 0;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  SuperfluidAssetTypeLPShare = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The AssetType query returns what type of superfluid asset a denom is.
AssetTypes are meant for when we support more types of assets for
superfluid staking than just LP shares. Each AssetType has a different
algorithm used to get its &quot;Osmo equivalent value&quot;.</p><p>We represent different types of superfluid assets as different enums.
Currently, only enum <code>1</code> is actually used. Enum value <code>0</code> is reserved
for the Native staking token for if we deprecate the legacy staking
workflow to have native staking also go through the superfluid module.
In the future, more enums will be added.</p><p>If this query errors, that means that a denom is not allowed to be used
for superfluid staking.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="allassets">AllAssets<a class="hash-link" href="#allassets" title="Direct link to heading">​</a></h3><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AllAssetsRequest {};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AllAssetsResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated SuperfluidAsset assets = 1 [ (gogoproto.nullable) = false ];</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidAsset {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  SuperfluidAssetType asset_type = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This parameterless query returns a list of all the superfluid staking
compatible assets. The return value includes a list of SuperfluidAssets,
which are pairs of <code>denom</code> with <code>SuperfluidAssetType</code> which was
described in the previous section.</p><p>This query does not currently support pagination, but may in the future.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="assetmultiplier">AssetMultiplier<a class="hash-link" href="#assetmultiplier" title="Direct link to heading">​</a></h3><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AssetMultiplierRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    string denom = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AssetMultiplierResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  OsmoEquivalentMultiplierRecord osmo_equivalent_multiplier = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message OsmoEquivalentMultiplierRecord {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  int64 epoch_number = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string multiplier = 3;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query allows you to find the multiplier factor on a specific denom.
The Osmo-Equivalent-Multiplier Record for epoch N refers to the osmo
worth we treat a denom as having, for all of epoch N. For now, this is
the spot price at the last epoch boundary, and this is reset every
epoch. We currently don&#x27;t store historical multipliers, so the epoch
parameter is kind of meaningless for now.</p><p>To calculate the staking power of the denom, one needs to multiply the
amount of the denom with <code>OsmoEquivalentMultipler</code> from this query with
the <code>MinimumRiskFactor</code> from the Params query endpoint.</p><p><code>staking_power = amount * OsmoEquivalentMultipler * MinimumRiskFactor</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connectedintermediaryaccount">ConnectedIntermediaryAccount<a class="hash-link" href="#connectedintermediaryaccount" title="Direct link to heading">​</a></h3><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message ConnectedIntermediaryAccountRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  uint64 lock_id = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message ConnectedIntermediaryAccountResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  SuperfluidIntermediaryAccountInfo account = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidIntermediaryAccount {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string val_addr = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  uint64 gauge_id = 3; // perpetual gauge for rewards distribution</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Every superfluid denom and validator pair has an associated
&quot;intermediary account&quot;, which does the actual delegation. This query
helps find the superfluid intermediary account for any superfluid
position.</p><p>That <code>lock_id</code> parameter passed in is the underlying lock id for the
superfluid, NOT the synthetic lock id.</p><p>This query can be used to find the validator a superfluid lock is
delegated to. The <code>gauge_id</code> also refers to the perpetual gauge that is
used to pay out the superfluid positions associated with this
intermediary account.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="allintermediaryaccounts">AllIntermediaryAccounts<a class="hash-link" href="#allintermediaryaccounts" title="Direct link to heading">​</a></h3><div class="language-{.protobuf} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.protobuf} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AllIntermediaryAccountsRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  cosmos.base.query.v1beta1.PageRequest pagination = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message AllIntermediaryAccountsResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated SuperfluidIntermediaryAccountInfo accounts = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  cosmos.base.query.v1beta1.PageResponse pagination = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query returns a list of all superfluid intermediary accounts. It
supports pagination.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluiddelegationamount">SuperfluidDelegationAmount<a class="hash-link" href="#superfluiddelegationamount" title="Direct link to heading">​</a></h3><div class="language-{.protobuf} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.protobuf} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationAmountRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string delegator_address = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string validator_address = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 3;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationAmountResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated cosmos.base.v1beta1.Coin amount = 1 [];</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query returns the amount of underlying denom (i.e. lp share) for a
triplet of delegator, validator, and denom.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluiddelegationsbydelegator">SuperfluidDelegationsByDelegator<a class="hash-link" href="#superfluiddelegationsbydelegator" title="Direct link to heading">​</a></h3><div class="language-{.protobuf} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.protobuf} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationsByDelegatorRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string delegator_address = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationsByDelegatorResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated SuperfluidDelegationRecord superfluid_delegation_records = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated cosmos.base.v1beta1.Coin total_delegated_coins = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationRecord {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string delegator_address = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string validator_address = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  cosmos.base.v1beta1.Coin delegation_amount = 3;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query returns a list of all the superfluid delegations of a
specific delegator. The return value includes, the validator delegated to
and the delegated coins (both denom and amount).</p><p>The return value of the query also includes the <code>total_delegated_coins</code>
which is the sum of all the delegations of that validator.</p><p>This query does require iteration that is linear with the number of
delegations a delegator has made, but for now until we support many
superfluid denoms, should be relatively bounded. Once that increases, we
will need to support pagination.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluiddelegationsbyvalidatordenom">SuperfluidDelegationsByValidatorDenom<a class="hash-link" href="#superfluiddelegationsbyvalidatordenom" title="Direct link to heading">​</a></h3><div class="language-{.protobuf} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.protobuf} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationsByValidatorDenomRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string validator_address = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message SuperfluidDelegationsByValidatorDenomResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated SuperfluidDelegationRecord superfluid_delegation_records = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query returns a list of all superfluid delegations that are with a
validator / superfluid denom pair. This query requires a lot of
iteration and should be used sparingly. We will need to add pagination
to make this usable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="estimatesuperfluiddelegatedamountbyvalidatordenom">EstimateSuperfluidDelegatedAmountByValidatorDenom<a class="hash-link" href="#estimatesuperfluiddelegatedamountbyvalidatordenom" title="Direct link to heading">​</a></h3><div class="language-{.protobuf} codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{.protobuf} codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">message EstimateSuperfluidDelegatedAmountByValidatorDenomRequest {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string validator_address = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  string denom = 2;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message EstimateSuperfluidDelegatedAmountByValidatorDenomResponse {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  repeated cosmos.base.v1beta1.Coin total_delegated_coins = 1;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This query returns the total amount of delegated coins for a validator /
superfluid denom pair. This query does NOT involve iteration, so should
be used instead of the above <code>SuperfluidDelegationsByValidatorDenom</code>
whenever possible. It is called an &quot;Estimate&quot; because it can have some
slight rounding errors, due to conversions between sdk.Dec and
sdk.Int\&quot;, but for the most part it should be very close to the sum of
the results of the previous query.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parameters">Parameters<a class="hash-link" href="#parameters" title="Direct link to heading">​</a></h2><p>The superfluid module contains the following parameters:</p><table><thead><tr><th>Key</th><th>Type</th><th>Example</th></tr></thead><tbody><tr><td>minimum_risk_factor</td><td>decimal</td><td>0.01</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="slashing">Slashing<a class="hash-link" href="#slashing" title="Direct link to heading">​</a></h2><p>Slashing works by gathering all accounts who were superfluidly staking
and delegated to the violating validator and slashing their underlying
lock collateral. The amount of tokens to slash are first calculated then
removed from the underlying and synthetic lock. Therefore, it is
important to select a reputable or reliable validator as to minimize
slashing risks on your tokens. At the moment we are slashing at latest
price rather than block height price. All slashed tokens go to the
community pool.</p><p>We first get a hook from the staking module, marking that a validator is
about to be slashed at a slashFactor of <code>f</code>, for an infraction at height
<code>h</code>.</p><p>The staking module handles slashing every delegation to that validator,
which will handle slashing the delegation from every intermediary
account. However, it is up to the superfluid module to then:</p><ul><li>Slash every constituent superfluid staking position for this
validator.</li><li>Slash every unbonding superfluid staking position to this validator.</li></ul><p>We do this by:</p><ul><li>Collect all intermediate accounts to this validator</li><li>For each IA, iterate over every lock to the underlying native denom.</li><li>If the lock has a synthetic lockup, it gets slashed.</li><li>The slash works by calculating the amount of tokens to slash.</li><li>It removes these from the underlying lock and the synthetic lock.</li><li>These coins are moved to the community pool.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nuances">Nuances<a class="hash-link" href="#nuances" title="Direct link to heading">​</a></h3><ul><li>Slashed tokens go to the community pool, rather than being burned as
in staking.</li><li>We slash every unbonding, rather than just unbondings that started
after the infraction height.</li><li>We can &quot;overslash&quot; relative to the staking module. (For a slash
factor of 5%, the staking module can often burn \&lt;5% of active
delegation, but superfluid will always slash 5%)</li></ul><p>We slash every unbonding, purely because lockup module tracks things by
unbonding start time, whereas staking/slashing tracks things by height
we begin unbonding at. Thus we get a problem that we cannot convert
between these cleanly. Really there should be a storage of all
historical block height \&lt;<!-- -->&gt;<!-- --> block times for everything in the unbonding
period, but this is not considered a near-term problem.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="correcting-overslashing">Correcting overslashing<a class="hash-link" href="#correcting-overslashing" title="Direct link to heading">​</a></h3><p>The overslashing possibility stems from a problem in the SDKs slashing
module, that really is a bug there, and superfluid is doing the correct
thing. <a href="https://github.com/cosmos/cosmos-sdk/issues/1440" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/issues/1440</a></p><p>Basically, slashes to unbondings and redelegations can lower the amount
that gets slashed from live delegations in the staking module today.</p><p>It turns out this edge case, where superfluid&#x27;s intermediate account can
have more delegation than expected from its underlying collateral, is
already safely handled by the Superfluid refreshing logic.</p><p>The refreshing logic checks the total amount of tokens in locks to this
denom (Reading from the lockup accumulation store), calculates how many
osmo that&#x27;s worth at the epochs new osmo worth for that asset, and then
uses that. Thus this safely handles this edge case, as it uses the new
&#x27;live&#x27; lockup amount.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="minting">Minting<a class="hash-link" href="#minting" title="Direct link to heading">​</a></h2><p>Superfluid module has the ability to arbitrarily mint and burn Osmo
through the <code>bank</code> module. This is potentially dangerous so we strictly
constrain it&#x27;s ability to do so. This authority is mediated through the
<code>mintOsmoTokensAndDelegate</code> and <code>forceUndelegateAndBurnOsmoTokens</code>
keeper methods, which are in turn called by message handlers
(<code>SuperfluidDelegate</code> and <code>SuperfluidUndelegate</code>) as well as by hooks on
Epoch (<code>RefreshIntermediaryDelegationAmounts</code>) and Lockup
(<code>IncreaseSuperfluidDelegation</code>)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="invariant">Invariant<a class="hash-link" href="#invariant" title="Direct link to heading">​</a></h3><p>Each of these mechanisms maintains a local invariant between the amount
of Osmo minted and delegated by the <code>IntermediaryAccount</code>, and the
quantity of the underlying asset held by locks associated to the
account, modified by <code>OsmoEquivalentMultiplier</code> and <code>RiskAdjustment</code> for
the underlying asset. Namely that total minted/delegated =
<code>GetTotalSyntheticAssetsLocked</code> <!-- -->*<!-- --> <code>GetOsmoEquivalentMultiplier</code> <!-- -->*<!-- -->
<code>GetRiskAdjustment</code></p><p>This can be equivalently expressed as <code>GetExpectedDelegationAmount</code>
being equal to the actual delegation amount.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="message-handlers">Message Handlers<a class="hash-link" href="#message-handlers" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluiddelegate">SuperfluidDelegate<a class="hash-link" href="#superfluiddelegate" title="Direct link to heading">​</a></h3><p>In a <code>SuperfluidDelegate</code> transaction, we first verify that this lock is
not already associated to an <code>IntermediaryAccount</code>, and then use
<code>mintOsmoTokenAndDelegate</code> to properly balance the resulting change in
<code>GetExpectedDelegationAmount</code> from the increase in
<code>GetTotalSyntheticAssetsLocked</code>. i.e. we mint and delegate:
<code>GetOsmoEquivalentMultiplier</code> <!-- -->*<!-- --> <code>GetRiskAdjustment</code> <!-- -->*<!-- -->
<code>lock.Coins.Amount</code> new Osmo tokens.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="superfluidundelegate">SuperfluidUndelegate<a class="hash-link" href="#superfluidundelegate" title="Direct link to heading">​</a></h3><p>When a user submits a transaction to unlock their asset the invariant is
maintained by using <code>forceUndelegateAndBurnOsmoTokens</code> to remove an
amount of Osmo equal to <code>lockedCoin.Amount</code> <!-- -->*<!-- -->
<code>GetOsmoEquivalentMultiplier</code> <!-- -->*<!-- --> <code>GetRiskAdjustment</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="superfluid-hooks">Superfluid Hooks<a class="hash-link" href="#superfluid-hooks" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="refreshintermediarydelegationamounts-afterepochend-hook">RefreshIntermediaryDelegationAmounts (AfterEpochEnd Hook)<a class="hash-link" href="#refreshintermediarydelegationamounts-afterepochend-hook" title="Direct link to heading">​</a></h3><p>In the <code>RefreshIntermediaryDelegationAmounts</code> method, calls are made to
<code>mintOsmoTokensAndDelegate</code> or <code>forceUndelegateAndBurnOsmoTokens</code> to
adjust the real delegation up or down to match
<code>GetExpectedDelegationAmount</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="increasesuperfluiddelegation-afteraddtokenstolock-hook">IncreaseSuperfluidDelegation (AfterAddTokensToLock Hook)<a class="hash-link" href="#increasesuperfluiddelegation-afteraddtokenstolock-hook" title="Direct link to heading">​</a></h3><p>This is called as a result of a user adding more assets to a lock that
has already been associated to an <code>IntermediaryAccount</code>. The invariant
is maintained by using <code>mintOsmoTokenAndDelegate</code> to match the amount of
new asset locked <!-- -->*<!-- --> <code>GetOsmoEquivalentMultiplier</code> <!-- -->*<!-- --> <code>GetRiskAdjustment</code>
for the underlying asset.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="slashlockupsforvalidatorslash-beforevalidatorslashed-hook">SlashLockupsForValidatorSlash (BeforeValidatorSlashed Hook)<a class="hash-link" href="#slashlockupsforvalidatorslash-beforevalidatorslashed-hook" title="Direct link to heading">​</a></h3><p>During slashing the invariant is likely to be temporarily broken if the
referenced validator has any unbonding delegations. These unbonding
delegations are slashed first, which means that the amount delegated by
the <code>IntermediaryAccount</code> will be slashed by less than the
<code>SyntheticLock</code>s held by the account.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="see-also">See Also<a class="hash-link" href="#see-also" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gettotalsyntheticassetslocked">GetTotalSyntheticAssetsLocked<a class="hash-link" href="#gettotalsyntheticassetslocked" title="Direct link to heading">​</a></h3><p>TODO - expand on this Uses <code>lockup</code> accumulator to find total amount of
synthetic locks for a given <code>IntermediaryAccount</code> (Superfluid Asset +
Validator pair)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/osmosis-labs/docs/tree/main/docs/osmosis-core/modules/superfluid/README.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/osmosis-core/modules/protorev"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Osmosis modules</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osmosis-core/modules/tokenfactory"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Token Factory</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a><ul><li><a href="#the-process" class="table-of-contents__link toc-highlight">The process</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#why-mint-osmo-how-is-this-method-safe-and-accurate" class="table-of-contents__link toc-highlight">Why mint Osmo? How is this method safe and accurate?</a></li><li><a href="#bonding-unbonding-slashing" class="table-of-contents__link toc-highlight">Bonding, unbonding, slashing</a></li><li><a href="#bonding" class="table-of-contents__link toc-highlight">Bonding</a></li><li><a href="#unbonding" class="table-of-contents__link toc-highlight">Unbonding</a></li></ul></li><li><a href="#concepts" class="table-of-contents__link toc-highlight">Concepts</a><ul><li><a href="#syntheticlockups" class="table-of-contents__link toc-highlight">SyntheticLockups</a></li><li><a href="#intermediary-account" class="table-of-contents__link toc-highlight">Intermediary Account</a></li><li><a href="#intermediary-account-connection" class="table-of-contents__link toc-highlight">Intermediary Account Connection</a></li></ul></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a><ul><li><a href="#superfluid-asset" class="table-of-contents__link toc-highlight">Superfluid Asset</a></li><li><a href="#intermediary-accounts" class="table-of-contents__link toc-highlight">Intermediary Accounts</a></li><li><a href="#dedicated-gauges" class="table-of-contents__link toc-highlight">Dedicated Gauges</a></li><li><a href="#synthetic-lockups-created" class="table-of-contents__link toc-highlight">Synthetic Lockups created</a></li><li><a href="#osmo-equivalent-multipliers" class="table-of-contents__link toc-highlight">Osmo Equivalent Multipliers</a></li><li><a href="#state-changes" class="table-of-contents__link toc-highlight">State changes</a></li><li><a href="#superfluid-delegate" class="table-of-contents__link toc-highlight">Superfluid Delegate</a></li><li><a href="#superfluid-undelegate" class="table-of-contents__link toc-highlight">Superfluid Undelegate</a></li><li><a href="#lock-and-superfluid-delegate" class="table-of-contents__link toc-highlight">Lock and Superfluid Delegate</a></li><li><a href="#superfluid-unbond-lock" class="table-of-contents__link toc-highlight">Superfluid Unbond Lock</a></li></ul></li><li><a href="#epochs" class="table-of-contents__link toc-highlight">Epochs</a></li><li><a href="#staking-power-updates" class="table-of-contents__link toc-highlight">Staking power updates</a><ul><li><a href="#how-we-handle-it-now" class="table-of-contents__link toc-highlight">How we handle it now</a></li></ul></li><li><a href="#other-module-hooks" class="table-of-contents__link toc-highlight">Other Module Hooks</a><ul><li><a href="#afterepochend" class="table-of-contents__link toc-highlight">AfterEpochEnd</a></li><li><a href="#afteraddtokenstolock" class="table-of-contents__link toc-highlight">AfterAddTokensToLock</a></li><li><a href="#beforevalidatorslashed" class="table-of-contents__link toc-highlight">BeforeValidatorSlashed</a></li></ul></li><li><a href="#proposal-hooks" class="table-of-contents__link toc-highlight">Proposal Hooks</a><ul><li><a href="#setsuperfluidassetsproposal" class="table-of-contents__link toc-highlight">SetSuperfluidAssetsProposal</a></li><li><a href="#removesuperfluidassetsproposal" class="table-of-contents__link toc-highlight">RemoveSuperfluidAssetsProposal</a></li></ul></li><li><a href="#events" class="table-of-contents__link toc-highlight">Events</a><ul><li><a href="#typestypeevtsetsuperfluidasset" class="table-of-contents__link toc-highlight"><code>types.TypeEvtSetSuperfluidAsset</code></a></li><li><a href="#typestypeevtremovesuperfluidasset" class="table-of-contents__link toc-highlight"><code>types.TypeEvtRemoveSuperfluidAsset</code></a></li><li><a href="#typestypeevtsuperfluiddelegate" class="table-of-contents__link toc-highlight"><code>types.TypeEvtSuperfluidDelegate</code></a></li><li><a href="#typestypeevtsuperfluidincreasedelegation" class="table-of-contents__link toc-highlight"><code>types.TypeEvtSuperfluidIncreaseDelegation</code></a></li><li><a href="#typestypeevtsuperfluidundelegate" class="table-of-contents__link toc-highlight"><code>types.TypeEvtSuperfluidUndelegate</code></a></li><li><a href="#typestypeevtsuperfluidunbondlock" class="table-of-contents__link toc-highlight"><code>types.TypeEvtSuperfluidUnbondLock</code></a></li><li><a href="#typestypeevtunpoolid" class="table-of-contents__link toc-highlight"><code>types.TypeEvtUnpoolId</code></a></li><li><a href="#messages-1" class="table-of-contents__link toc-highlight">Messages</a></li><li><a href="#msgsuperfluiddelegate" class="table-of-contents__link toc-highlight">MsgSuperfluidDelegate</a></li><li><a href="#msgsuperfluidundelegate" class="table-of-contents__link toc-highlight">MsgSuperfluidUndelegate</a></li><li><a href="#msgsuperfluidunbondlock" class="table-of-contents__link toc-highlight">MsgSuperfluidUnbondLock</a></li><li><a href="#msglockandsuperfluiddelegate" class="table-of-contents__link toc-highlight">MsgLockAndSuperfluidDelegate</a></li></ul></li><li><a href="#proposals" class="table-of-contents__link toc-highlight">Proposals</a><ul><li><a href="#setsuperfluidassetsproposal-1" class="table-of-contents__link toc-highlight">SetSuperfluidAssetsProposal</a></li><li><a href="#removesuperfluidassetsproposal-1" class="table-of-contents__link toc-highlight">RemoveSuperfluidAssetsProposal</a></li></ul></li><li><a href="#queries" class="table-of-contents__link toc-highlight">Queries</a><ul><li><a href="#params" class="table-of-contents__link toc-highlight">Params</a></li><li><a href="#assettype" class="table-of-contents__link toc-highlight">AssetType</a></li><li><a href="#allassets" class="table-of-contents__link toc-highlight">AllAssets</a></li><li><a href="#assetmultiplier" class="table-of-contents__link toc-highlight">AssetMultiplier</a></li><li><a href="#connectedintermediaryaccount" class="table-of-contents__link toc-highlight">ConnectedIntermediaryAccount</a></li><li><a href="#allintermediaryaccounts" class="table-of-contents__link toc-highlight">AllIntermediaryAccounts</a></li><li><a href="#superfluiddelegationamount" class="table-of-contents__link toc-highlight">SuperfluidDelegationAmount</a></li><li><a href="#superfluiddelegationsbydelegator" class="table-of-contents__link toc-highlight">SuperfluidDelegationsByDelegator</a></li><li><a href="#superfluiddelegationsbyvalidatordenom" class="table-of-contents__link toc-highlight">SuperfluidDelegationsByValidatorDenom</a></li><li><a href="#estimatesuperfluiddelegatedamountbyvalidatordenom" class="table-of-contents__link toc-highlight">EstimateSuperfluidDelegatedAmountByValidatorDenom</a></li></ul></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li><li><a href="#slashing" class="table-of-contents__link toc-highlight">Slashing</a><ul><li><a href="#nuances" class="table-of-contents__link toc-highlight">Nuances</a></li><li><a href="#correcting-overslashing" class="table-of-contents__link toc-highlight">Correcting overslashing</a></li></ul></li><li><a href="#minting" class="table-of-contents__link toc-highlight">Minting</a><ul><li><a href="#invariant" class="table-of-contents__link toc-highlight">Invariant</a></li></ul></li><li><a href="#message-handlers" class="table-of-contents__link toc-highlight">Message Handlers</a><ul><li><a href="#superfluiddelegate" class="table-of-contents__link toc-highlight">SuperfluidDelegate</a></li><li><a href="#superfluidundelegate" class="table-of-contents__link toc-highlight">SuperfluidUndelegate</a></li></ul></li><li><a href="#superfluid-hooks" class="table-of-contents__link toc-highlight">Superfluid Hooks</a><ul><li><a href="#refreshintermediarydelegationamounts-afterepochend-hook" class="table-of-contents__link toc-highlight">RefreshIntermediaryDelegationAmounts (AfterEpochEnd Hook)</a></li><li><a href="#increasesuperfluiddelegation-afteraddtokenstolock-hook" class="table-of-contents__link toc-highlight">IncreaseSuperfluidDelegation (AfterAddTokensToLock Hook)</a></li><li><a href="#slashlockupsforvalidatorslash-beforevalidatorslashed-hook" class="table-of-contents__link toc-highlight">SlashLockupsForValidatorSlash (BeforeValidatorSlashed Hook)</a></li></ul></li><li><a href="#see-also" class="table-of-contents__link toc-highlight">See Also</a><ul><li><a href="#gettotalsyntheticassetslocked" class="table-of-contents__link toc-highlight">GetTotalSyntheticAssetsLocked</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="margin-bottom--sm"><a class="footerLogoLink_DDai" href="/"><img src="/logo/light.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="36px"><img src="/logo/dark.svg" alt="Osmosis Docs" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="36px"></a></div><div class="footer__row"><div class="footer__data"><div class="footer__cta"></div></div><div class="links"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://app.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Launch App</a></li><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Portal</a></li><li class="footer__item"><a href="https://osmosis.zone/ecosystem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Ecosystem</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.osmosis.zone" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation</a></li><li class="footer__item"><a href="https://medium.com/@Osmosis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium</a></li><li class="footer__item"><a href="https://commonwealth.im/osmosis/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community</a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Osmosis Labs since 2023. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e6c983dc.js"></script>
<script src="/assets/js/main.8b3b5676.js"></script>
</body>
</html>